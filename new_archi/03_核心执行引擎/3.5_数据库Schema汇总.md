# 3.5 数据库 Schema 汇总 (PostgreSQL Schema Reference)

> **文档类型：** 架构文档 · 核心执行引擎篇
> **版本：** v1.0 · 2026-02-26
> **上游依赖：** [3.3 幂等状态机 FSM](./3.3_幂等状态机FSM.md) · [4.1 双分录会计系统](../04_财务与结算/4.1_双分录会计系统.md)
> **下游文档：** [4.1 双分录会计系统](../04_财务与结算/4.1_双分录会计系统.md)
>
> **文档目的：** 本文档是所有 PostgreSQL 表结构的**统一参考**（Single Source of Truth）。
> 各模块文档在涉及数据库时引用本文档的对应章节，不在各自文档中重复定义 Schema。
>
> **来源文档：**
> - `模块_3_幂等状态机__FSM_.md` §3.3（trade_tasks、nonce_locks）
> - `模块_4_财务会计与数据水位线.md` §4.4（accounts、asset_balances、ledger_entries、unclaimed_rewards）

---

## 1. 设计原则

**金额字段全部使用 `NUMERIC(78, 0)`：** 支持 256 位整数精度，与 EVM 的 uint256 对齐，杜绝浮点数精度丢失。所有金额以链上原始整数（Wei）存储，显示层按需除以精度位。

**时间字段全部使用 `TIMESTAMP WITH TIME ZONE`：** 避免时区混乱。应用层统一使用 UTC。

**UUID 作为主键：** 分布式生成，不依赖数据库自增序列，支持未来分库分表。

---

## 2. 执行引擎核心表（§3.x 相关）

### 2.1 `trade_tasks` — 交易任务表

FSM 的物理载体，每笔交易对应一行，状态变更与此表事务原子提交。

```sql
-- FSM 状态枚举（与 common.proto TradeStatus 严格对应）
CREATE TYPE trade_status AS ENUM (
    'INIT',             -- 任务创建，分配 internal_tx_id
    'SIMULATED',        -- 通过 EVM 仿真与不变性断言
    'PENDING_APPROVAL', -- 触发大额审批，等待管理员确认
    'SIGNED',           -- 完成 MPC 分片签名，Nonce 已绑定
    'BROADCASTED',      -- 已推送至 Mempool 或 Flashbots
    'CONFIRMED',        -- 链上达到安全确认数
    'REVERTED',         -- 链上 EVM 执行失败
    'FAILED'            -- 系统内部拦截（熔断、白名单拒绝等）
);

CREATE TABLE trade_tasks (
    -- ── 标识字段 ──────────────────────────────────────────────────────
    internal_tx_id  UUID         PRIMARY KEY DEFAULT gen_random_uuid(),
    trace_id        UUID         NOT NULL,             -- 全链路追踪 ID，关联日志系统
    agent_id        VARCHAR(64)  NOT NULL,             -- 发起决策的 Python Agent ID

    -- ── 链上定位 ──────────────────────────────────────────────────────
    chain_id        INTEGER      NOT NULL,
    from_address    CHAR(42)     NOT NULL,             -- 发送方地址（校验和格式）
    to_address      CHAR(42)     NOT NULL,             -- 目标合约地址（白名单校验依据）
    nonce           BIGINT,                            -- MPC 签名时绑定，严禁重用

    -- ── 状态机 ────────────────────────────────────────────────────────
    status          trade_status NOT NULL DEFAULT 'INIT',

    -- ── 交易数据 ──────────────────────────────────────────────────────
    protocol_id     VARCHAR(100) NOT NULL,             -- 目标协议，如 "UNISWAP_V3_ETH"
    raw_payload     JSONB        NOT NULL,             -- 原始 TradeRequest 参数（用于 Recovery）
    signed_payload  BYTEA,                            -- MPC 签名后的完整交易字节（SIGNED 后填充）
    tx_hash         CHAR(66)     UNIQUE,               -- 链上交易哈希（BROADCASTED 后填充）

    -- ── 仿真结果 ──────────────────────────────────────────────────────
    estimated_value_usd  NUMERIC(20, 6),              -- 仿真估算的交易价值（USDC）
    estimated_gas        BIGINT,                      -- 仿真估算的 Gas 消耗
    gas_price_wei        NUMERIC(78, 0),              -- 使用的 Gas 价格（Wei）
    gas_cost_usd         NUMERIC(20, 6),              -- Gas 成本（USDC，CONFIRMED 后填充）

    -- ── 水位线 ────────────────────────────────────────────────────────
    sync_block           BIGINT       NOT NULL,        -- 决策时 Agent 的水位线（来自 Context）
    confirmed_block      BIGINT,                      -- 链上确认时的区块高度
    confirmed_block_hash CHAR(66),                    -- 确认区块哈希（链重组检测用）

    -- ── 时间 ──────────────────────────────────────────────────────────
    created_at      TIMESTAMPTZ  NOT NULL DEFAULT NOW(),
    updated_at      TIMESTAMPTZ  NOT NULL DEFAULT NOW(),

    -- ── 约束 ──────────────────────────────────────────────────────────
    -- 同一地址 + 链 + Nonce 组合唯一（防止 Nonce 冲突）
    CONSTRAINT uq_nonce_per_account UNIQUE (from_address, chain_id, nonce)
);

-- 查询索引
CREATE INDEX idx_tt_status       ON trade_tasks(status) WHERE status NOT IN ('CONFIRMED', 'FAILED', 'REVERTED');
CREATE INDEX idx_tt_trace        ON trade_tasks(trace_id);
CREATE INDEX idx_tt_agent        ON trade_tasks(agent_id, created_at DESC);
CREATE INDEX idx_tt_tx_hash      ON trade_tasks(tx_hash) WHERE tx_hash IS NOT NULL;
CREATE INDEX idx_tt_updated_at   ON trade_tasks(updated_at) WHERE status = 'BROADCASTED';

COMMENT ON TABLE  trade_tasks IS '[Writer: FSM, Reader: Recovery Manager / Auditor] FSM 核心状态表，每笔交易对应一行，状态变更必须与此表事务原子提交';
COMMENT ON COLUMN trade_tasks.signed_payload IS '已签名交易字节，用于崩溃恢复时重广播，严禁重新签名';
COMMENT ON COLUMN trade_tasks.confirmed_block_hash IS '用于链重组检测，若当前链上此块高的哈希不匹配则触发回滚';
```

### 2.2 `nonce_locks` — 分布式 Nonce 锁表

基于 PostgreSQL 行级锁实现分布式 Nonce 管理，保证高并发下同一地址的 Nonce 严格串行分配。

```sql
CREATE TABLE nonce_locks (
    address     CHAR(42)     NOT NULL,
    chain_id    INTEGER      NOT NULL,
    next_nonce  BIGINT       NOT NULL DEFAULT 0,  -- 下一个可用的 Nonce
    locked_at   TIMESTAMPTZ,                      -- 最近一次锁定时间（用于死锁检测）
    PRIMARY KEY (address, chain_id)
);

COMMENT ON TABLE  nonce_locks IS '[Writer: FSM, Reader: None] 分布式 Nonce 锁，通过 SELECT FOR UPDATE 实现串行分配';
COMMENT ON COLUMN nonce_locks.next_nonce IS '每次 SIGNED 阶段原子递增，Recovery 时不得回退此值';
```

---

## 3. 财务与会计表（§4.x 相关）

### 3.1 `accounts` — 账户表

区分策略账户、协议账户（如 Uniswap 池）、Gas 费用账户，是双分录会计的账户主体。

```sql
CREATE TABLE accounts (
    account_id   UUID         PRIMARY KEY DEFAULT gen_random_uuid(),
    name         VARCHAR(64)  NOT NULL,
    account_type VARCHAR(20)  NOT NULL CHECK (account_type IN ('STRATEGY', 'PROTOCOL', 'GAS', 'TRANSIT')),
                                                -- TRANSIT：跨链在途资金专用账户科目
    address      CHAR(42)     NOT NULL,         -- 链上地址
    chain_id     INTEGER      NOT NULL,
    canonical_token_id VARCHAR(100),            -- 关联 §2.3 代币注册表（NULL 表示多币种账户）
    created_at   TIMESTAMPTZ  NOT NULL DEFAULT NOW(),
    UNIQUE (address, chain_id, account_type)
);

COMMENT ON COLUMN accounts.account_type IS 'TRANSIT 账户用于跨链在途资金的借贷平衡，见 §2.3';
```

### 3.2 `asset_balances` — 资产余额表

基于水位线的实时余额快照，与链上状态误差 ≤ 1 Wei。

```sql
CREATE TABLE asset_balances (
    account_id          UUID         NOT NULL REFERENCES accounts(account_id),
    canonical_token_id  VARCHAR(100) NOT NULL,   -- 统一代币标识，见 §2.3
    chain_id            INTEGER      NOT NULL,
    raw_balance         NUMERIC(78, 0) NOT NULL DEFAULT 0,  -- 链上原始整数（Wei）
    last_updated_block  BIGINT       NOT NULL,              -- 余额数据的水位线
    last_updated_at     TIMESTAMPTZ  NOT NULL DEFAULT NOW(),
    PRIMARY KEY (account_id, canonical_token_id, chain_id)
);

CREATE INDEX idx_ab_account ON asset_balances(account_id);
CREATE INDEX idx_ab_stale   ON asset_balances(last_updated_block);  -- 用于水位线检查

COMMENT ON COLUMN asset_balances.last_updated_block IS '余额水位线，落后 balance_stale_blocks 触发重同步（见 README §0.6）';
```

### 3.3 `ledger_entries` — 复式记账凭证表

每笔资产变动同时生成借方和贷方分录，账本平衡误差 ≤ 1 Wei。

```sql
CREATE TABLE ledger_entries (
    entry_id          UUID         PRIMARY KEY DEFAULT gen_random_uuid(),
    internal_tx_id    UUID         NOT NULL REFERENCES trade_tasks(internal_tx_id),
    trace_id          UUID         NOT NULL,         -- 全链路追踪 ID
    debit_account_id  UUID         NOT NULL REFERENCES accounts(account_id),
    credit_account_id UUID         NOT NULL REFERENCES accounts(account_id),
    canonical_token_id VARCHAR(100) NOT NULL,
    amount            NUMERIC(78, 0) NOT NULL,       -- 借贷金额（Wei，必须 > 0）
    amount_usd        NUMERIC(20, 6),                -- 记账时的 USDC 估值（快照，非实时）
    entry_type        VARCHAR(20)  NOT NULL CHECK (entry_type IN (
                          'TRADE',       -- 正常交易（Swap/流动性操作）
                          'GAS_FEE',     -- Gas 费用分录
                          'REWARD',      -- 协议奖励领取
                          'TRANSIT_OUT', -- 跨链转出
                          'TRANSIT_IN',  -- 跨链到账
                          'REORG_VOID'   -- 链重组撤销分录
                      )),
    created_at        TIMESTAMPTZ  NOT NULL DEFAULT NOW(),
    -- 借贷账户不得相同（防止自循环分录）
    CONSTRAINT chk_different_accounts CHECK (debit_account_id != credit_account_id),
    -- 金额必须为正数
    CONSTRAINT chk_positive_amount CHECK (amount > 0)
);

CREATE INDEX idx_le_internal_tx ON ledger_entries(internal_tx_id);
CREATE INDEX idx_le_trace       ON ledger_entries(trace_id);
CREATE INDEX idx_le_type_time   ON ledger_entries(entry_type, created_at DESC);

COMMENT ON TABLE ledger_entries IS '[Writer: Accounting / Saga Monitor, Reader: MtM Calculator] 复式记账凭证表，每笔资产变动必须同时生成借贷两条分录，金额相等';
```

### 3.4 `unclaimed_rewards` — 未领取奖励表

跟踪各协议内积累但尚未领取的奖励代币，防止未领取资产被漏算导致净值低估。

```sql
CREATE TABLE unclaimed_rewards (
    strategy_id        UUID         NOT NULL,
    protocol_id        VARCHAR(100) NOT NULL,       -- 如 "AAVE_V3_ETH"
    canonical_token_id VARCHAR(100) NOT NULL,
    chain_id           INTEGER      NOT NULL,
    raw_amount         NUMERIC(78, 0) NOT NULL,     -- 未领取数量（Wei）
    amount_usd         NUMERIC(20, 6),              -- 当前 USDC 估值
    last_sync_block    BIGINT       NOT NULL,        -- 奖励数据的水位线
    updated_at         TIMESTAMPTZ  NOT NULL DEFAULT NOW(),
    PRIMARY KEY (strategy_id, protocol_id, canonical_token_id, chain_id)
);

COMMENT ON TABLE unclaimed_rewards IS '定时任务（5–10 分钟）更新，纳入净值计算防止风控误杀';
```

### 3.5 `mtm_snapshots` — 公允价值估值快照表

记录每次 Mark-to-Market 估值，供 AI 反馈飞轮（§6.4）和管理员仪表盘使用。

```sql
CREATE TABLE mtm_snapshots (
    snapshot_id        UUID         PRIMARY KEY DEFAULT gen_random_uuid(),
    strategy_id        UUID         NOT NULL,
    anchor_eth_block   BIGINT       NOT NULL,        -- ETH 锚点区块（见 §2.3）
    nav_usd            NUMERIC(20, 6) NOT NULL,      -- U 本位净资产（Net Asset Value）
    drawdown_bps       INTEGER,                      -- 相对峰值的回撤（万分位）
    realized_pnl_usd   NUMERIC(20, 6),              -- 累计已实现盈亏
    unrealized_pnl_usd NUMERIC(20, 6),              -- 当前未实现盈亏（持仓 MtM）
    gas_cost_usd       NUMERIC(20, 6),              -- 区间内累计 Gas 成本
    created_at         TIMESTAMPTZ  NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_mtm_strategy_block ON mtm_snapshots(strategy_id, anchor_eth_block DESC);
```

---

## 4. 多链数据表（§2.3 相关）

> 完整定义在 §2.3，此处仅列出与执行引擎存在外键关联的表名。

| 表名 | 关联关系 | 用途 |
|---|---|---|
| `canonical_token_registry` | `asset_balances.canonical_token_id` 外键 | 统一代币标识注册表 |
| `token_chain_address` | 协议适配器地址解析 | 本地地址 → canonical_id 映射 |
| `chain_block_mapping` | `asset_balances.last_updated_block` 参考 | 跨链区块高度锚点映射 |
| `cross_chain_transit` | `ledger_entries.entry_type = 'TRANSIT_OUT/IN'` 关联 | 跨链在途资金追踪 |

---

## 5. 表依赖关系图

```
canonical_token_registry
         │
         ├──────────────────────┐
         ▼                      ▼
  asset_balances          ledger_entries
  (account_id FK)         (debit/credit_account_id FK)
         │                      │
         ▼                      │
     accounts ◄─────────────────┘
         │
         └──── accounts.account_type = 'TRANSIT'
                      │
                      └──── cross_chain_transit（§2.3）

trade_tasks (internal_tx_id PK)
    │
    ├──── nonce_locks（Nonce 分配关联）
    │
    └──── ledger_entries（CONFIRMED 后触发写入）
                │
                └──── mtm_snapshots（估值快照）

unclaimed_rewards（独立，定时任务维护）
```

---

## 6. 数据库运维规范

### 6.1 连接池配置建议

```
# PostgreSQL 连接池建议配置（基于 50+ Agent 并发场景）
max_connections          = 200
max_open_conns_per_host  = 50   # Go-Execution-Engine 实例
max_idle_conns           = 10
conn_max_lifetime        = 5m
```

### 6.2 关键查询的索引说明

| 查询场景 | 使用索引 | 说明 |
|---|---|---|
| Recovery Manager 扫描未完成任务 | `idx_tt_status` | 部分索引，仅覆盖非终态行 |
| 通过 trace_id 全链路查询 | `idx_tt_trace` | 支持跨系统日志关联 |
| 通过 tx_hash 查询链上状态 | `idx_tt_tx_hash` | 部分索引，仅覆盖已广播行 |
| 余额水位线健康检查 | `idx_ab_stale` | 定期扫描过期余额数据 |
| PnL 历史查询（AI 飞轮） | `idx_mtm_strategy_block` | 按策略 + 区块倒序，覆盖最常见查询模式 |

### 6.3 备份与迁移策略

- **备份频率：** 每日全量快照（pg_dump），保留最近 30 份
- **WAL 归档：** 启用 WAL 流复制，支持 PITR（Point-in-Time Recovery）
- **Schema 迁移：** 使用 `golang-migrate` 管理版本，禁止直接在生产库手动 DDL
- **只追加原则：** 禁止 `DROP COLUMN` 或 `ALTER TYPE`（破坏性变更），只允许添加新字段（设置 DEFAULT 值）

---

*上一篇：[3.4 MEV 路由与防夹执行](./3.4_MEV路由与防夹执行.md) | 下一篇：[4.1 双分录会计系统](../04_财务与结算/4.1_双分录会计系统.md)*
