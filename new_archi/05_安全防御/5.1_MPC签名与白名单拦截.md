# 5.1 MPC 签名与白名单拦截 (MPC Signing & Whitelist Enforcement)

> **文档类型：** 架构文档 · 安全防御篇
> **版本：** v1.0 · 2026-02-26
> **上游依赖：** [3.3 幂等状态机 FSM](../03_核心执行引擎/3.3_幂等状态机FSM.md) · [1.1 三区网络拓扑](../01_部署架构/1.1_三区网络拓扑.md)
> **下游文档：** [5.2 治理风险哨兵](./5.2_治理风险哨兵.md) · [5.3 全局断路器与时间锁](./5.3_全局断路器与时间锁.md)
>
> **来源文档：** `模块_5_安全堡垒与治理风控.md` §5.1 · §5.2；`模块_9_验证门控_G1-G8.md` G8 部分
>
> **⚠️ 重要修正（相较于原模块5文档）：** 原文档大额审批阈值仅描述了 STAGED 阶段的绝对金额（$10,000），缺少 LIVE 阶段的相对比例规则。本文档在 §3 中补全了按策略生命周期的差异化审批规则，与 PRD `策略生命周期定义说明文档` §3.5/§3.6 完全对齐。

---

## 1. 设计原则：物理级隔离

MPC 签名架构的核心设计哲学是**决策权与签名权的物理分离**：

```
Zone A（非信任区）         Zone B（高信任区）           Zone C（极高安全区）
─────────────────          ─────────────────            ──────────────────────
Python Agent               Go-Execution-Engine          MPC Signer Node
                                                        Whitelist Proxy
                                                        Admin-Approval-API

AI 策略生成决策     →→→     EVM 仿真 + FSM 验证   →→→   白名单校验 + 分片签名
（无签名权限）               （无私钥材料）               （物理隔离，零公网）
```

**关键安全保证：**
- Zone A 的代码即使完全被攻陷，也无法访问 Zone C 的私钥分片
- Zone C 只接受来自 Zone B 经过 mTLS 认证的请求
- MPC 节点在任何时刻都不拼合完整私钥，签名在分片间协作完成
- 白名单代理在签名前进行最后一道物理校验，对未授权地址的请求**直接丢弃**

---

## 2. 签名前置校验（Whitelist Enforcement Proxy）

在 MPC 节点释放私钥分片**之前**，Whitelist Enforcement Proxy 执行以下强制校验：

```go
// PreSignCheck 签名协调器在调用 MPC 接口前的最后校验
// 部署位置：Zone C 的 Whitelist-Enforcement-Proxy 节点
func (s *SignerCoordinator) PreSignCheck(
    payload TradePayload,
    whitelist ContractWhitelist,
) error {
    // 1. 目标合约地址白名单校验
    //    白名单来源：模块 1.2 Adapter Registry 中注册的合约地址
    if !whitelist.IsAllowedAddress(payload.ToAddress) {
        s.alertManager.FireCritical("WHITELIST_VIOLATION", map[string]interface{}{
            "to_address":  payload.ToAddress,
            "internal_tx": payload.InternalTxID,
            "trace_id":    payload.TraceID,
        })
        return fmt.Errorf("SECURITY_VIOLATION: target address %s not in whitelist", payload.ToAddress)
    }

    // 2. 函数选择器校验（前 4 字节）
    //    只允许白名单内的函数：swap, deposit, withdraw, addLiquidity 等
    methodSelector := payload.Data[:4]
    if !whitelist.IsAllowedMethod(methodSelector) {
        return fmt.Errorf("SECURITY_VIOLATION: method %x not in allowed list", methodSelector)
    }

    // 3. 大额审批阈值校验（见 §3，按策略生命周期差异化）
    if err := s.checkApprovalRequired(payload); err != nil {
        return err  // 挂起至 PENDING_APPROVAL，不返回错误给调用方
    }

    return nil
}
```

> **白名单的维护：** 合约白名单以 Adapter Registry（§3.2）的注册状态为权威来源。新增协议时须在 Registry 中注册合约地址，由管理员审批后经 24h 时间锁生效（见 §5.3），未注册地址的交易在 Whitelist Proxy 层直接拒绝。

---

## 3. 大额审批阈值（按策略生命周期差异化）

**原则：** 不同生命周期阶段，策略的资金规模和风险等级不同，因此大额审批阈值采用**不同口径**，而非统一的绝对金额。

> 以下规则与 PRD `策略生命周期定义说明文档` §3.5（STAGED）和 §3.6（LIVE）严格对应。

### 3.1 STAGED 阶段：绝对金额阈值

**适用范围：** 策略处于 `STAGED`（预上线灰度验证）状态。

**规则：** 单笔交易估值 **> $10,000** 时，自动挂起至 `PENDING_APPROVAL` 状态，须管理员二次确认。

**设计理由：** STAGED 阶段是首次使用真实资金，整体仓位受限（不超过全局资金池的 5%），绝对金额阈值提供保守的固定保护线，防止灰度验证期间出现异常大单。

```go
// STAGED 阶段审批逻辑
func (s *SignerCoordinator) checkStagedApproval(payload TradePayload) error {
    if payload.EstimatedValueUSD.Cmp(s.cfg.StagedAbsoluteThreshold) > 0 {
        // 将 FSM 状态设为 PENDING_APPROVAL，挂起等待管理员
        s.fsm.SetPendingApproval(payload.InternalTxID, ApprovalReason{
            Code:    "STAGED_HIGH_VALUE",
            Message: fmt.Sprintf("Single tx value $%.2f exceeds STAGED threshold $%.2f",
                toUSD(payload.EstimatedValueUSD),
                toUSD(s.cfg.StagedAbsoluteThreshold)),
        })
        return ErrPendingApproval
    }
    return nil
}
```

**配置键：** `staged_approval_threshold_usd`（默认值：`10000`，单位：美元）

### 3.2 LIVE 阶段：相对比例阈值

**适用范围：** 策略处于 `LIVE`（生产运行）状态。

**规则：** 以下**任意一条**触发时，须管理员二次确认：

| 触发条件 | 说明 |
|---|---|
| 单笔 > 策略当前分配资金的 **15%** | 相对比例，防止单笔操作消耗过大比例仓位 |
| 首次调用从未执行过的合约 | 新合约的首次交互须人工确认（防止合约变更或钓鱼） |
| 触达不变性断言边界的 **50%** | 接近风控底线时提前预警，非等到破线才响应 |

```go
// LIVE 阶段审批逻辑（三条件任一触发）
func (s *SignerCoordinator) checkLiveApproval(
    payload TradePayload,
    strategy *Strategy,
) error {
    // 条件 1：单笔超过当前分配资金的 15%
    threshold15pct := new(big.Int).Mul(strategy.AllocatedCapital, big.NewInt(15))
    threshold15pct.Div(threshold15pct, big.NewInt(100))

    if payload.EstimatedValueUSDC.Cmp(threshold15pct) > 0 {
        return s.suspendForApproval(payload, "LIVE_HIGH_VALUE_RATIO",
            fmt.Sprintf("Single tx %.1f%% of allocated capital (threshold 15%%)",
                pct(payload.EstimatedValueUSDC, strategy.AllocatedCapital)))
    }

    // 条件 2：首次调用未知合约
    if !s.contractHistory.HasPreviousCall(payload.ToAddress) {
        return s.suspendForApproval(payload, "LIVE_NEW_CONTRACT",
            fmt.Sprintf("First interaction with contract %s", payload.ToAddress))
    }

    // 条件 3：触达不变性断言边界的 50%
    invariantStatus := strategy.InvariantChecker.GetBoundaryPct(payload)
    if invariantStatus.NearestBoundaryPct >= 50.0 {
        return s.suspendForApproval(payload, "LIVE_INVARIANT_BOUNDARY",
            fmt.Sprintf("At %.1f%% of invariant boundary (threshold 50%%)",
                invariantStatus.NearestBoundaryPct))
    }

    return nil  // 三条件均未触发，MPC 全自动签名
}
```

**配置键：** `live_approval_ratio_pct`（默认值：`15`，单位：百分比）

### 3.3 阈值总览对照表

| 策略状态 | 阈值口径 | 触发条件 | 未触发时的签名方式 |
|---|---|---|---|
| **STAGED** | 绝对金额 | 单笔 > $10,000 | MPC 全自动签名 |
| **LIVE** | 相对比例 + 合约新鲜度 + 不变性边界 | 三条件任一 | MPC 全自动签名 |
| **SHADOWED** | 不适用 | 影子模式不触发真实签名 | — |

> **为什么 LIVE 阶段不沿用 $10,000 绝对值？** LIVE 阶段策略资金规模可能远超 STAGED，若仍以 $10,000 为阈值，会导致几乎所有交易都触发审批，严重影响策略执行效率。相对比例阈值随资金规模自适应，保持合理的审批频率。

---

## 4. 管理员审批流程

当交易进入 `PENDING_APPROVAL` 状态时：

```
FSM 状态：PENDING_APPROVAL
    │
    ├── 自动发送告警（§6.3 ApprovalQueueBacklog）
    │
    ├── 在 Admin Web Portal（Zone A）展示待审批队列
    │     显示：策略ID、交易详情、触发原因、估算价值
    │
    ├── 管理员审查后，通过 Admin Web Portal 操作：
    │     ✅ 批准 → Admin-Approval-API（Zone C）接收确认
    │              → MPC Signer 释放签名
    │              → FSM 推进至 SIGNED
    │
    │     ❌ 拒绝 → FSM 推进至 FAILED
    │              → 记录拒绝原因至审计日志
    │
    └── 超时（默认 30 分钟无操作）：
          → FSM 推进至 FAILED
          → 触发升级告警（P1 级）
```

**审计日志要求：** 所有审批操作（批准/拒绝/超时）须记录：操作者身份、时间戳、操作原因、关联 trace_id，存入不可篡改的审计日志（见 §6.1）。

---

## 5. MPC 分片签名机制

### 5.1 签名流程

```
Zone B（Go-Execution-Engine）发起签名请求：

1. FSM 推进至 SIGNED 前：
   - 获取 Nonce 锁（见 §3.3 Nonce 分配）
   - 构建 unsigned Payload（含 nonce、gas、to、data、value）
   - 仅发送 Hash 摘要至 Zone C（不发送明文 Payload）

2. Zone C（Whitelist-Enforcement-Proxy）接收：
   - 校验 mTLS 客户端证书 + 来源 IP（见 §1.3）
   - 执行 §2 的白名单校验
   - 执行 §3 的审批阈值校验

3. Zone C（MPC-Signer-Node）执行分片签名：
   - 各分片节点独立持有密钥碎片
   - 通过 TSS（Threshold Signature Scheme）协议协作生成签名
   - 签名过程中永不拼合完整私钥
   - 返回签名结果至 Zone B

4. Zone B 接收签名结果：
   - 组装完整的 signed transaction
   - 推进 FSM 至 SIGNED
   - 调用 MEV Router 广播（§3.4）
```

### 5.2 密钥分片安全规则

| 规则 | 说明 |
|---|---|
| 分片数量 | N 个节点，最少需要 M 个参与（M-of-N 阈值签名，M < N） |
| 分片存储 | 每个节点独立物理机，加密存储，禁止跨节点共享 |
| 签名时机 | 仅在 Whitelist Proxy 校验通过且（如需）管理员审批后 |
| 中间状态 | 签名协议的中间计算结果签名完成后立即销毁 |
| 审计日志 | 每次签名操作记录完整审计日志（时间、trace_id、目标地址） |

---

## 6. 评价标准

| 维度 | 好架构 | 坏架构 |
|---|---|---|
| **隔离程度** | AI 策略代码即使被黑，也无法将资金转出白名单地址 | 只要拿到应用服务器权限，就能直接调用签名 API |
| **阈值适配性** | STAGED 绝对值保守保护，LIVE 相对比例效率优先，两阶段差异化 | 全生命周期统一绝对阈值，LIVE 阶段要么过松要么频繁触发审批 |
| **响应时效** | Kill Switch 演练表明可在 60 秒内撤销所有授权 | 发生攻击时需要手动拼接交易，耗时以十分钟计 |
| **合规性** | 大额交易必须经过人工二次确认，且有完整审计日志 | 决策完全依赖 AI，缺乏人的最后一道关卡 |
| **密钥安全** | MPC 分片签名，私钥从不完整存在于任何单一节点 | 私钥明文存于服务器内存或环境变量 |

---

*上一篇：[4.2 资产估值与审计](../04_财务与结算/4.2_资产估值与审计.md) | 下一篇：[5.2 治理风险哨兵](./5.2_治理风险哨兵.md)*
