# 1.2 容器资源配额 (Container Resource Quotas)

> **文档类型：** 架构文档 · 部署架构篇
> **版本：** v1.0 · 2026-02-26
> **上游依赖：** [1.1 三区网络拓扑](./1.1_三区网络拓扑.md)
> **下游文档：** [1.3 网络安全策略](./1.3_网络安全策略.md)

---

## 1. 设计原则

资源配额的核心目标是**故障隔离**：确保 Zone A 中某个 Python Agent 发生内存溢出（OOM）或 CPU 饥饿时，不会影响 Zone B 中 Go-Execution-Engine 的 Nonce 锁管理器和 FSM 状态机的正常运行。

**性能底线：** 系统端到端 P99 延迟 < 500ms（从 AI 产生信号到 FSM 推进至 SIMULATED 状态）。所有资源配额以满足此底线为首要约束。

---

## 2. Zone A — 策略计算区容器配额

### 2.1 Python-Agent

| 配置项 | 规格 | 说明 |
|---|---|---|
| **基础镜像** | `python:3.11-slim` | slim 镜像减少攻击面，禁止使用 full 镜像 |
| **CPU 配额** | `1.0 Core`（上限） | 单 Agent 计算量有限，严格限制防止抢占 Zone B 资源 |
| **内存配额** | `2 GB`（硬限制） | 触发 OOM 时容器自动重启，不影响其他 Agent |
| **存储挂载** | 只读挂载策略代码目录 | 策略逻辑以只读方式注入，防止容器内篡改 |
| **重启策略** | `on-failure`（最多 3 次） | 超过 3 次连续崩溃触发告警，移出服务池等待人工排查 |
| **网络** | `intelligence_net`（仅内网） | 不挂载公网接口，参见 §1.1 Zone A 通信限制 |

**横向扩展：** 通过 `docker-compose up --scale python-agent=N` 可在数秒内扩展至 N 个实例，无需修改 Zone B 任何配置。

### 2.2 AI-Feedback-Service

| 配置项 | 规格 | 说明 |
|---|---|---|
| **基础镜像** | `python:3.11-slim` | 与 Python-Agent 共用基础镜像 |
| **CPU 配额** | `0.5 Core` | 反馈处理为非实时任务，低优先级 |
| **内存配额** | `1 GB` | Prompt 生成不需要大内存 |
| **存储挂载** | 读写挂载 Prompt 输出目录 | 需要写出生成的语料文件 |

### 2.3 Admin Web Portal

| 配置项 | 规格 | 说明 |
|---|---|---|
| **基础镜像** | `node:20-alpine` 或自定义 Web 镜像 | 轻量 Web 服务 |
| **CPU 配额** | `0.5 Core` | 低频管理操作，无高并发需求 |
| **内存配额** | `512 MB` | 静态页面 + API 代理 |
| **端口暴露** | `HTTPS 443`（仅入站） | 唯一对外暴露的端口 |

---

## 3. Zone B — 模拟验证区容器配额

### 3.1 Go-Execution-Engine ⭐ 核心容器

| 配置项 | 规格 | 说明 |
|---|---|---|
| **基础镜像** | `golang:1.22-alpine` | |
| **CPU 配额** | `4.0 Cores`（保证值） | 高优先级，保证值确保 FSM 不被其他容器抢占 |
| **内存配额** | `8 GB` | StateDB 内存缓存 + FSM 状态 + 并发仿真缓冲 |
| **存储** | 高速 NVMe SSD | StateDB 缓存溢出落盘需要极低延迟 |
| **Core Dump** | 启用，输出至专用卷 | 进程崩溃时保存完整内存快照，用于 Recovery Manager 复盘 |
| **重启策略** | `always` | 自愈管理器依赖容器快速重启后的状态扫描 |
| **CPU 调度** | `cpu-shares: 1024`（最高优先级） | 资源竞争时优先保障 Go-Execution-Engine |

> **为什么需要 NVMe？** Go 仿真器使用内存态 StateDB，但高并发场景下（50+ Agent 同时提交请求）缓存条目可能溢出至磁盘。磁盘 I/O 延迟直接影响仿真时间，进而影响端到端 P99 延迟目标。

### 3.2 Redis-Cluster

| 配置项 | 规格 | 说明 |
|---|---|---|
| **基础镜像** | `redis:7.2-alpine` | |
| **CPU 配额** | `2.0 Cores` | 50+ Consumer Group 并发消费，CPU 是瓶颈 |
| **内存配额** | `4 GB` | Stream 保留 `redis_stream_maxlen` 条消息（默认 10,000 条），见 §0.6 |
| **持久化** | AOF（Append-Only File）模式 | 防止 Redis 重启后消息丢失，Consumer Group 的 PEL 得以恢复 |
| **重启策略** | `always` | AOF 持久化确保重启后数据完整恢复 |

### 3.3 Anvil-Node

| 配置项 | 规格 | 说明 |
|---|---|---|
| **基础镜像** | `ghcr.io/foundry-rs/foundry:latest` | Foundry 官方镜像 |
| **CPU 配额** | `2.0 Cores` | G4 Fuzzing 需要并行执行 1000 轮 EVM 仿真 |
| **内存配额** | `4 GB` | 主网分叉状态缓存 |
| **存储** | `tmpfs`（内存文件系统） | 仿真状态不需要持久化，使用内存文件系统最大化 I/O 速度 |
| **生命周期** | 按需启动（非常驻） | 仅在 G2/G4 门控验证期间启动，完成后释放资源 |
| **网络** | 仅 Zone B 内网，禁止公网 | 防止仿真节点被外部探测 |

### 3.4 PostgreSQL

| 配置项 | 规格 | 说明 |
|---|---|---|
| **基础镜像** | `postgres:16-alpine` | |
| **CPU 配额** | `2.0 Cores` | 支持 FSM 状态更新、Nonce 锁行级锁、账本写入的并发 |
| **内存配额** | `4 GB`（含 shared_buffers） | `shared_buffers = 1GB`，`effective_cache_size = 3GB` |
| **存储** | 高速 NVMe SSD，持久化卷 | 账本数据不可丢失，需要持久化卷挂载 |
| **备份策略** | 每日全量快照，保留 30 个版本 | |
| **重启策略** | `always` | |

### 3.5 其他 Zone B 组件

| 组件 | CPU | 内存 | 说明 |
|---|---|---|---|
| **MEV-Router** | `1.0 Core` | `512 MB` | 轻量路由决策，主要是网络 I/O |
| **Data-Processor** | `1.0 Core` | `1 GB` | L1→L2 数据标准化，CPU 轻量 |
| **Chain-Adapter** | `1.0 Core` | `1 GB` | 多 RPC 节点 WebSocket 管理 |
| **Archiver** | `0.5 Core` | `1 GB` | 批量归档为低优先级后台任务 |

---

## 4. Zone C — 核心签名区容器配额

> Zone C 运行在物理隔离的裸金属服务器上，不使用 Docker 资源配额管理。以下为物理机配置建议。

| 节点 | 建议配置 | 说明 |
|---|---|---|
| **MPC-Signer-Node × N** | 4 Core / 8 GB RAM / 加密存储 | N ≥ 3（满足阈值签名的最小分片数），每节点独立物理机 |
| **Whitelist-Enforcement-Proxy** | 2 Core / 4 GB RAM | 轻量校验逻辑，无需高配置 |
| **Admin-Approval-API** | 2 Core / 4 GB RAM | 低频管理 API，无并发压力 |

---

## 5. 完整资源配额总览

| 容器 / 节点 | Zone | CPU | 内存 | 存储类型 | 重启策略 |
|---|---|---|---|---|---|
| Go-Execution-Engine | B | 4.0 Core | 8 GB | NVMe SSD | always |
| Redis-Cluster | B | 2.0 Core | 4 GB | AOF 持久化 | always |
| Anvil-Node | B | 2.0 Core | 4 GB | tmpfs | on-demand |
| PostgreSQL | B | 2.0 Core | 4 GB | NVMe SSD 持久卷 | always |
| MEV-Router | B | 1.0 Core | 512 MB | — | always |
| Data-Processor | B | 1.0 Core | 1 GB | — | always |
| Chain-Adapter | B | 1.0 Core | 1 GB | — | always |
| Archiver | B | 0.5 Core | 1 GB | — | always |
| Python-Agent（每实例） | A | 1.0 Core | 2 GB | 只读挂载 | on-failure（3次） |
| AI-Feedback-Service | A | 0.5 Core | 1 GB | 读写挂载 | on-failure |
| Admin Web Portal | A | 0.5 Core | 512 MB | — | always |
| MPC-Signer-Node（每节点） | C | 4 Core（物理） | 8 GB（物理） | 加密存储 | 物理机管理 |

---

## 6. 资源扩展指南

### 6.1 Python Agent 横向扩展

```bash
# 扩展至 100 个 Agent 实例
docker-compose up --scale python-agent=100

# 缩减回 50 个
docker-compose up --scale python-agent=50
```

扩展时无需重启 Zone B 任何组件。Redis Consumer Group 自动感知新实例加入，负载均衡由 Redis Stream 分发机制处理。

### 6.2 性能瓶颈识别

当系统 P99 延迟接近 500ms 时，按以下顺序排查资源瓶颈：

```
1. 查看 Go-Execution-Engine CPU 使用率
   → 若 > 80%，考虑增加 CPU 配额或优化仿真缓存命中率

2. 查看 Redis-Cluster 内存使用率
   → 若接近 4 GB，检查 redis_stream_maxlen 配置是否过大

3. 查看 PostgreSQL 查询延迟
   → Nonce 锁的 FOR UPDATE 查询若出现锁等待，考虑优化索引

4. 查看 Chain-Adapter RPC 响应时间
   → 若 RPC 节点响应慢，触发节点切换逻辑（见 §3.1）
```

---

*上一篇：[1.1 三区网络拓扑](./1.1_三区网络拓扑.md) | 下一篇：[1.3 网络安全策略](./1.3_网络安全策略.md)*
