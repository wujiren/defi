# 1.3 网络安全策略 (Network Security Policy)

> **文档类型：** 架构文档 · 部署架构篇
> **版本：** v1.0 · 2026-02-26
> **上游依赖：** [1.1 三区网络拓扑](./1.1_三区网络拓扑.md) · [1.2 容器资源配额](./1.2_容器资源配额.md)
> **下游文档：** [5.1 MPC 签名与白名单拦截](../05_安全防御/5.1_MPC签名与白名单拦截.md)

---

## 1. 安全模型概述

系统网络安全遵循**纵深防御（Defense in Depth）**原则，共设三层防护：

```
第一层：物理 / VPC 隔离
  └── Zone A / Zone B / Zone C 分属不同物理或逻辑网络，跨 Zone 无默认路由

第二层：Docker 网络隔离
  └── intelligence_net / sandbox_net / fortress_net 相互独立
  └── 容器只能连接自身所属网络，跨网络通信须经明确配置的网关

第三层：应用层校验
  └── 所有跨 Zone 请求携带 Trace ID，网关层验证
  └── Zone C 入口强制双向 TLS（mTLS）认证
  └── MPC 白名单代理校验目标合约地址（见 §5.1）
```

---

## 2. Docker 网络配置

### 2.1 完整 Docker 网络定义

```yaml
# docker-compose.yml — 网络定义段
networks:

  # Zone A 网络：策略计算区
  # internal: true 阻止容器直接访问宿主机以外的公网
  # 容器对外通信须经宿主机的 NAT 规则白名单
  intelligence_net:
    driver: bridge
    internal: false          # Zone A 需要访问外部治理数据源（Snapshot/Tally）
    ipam:
      config:
        - subnet: 10.0.1.0/24

  # Zone B 网络：模拟验证区
  # 高信任区，与 Zone A 和 Zone C 通过受限端口通信
  sandbox_net:
    driver: bridge
    internal: false          # 需要访问链上 RPC 节点和 Flashbots Relay
    ipam:
      config:
        - subnet: 10.0.2.0/24

  # Zone C 网络：核心签名区
  # 极高安全，仅接受来自 sandbox_net 的 mTLS 连接
  fortress_net:
    driver: bridge
    internal: true           # 完全内网，禁止任何出站公网访问
    ipam:
      config:
        - subnet: 10.0.5.0/24
```

### 2.2 容器网络归属

```yaml
# docker-compose.yml — 服务网络归属段（节选）
services:

  python-agent:
    networks:
      - intelligence_net     # 仅归属 Zone A，无法访问 fortress_net

  go-execution-engine:
    networks:
      - sandbox_net          # 主网络：Zone B
      - intelligence_net     # 双归属：接收来自 Zone A 的 gRPC 请求
    # 注意：go-execution-engine 不归属 fortress_net
    # 与 Zone C 的通信通过独立的 mTLS 代理节点完成

  mpc-signer-node:
    networks:
      - fortress_net         # 仅归属 Zone C，外部不可直接访问
```

> **Zone A → Zone B 的 gRPC 通信：** Go-Execution-Engine 同时归属 `intelligence_net` 和 `sandbox_net`，作为 Zone A 的 gRPC 入口。这是 Zone A 唯一合法的跨 Zone 通信路径。

---

## 3. 防火墙与安全组规则

### 3.1 Zone A（策略计算区）安全组

| 方向 | 协议 | 端口 | 来源 / 目标 | 说明 |
|---|---|---|---|---|
| 入站 | HTTPS | 443 | 管理员 IP 白名单 | Admin Web Portal 管理访问 |
| 出站 | gRPC | 50051 | Zone B Go-Execution-Engine | TradeRequest 提交 |
| 出站 | TCP | 6379 | Zone B Redis-Cluster | Redis Stream 订阅（只读） |
| 出站 | HTTPS | 443 | Snapshot.org / Tally.xyz / AI API | 治理数据和 AI 语料获取 |
| **全部拒绝** | — | — | Zone C 任意地址 | 物理阻断，不可配置 |

### 3.2 Zone B（模拟验证区）安全组

| 方向 | 协议 | 端口 | 来源 / 目标 | 说明 |
|---|---|---|---|---|
| 入站 | gRPC | 50051 | Zone A Go-Execution-Engine | 接收 TradeRequest |
| 入站 | mTLS | 8443 | Zone C（签名结果回传） | 接收 Signed Payload |
| 出站 | mTLS | 8443 | Zone C MPC-Signer-Node | 转发已验证的签名请求 |
| 出站 | HTTPS | 443 | 指定 RPC 节点白名单 | 链上数据获取（newHeads / Logs） |
| 出站 | HTTPS | 443 | relay.flashbots.net | MEV Router 广播私有 Bundle |
| 出站 | HTTPS | 443 | S3 / MinIO 端点 | 归档 Parquet 历史数据 |
| **全部拒绝** | — | — | 除上述外的公网地址 | 最小权限出站 |
| **全部拒绝** | — | — | 公网入站（非白名单来源） | 不对外暴露 Zone B 服务 |

### 3.3 Zone C（核心签名区）安全组

| 方向 | 协议 | 端口 | 来源 / 目标 | 说明 |
|---|---|---|---|---|
| 入站 | mTLS | 8443 | Zone B（白名单 IP） | 唯一入站来源，IP + 证书双重认证 |
| 出站 | mTLS | 8443 | Zone B（白名单 IP） | 返回签名结果 |
| **全部拒绝** | — | — | 其他所有地址 | 零公网、零 Zone A 访问 |

---

## 4. 跨 Zone 通信安全规范

### 4.1 Zone A → Zone B（gRPC）

```
传输层：gRPC over TLS（单向，Zone B 提供服务端证书）
认证方式：Zone A 客户端无需提供证书（Zone B 已通过网络层限制来源）
必携字段：Context.trace_id（UUID v4，缺失则网关拒绝）
必携字段：Context.last_sync_block（水位线，由 Sync Sentinel 校验）
消息格式：强类型 Protobuf，拒绝任何非 .proto 定义的字段
```

### 4.2 Zone B → Zone C（mTLS 专线）

```
传输层：双向 TLS 1.3（mTLS）
认证方式：
  - Zone B 出示客户端证书（由内部 CA 签发）
  - Zone C 校验客户端证书 + 来源 IP 双重匹配
  - Zone C 出示服务端证书（由同一内部 CA 签发）
传输内容：仅交易 Hash 摘要（不传明文 Payload）
必携字段：internal_tx_id（与数据库记录关联）
必携字段：trace_id（全链路追踪，审计日志必需）
证书轮换：每 90 天强制轮换，轮换期间新旧证书并行有效 24 小时
```

### 4.3 禁止事项（硬编码，不可通过配置覆盖）

```
❌ Zone A 容器绝不持有 Zone C 的任何通信凭证
❌ 任何 Payload 不以明文形式发送至 Zone C（仅发送 Hash 摘要）
❌ Zone C 不主动发起连接（只被动接收来自 Zone B 的请求）
❌ 跨 Zone 连接不使用自签名证书（必须由统一内部 CA 签发）
❌ Zone C 节点不安装任何非必需软件（最小化镜像）
```

---

## 5. 证书与密钥管理

### 5.1 内部 CA 体系

```
Root CA（离线保存，物理隔离）
  ├── Intermediate CA - Zone B（签发 Zone B 客户端证书）
  └── Intermediate CA - Zone C（签发 Zone C 服务端证书）
```

- Root CA 私钥离线保存，仅在签发 Intermediate CA 证书时使用
- Intermediate CA 私钥保存在 Zone C 的 HSM 中
- Zone B 的客户端证书有效期 90 天，到期前 14 天自动申请轮换

### 5.2 证书存储规范

| 证书类型 | 存储位置 | 访问权限 |
|---|---|---|
| Zone B 客户端证书 | Zone B 加密 Secret（Docker Secret） | 仅 MEV-Router 和 Go-Execution-Engine 可读 |
| Zone C 服务端证书 | Zone C HSM | 仅 Whitelist-Enforcement-Proxy 可读 |
| mTLS CA 证书链 | Zone B 和 Zone C 均存储完整 CA 链 | 容器启动时只读挂载 |

---

## 6. 物理环境对照表

| 逻辑区域 | 建议物理环境 | 网络入口 | 公网访问 |
|---|---|---|---|
| **Zone A（策略计算区）** | 公有云 VPC（阿里云 / AWS VPC-A） | 开放 HTTPS 443（Admin Portal） | ✅ 受限（白名单出站） |
| **Zone B（模拟验证区）** | 高性能私有云 / 本地服务器（VPC-B） | 不对外暴露，仅 VPC 内网 | ⚠️ 受控（白名单 RPC + Flashbots） |
| **Zone C（核心签名区）** | 独立物理机群（Bare Metal / HSM） | 零公网，仅 VPC-B 专线 | ❌ 禁止 |

---

## 7. 安全事件响应

| 事件级别 | 触发条件 | 响应动作 | 负责方 |
|---|---|---|---|
| **P0 严重** | Zone C 任意节点检测到非白名单连接尝试 | 立即隔离该节点，触发 MPC 密钥重新分片仪式 | 安全工程师（15 分钟内响应） |
| **P0 严重** | Zone A 容器出现异常出站连接（目标不在白名单） | 隔离容器，触发全局断路器（见 §5.3） | 运维 + 安全工程师 |
| **P1 高危** | mTLS 证书校验失败次数 > 5 次 / 小时 | 告警通知，检查证书是否即将过期或被替换 | DevOps |
| **P1 高危** | Zone B 出现未授权的出站连接尝试 | 记录日志，触发安全审计 | DevOps |
| **P2 中危** | Admin Web Portal 检测到异常登录（非白名单 IP） | 封禁来源 IP，通知管理员 | DevOps |

---

*上一篇：[1.2 容器资源配额](./1.2_容器资源配额.md) | 下一篇：[2.1 Protobuf 契约](../02_数据总线与契约/2.1_Protobuf契约.md)*
