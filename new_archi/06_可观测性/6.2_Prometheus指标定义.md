# 6.2 Prometheus 指标定义 (Prometheus Metrics)

> **文档类型：** 架构文档 · 可观测性篇
> **版本：** v1.0 · 2026-02-26
> **上游依赖：** [6.1 全链路 Trace ID 规范](./6.1_全链路Trace_ID规范.md)
> **下游文档：** [6.3 告警规则集](./6.3_告警规则集.md)
>
> **文档类型：** 新写（从各模块的关键数值提炼，无直接来源文档）
>
> **设计原则：** 指标命名遵循 Prometheus 命名规范（`{namespace}_{subsystem}_{name}`），统一使用 `defi` 作为 namespace。所有指标通过 Go 执行引擎的 `/metrics` 端点暴露，由 Prometheus 定时抓取，Grafana 负责可视化。

---

## 1. 指标总览

系统共定义 **10 类核心指标**，按所属子系统分组：

| 子系统 | 指标数量 | 核心关注点 |
|---|---|---|
| FSM 状态机 | 4 个 | 交易执行效率与卡死检测 |
| 数据水位线 | 2 个 | 链上数据新鲜度 |
| 预言机 | 1 个 | 三源价格一致性 |
| 财务 | 1 个 | 策略实时盈亏 |
| MEV | 1 个 | 执行质量与被夹损耗 |
| 安全 | 3 个 | 异常签名与审批积压 |

---

## 2. FSM 状态机指标

### 2.1 `defi_fsm_state_transitions_total`

**类型：** Counter
**含义：** FSM 各状态转换的累计次数，按转换路径（`from_state → to_state`）分维度统计

```go
var fsmStateTransitions = prometheus.NewCounterVec(
    prometheus.CounterOpts{
        Namespace: "defi",
        Subsystem: "fsm",
        Name:      "state_transitions_total",
        Help:      "Total number of FSM state transitions by from/to state pair",
    },
    []string{"from_state", "to_state", "strategy_id"},
)

// 用法示例（状态推进时调用）
fsmStateTransitions.WithLabelValues("SIMULATED", "SIGNED", strategyID).Inc()
fsmStateTransitions.WithLabelValues("BROADCASTED", "CONFIRMED", strategyID).Inc()
fsmStateTransitions.WithLabelValues("BROADCASTED", "FAILED", strategyID).Inc()
```

**关键 Label：**

| Label | 说明 | 示例值 |
|---|---|---|
| `from_state` | 转换前状态 | `INIT` / `SIMULATED` / `SIGNED` / `BROADCASTED` |
| `to_state` | 转换后状态 | `SIMULATED` / `SIGNED` / `CONFIRMED` / `FAILED` / `REORG` |
| `strategy_id` | 发起交易的策略 ID | `trend_follower_v2` |

**告警关联：** 高 `BROADCASTED → FAILED` 比率触发 §6.3 `HighBroadcastFailureRate` 告警。

---

### 2.2 `defi_fsm_stuck_tasks_total`

**类型：** Counter
**含义：** 卡死在某状态超过阈值时间的任务累计数量

```go
var fsmStuckTasks = prometheus.NewCounterVec(
    prometheus.CounterOpts{
        Namespace: "defi",
        Subsystem: "fsm",
        Name:      "stuck_tasks_total",
        Help:      "Total number of tasks stuck in a state beyond timeout threshold",
    },
    []string{"stuck_state", "trigger"},
)

// 用法：Recovery Manager 检测到卡死任务时调用
fsmStuckTasks.WithLabelValues("BROADCASTED", "gas_acceleration").Inc()
fsmStuckTasks.WithLabelValues("SIGNED", "rebroadcast").Inc()
```

**Label 说明：**
- `stuck_state`：卡死的 FSM 状态（通常为 `BROADCASTED` 或 `SIGNED`）
- `trigger`：自愈触发的动作类型（`gas_acceleration` / `rebroadcast` / `manual`）

---

### 2.3 `defi_fsm_transition_duration_ms`

**类型：** Histogram
**含义：** FSM 各阶段转换耗时分布，用于 P99 延迟分析

```go
var fsmTransitionDuration = prometheus.NewHistogramVec(
    prometheus.HistogramOpts{
        Namespace: "defi",
        Subsystem: "fsm",
        Name:      "transition_duration_ms",
        Help:      "Duration of FSM state transitions in milliseconds",
        Buckets:   []float64{10, 50, 100, 200, 500, 1000, 2000, 5000},
    },
    []string{"transition"},
)

// 用法：记录各阶段耗时
fsmTransitionDuration.WithLabelValues("INIT_to_SIMULATED").Observe(float64(elapsed.Milliseconds()))
fsmTransitionDuration.WithLabelValues("SIGNED_to_BROADCASTED").Observe(float64(elapsed.Milliseconds()))
fsmTransitionDuration.WithLabelValues("end_to_end").Observe(float64(elapsed.Milliseconds())) // 全链路
```

**关键查询：**
```
# P99 端到端延迟
histogram_quantile(0.99,
  rate(defi_fsm_transition_duration_ms_bucket{transition="end_to_end"}[5m])
)
# 告警阈值：P99 > 500ms（见 §6.3）
```

**最佳实践 (Prometheus Exemplars)：**
强烈建议在 `defi_fsm_transition_duration_ms` 和 `defi_mev_loss_bps` 等 Histogram 观测点旁，使用 Exemplars 注入当前的 `trace_id`。这允许 DevOps 工程师在 Grafana 图表上看到异常波峰时，直接点击数据点跳转至对应的全链路日志，实现“秒级下钻”。

---

### 2.4 `defi_fsm_nonce_conflicts_total`

**类型：** Counter
**含义：** Nonce 冲突发生的累计次数（任何 Nonce 冲突均为严重异常）

```go
var nonceConflicts = prometheus.NewCounterVec(
    prometheus.CounterOpts{
        Namespace: "defi",
        Subsystem: "fsm",
        Name:      "nonce_conflicts_total",
        Help:      "Total number of nonce conflicts detected",
    },
    []string{"address", "chain_id"},
)
```

**告警关联：** 任何 Nonce 冲突立即触发 §6.3 `NonceConflictDetected` CRITICAL 告警。

---

## 3. 数据水位线指标

### 3.1 `defi_watermark_lag_blocks`

**类型：** Gauge
**含义：** 当前数据水位线（`SyncBlock`）落后链上最新区块的区块数

```go
var watermarkLag = prometheus.NewGaugeVec(
    prometheus.GaugeOpts{
        Namespace: "defi",
        Subsystem: "watermark",
        Name:      "lag_blocks",
        Help:      "Current number of blocks that SyncBlock lags behind the latest chain block",
    },
    []string{"chain_id"},
)

// 用法：Sync Sentinel 每次水位线检查后更新
watermarkLag.WithLabelValues("1").Set(float64(currentBlock - syncBlock))
```

**阈值说明：**
- 正常：`lag_blocks = 0` 或 `1`
- 告警：`lag_blocks > 2` → 触发 `StaleDataError`，停止发单（见 §3.1）
- 指标归零后告警自动恢复

---

### 3.2 `defi_rpc_request_duration_ms`

**类型：** Histogram
**含义：** RPC 节点请求响应延迟分布，用于检测 RPC 节点性能退化

```go
var rpcDuration = prometheus.NewHistogramVec(
    prometheus.HistogramOpts{
        Namespace: "defi",
        Subsystem: "rpc",
        Name:      "request_duration_ms",
        Help:      "RPC node request latency in milliseconds",
        Buckets:   []float64{10, 50, 100, 200, 500, 1000, 3000},
    },
    []string{"node_url", "method"},
)
```

**触发自动切换：** 当某节点 P99 延迟持续 > 1000ms，Chain-Adapter 自动切换至备用节点。

---

## 4. 预言机指标

### 4.1 `defi_oracle_deviation_bps`

**类型：** Gauge
**含义：** 三源预言机之间的最大价格偏差（万分位）

```go
var oracleDeviation = prometheus.NewGaugeVec(
    prometheus.GaugeOpts{
        Namespace: "defi",
        Subsystem: "oracle",
        Name:      "deviation_bps",
        Help:      "Maximum price deviation among three oracle sources in basis points (1/10000)",
    },
    []string{"token_pair"},
)

// 用法：每次三源校验后更新（见 §3.2）
// 计算 max(|P1-P2|, |P2-P3|, |P1-P3|) / P_median * 10000
oracleDeviation.WithLabelValues("ETH_USDC").Set(float64(maxDeviationBps))
```

**阈值：** 偏差 > 50 bps（0.5%）触发熔断，对应 §6.3 `OraclePriceSkew` 告警。

---

## 5. 财务指标

### 5.1 `defi_strategy_pnl_usdc`

**类型：** Gauge
**含义：** 各策略当前实时 PnL（U 本位，USDC，含 6 位小数的整数表示）

```go
var strategyPnL = prometheus.NewGaugeVec(
    prometheus.GaugeOpts{
        Namespace: "defi",
        Subsystem: "strategy",
        Name:      "pnl_usdc",
        Help:      "Real-time strategy PnL in USDC (6 decimal integer representation)",
    },
    []string{"strategy_id", "pnl_type"},
)

// pnl_type: "realized" | "unrealized" | "total"
strategyPnL.WithLabelValues("trend_follower_v2", "realized").Set(float64(realizedPnL))
strategyPnL.WithLabelValues("trend_follower_v2", "unrealized").Set(float64(unrealizedMtM))
```

**联动：** MtM 估值每区块更新（见 §4.2），实时回撤基于此指标计算。

### 5.2 `defi_strategy_max_drawdown_pct`

**类型：** Gauge
**含义：** 各策略当前实时最大回撤百分比（乘以 100 的整数，如 1500 表示 15%）

```go
var strategyMDD = prometheus.NewGaugeVec(
    prometheus.GaugeOpts{
        Namespace: "defi",
        Subsystem: "strategy",
        Name:      "max_drawdown_pct",
        Help:      "Real-time maximum drawdown percentage * 100 (e.g., 1500 = 15%)",
    },
    []string{"strategy_id"},
)
```

**告警关联：** 实时 MDD > 回测 MDD × 1.5 触发 §6.3 `StrategyDrawdownAlert` CRITICAL 告警，自动暂停策略。

---

## 6. MEV 指标

### 6.1 `defi_mev_loss_bps`

**类型：** Histogram
**含义：** MEV 损耗分布（万分位），包括三明治攻击损耗和毒性流估算损耗

```go
var mevLoss = prometheus.NewHistogramVec(
    prometheus.HistogramOpts{
        Namespace: "defi",
        Subsystem: "mev",
        Name:      "loss_bps",
        Help:      "MEV loss distribution in basis points",
        Buckets:   []float64{0, 5, 10, 20, 30, 50, 100, 200, 500},
    },
    []string{"strategy_id", "route_type", "loss_type"},
)

// route_type: "flashbots" | "public"
// loss_type: "sandwich" | "toxic_flow" | "slippage"
```

**关键查询：**
```
# 公共路由 vs Flashbots 路由的平均 MEV 损耗对比
avg by (route_type) (defi_mev_loss_bps_sum / defi_mev_loss_bps_count)
```

---

## 7. 安全指标

### 7.1 `defi_approval_pending_total`

**类型：** Gauge
**含义：** 当前处于 `PENDING_APPROVAL` 状态、等待管理员审批的交易数量

```go
var approvalPending = prometheus.NewGaugeVec(
    prometheus.GaugeOpts{
        Namespace: "defi",
        Subsystem: "approval",
        Name:      "pending_total",
        Help:      "Number of transactions currently pending admin approval",
    },
    []string{"strategy_id", "trigger_reason"},
)

// trigger_reason: "staged_high_value" | "live_high_ratio" | "new_contract" | "invariant_boundary"
```

**告警关联：** 积压 > 3 笔触发 §6.3 `ApprovalQueueBacklog` 告警。

---

### 7.2 `defi_whitelist_violations_total`

**类型：** Counter
**含义：** 白名单校验失败（目标合约不在白名单）的累计次数

```go
var whitelistViolations = prometheus.NewCounterVec(
    prometheus.CounterOpts{
        Namespace: "defi",
        Subsystem: "security",
        Name:      "whitelist_violations_total",
        Help:      "Total number of whitelist violations detected by MPC proxy",
    },
    []string{"agent_id", "target_address"},
)
```

**告警关联：** 单小时内 > 3 次触发 P0 安全告警，怀疑 Zone A 遭受入侵。

---

### 7.3 `defi_recovery_triggers_total`

**类型：** Counter
**含义：** Recovery Manager 自愈流程触发的累计次数，按触发原因分维度

```go
var recoveryTriggers = prometheus.NewCounterVec(
    prometheus.CounterOpts{
        Namespace: "defi",
        Subsystem: "fsm",
        Name:      "recovery_triggers_total",
        Help:      "Total number of Recovery Manager triggers by reason",
    },
    []string{"trigger_reason"},
)

// trigger_reason: "signed_not_broadcast" | "broadcast_stuck" | "gas_acceleration" | "reorg_detected"
recoveryTriggers.WithLabelValues("gas_acceleration").Inc()
```

**告警关联：** 单小时内触发 > 5 次时发出 §6.3 `HighRecoveryRate` WARNING 告警。

---

## 8. 指标采集配置

### 8.1 Prometheus 抓取配置

```yaml
# prometheus.yml
scrape_configs:
  - job_name: 'defi-go-engine'
    static_configs:
      - targets: ['go-execution-engine:9090']
    scrape_interval: 15s      # 每 15 秒抓取一次
    metrics_path: /metrics

  - job_name: 'defi-python-agents'
    static_configs:
      - targets: ['python-agent-1:9091', 'python-agent-2:9091']  # 每个 Agent 实例独立端口
    scrape_interval: 30s
```

### 8.2 指标端点规划

| 服务 | 端口 | 说明 |
|---|---|---|
| Go-Execution-Engine | `:9090/metrics` | FSM、水位线、预言机、财务、安全指标的主要来源 |
| Python-Agent（每实例）| `:9091/metrics` | 策略层指标（Agent 决策频率、水位线感知延迟） |
| MEV-Router | `:9092/metrics` | MEV 损耗和路由选择指标 |

---

## 9. Grafana 仪表盘建议

推荐按以下维度组织仪表盘面板：

```
Dashboard: DeFi System Overview
├── Row 1: 系统健康
│   ├── watermark_lag_blocks（当前水位线滞后，阈值线 = 2）
│   ├── oracle_deviation_bps（三源偏差，阈值线 = 50 bps）
│   └── rpc_request_duration_ms P99
│
├── Row 2: 交易执行
│   ├── fsm_transitions_total（按状态路径分组的速率图）
│   ├── fsm_transition_duration_ms P99（端到端延迟）
│   └── fsm_stuck_tasks_total（卡死任务趋势）
│
├── Row 3: 财务
│   ├── strategy_pnl_usdc（各策略实时 PnL）
│   ├── strategy_max_drawdown_pct（实时回撤，阈值线 = 回测 MDD × 1.5）
│   └── mev_loss_bps 分布
│
└── Row 4: 安全
    ├── approval_pending_total
    ├── whitelist_violations_total
    └── recovery_triggers_total
```

---

*上一篇：[6.1 全链路 Trace ID 规范](./6.1_全链路Trace_ID规范.md) | 下一篇：[6.3 告警规则集](./6.3_告警规则集.md)*
