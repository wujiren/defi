# 6.3 告警规则集 (Alerting Rules)

> **文档类型：** 架构文档 · 可观测性篇
> **版本：** v1.0 · 2026-02-26
> **上游依赖：** [6.2 Prometheus 指标定义](./6.2_Prometheus指标定义.md)
> **下游文档：** [6.4 AI 反馈飞轮](./6.4_AI反馈飞轮.md)
>
> **文档类型：** 新写（从各模块的熔断条件和阈值提炼，无直接来源文档）
>
> **告警级别定义：**
> - **CRITICAL（P0）：** 系统立即停止发单或存在资金安全风险，需 15 分钟内响应，On-Call 电话/短信通知
> - **WARNING（P1）：** 系统出现异常但仍运行，需 1 小时内处理，即时通讯告警
> - **INFO（P2）：** 非紧急，需关注的性能或质量问题，日报汇总

---

## 1. 告警总览

系统共定义 **16 条告警规则**，按子系统分组：

| 分组 | 告警数量 | 最高级别 |
|---|---|---|
| 数据水位线 | 2 条 | CRITICAL |
| 预言机 | 1 条 | CRITICAL |
| FSM 状态机 | 4 条 | WARNING |
| 财务风控 | 3 条 | CRITICAL |
| 安全防御 | 4 条 | CRITICAL |
| 系统性能 | 2 条 | WARNING |

---

## 2. 数据水位线告警

### 2.1 `CriticalWatermarkLag`

```yaml
alert: CriticalWatermarkLag
expr: defi_watermark_lag_blocks{} > 2
for: 0s          # 立即触发，无宽限期
labels:
  severity: critical
  group: watermark
annotations:
  summary: "数据水位线严重滞后：{{ $labels.chain_id }} 链滞后 {{ $value }} 个区块"
  description: |
    SyncBlock 落后当前区块超过 2 个区块阈值。
    Sync Sentinel 已触发 StaleDataError，系统已停止发单。
    需要立即排查 RPC 节点连通性和 Chain-Adapter 状态。
  runbook: "检查 Chain-Adapter 日志，确认 RPC 节点是否响应正常"
```

**触发来源：** §3.1 Sync Sentinel / §3.5 数据库水位线校验
**自动响应：** Sync Sentinel 同步触发 `StaleDataError`，无需等待告警 → 告警为二次通知

---

### 2.2 `RPCNodeDown`

```yaml
alert: RPCNodeDown
expr: |
  sum(up{job="defi-rpc-nodes"}) by (chain_id) == 0
for: 30s
labels:
  severity: critical
  group: watermark
annotations:
  summary: "{{ $labels.chain_id }} 链全部 RPC 节点无响应"
  description: |
    主备 RPC 节点均无法响应，水位线将随即停滞。
    系统将在 2 个区块滞后后停止发单。
  runbook: "检查网络连通性，尝试切换至备用 RPC 提供商"
```

---

## 3. 预言机告警

### 3.1 `OraclePriceSkew`

```yaml
alert: OraclePriceSkew
expr: defi_oracle_deviation_bps{} > 50
for: 0s          # 立即触发
labels:
  severity: critical
  group: oracle
annotations:
  summary: "三源预言机价格偏差过大：{{ $labels.token_pair }} 偏差 {{ $value }} bps"
  description: |
    三源价格（Chainlink / Uniswap TWAP / DEX Slot0）之间的最大偏差超过 50 bps（0.5%）。
    系统已触发单次熔断，拦截本次交易。策略状态未变更。
    若持续触发，需检查是否存在闪电贷攻击或 Chainlink 预言机更新延迟。
  runbook: "查看三源价格明细，判断是哪一路数据源出现异常偏离"
```

**触发来源：** §3.2 三源预言机交叉校验
**注意：** 单次熔断不改变策略状态，持续熔断（>5次/天）触发人工审查

---

## 4. FSM 状态机告警

### 4.1 `FSMTaskStuck`

```yaml
alert: FSMTaskStuck
expr: |
  defi_fsm_stuck_tasks_total{stuck_state="BROADCASTED"} > 0
for: 0s
labels:
  severity: warning
  group: fsm
annotations:
  summary: "存在 BROADCASTED 状态卡死的交易任务"
  description: |
    交易已广播但超过 5 分钟未确认（无 tx_hash 更新）。
    Recovery Manager 已自动触发阶梯 Gas 加速。
    如果加速后仍未确认，需人工检查 Gas 价格是否低于市场水平。
  runbook: "查看对应 trace_id 的交易状态，确认 Gas 加速是否成功"
```

---

### 4.2 `HighRecoveryRate`

```yaml
alert: HighRecoveryRate
expr: |
  rate(defi_fsm_recovery_triggers_total[1h]) > 5
for: 5m
labels:
  severity: warning
  group: fsm
annotations:
  summary: "Recovery Manager 触发频率异常：过去 1 小时触发 {{ $value }} 次"
  description: |
    Recovery Manager 自愈流程触发次数过高，说明系统不稳定（RPC 抖动、Gas 估算不准等）。
    持续的高自愈率会影响交易效率和增加 Gas 成本。
  runbook: "分析 recovery_triggers_total 的 trigger_reason 分布，定位根因"
```

---

### 4.3 `NonceConflictDetected`

```yaml
alert: NonceConflictDetected
expr: |
  increase(defi_fsm_nonce_conflicts_total[5m]) > 0
for: 0s
labels:
  severity: critical
  group: fsm
annotations:
  summary: "检测到 Nonce 冲突！地址：{{ $labels.address }}"
  description: |
    Nonce 冲突意味着 Nonce 锁管理器出现异常，可能导致交易重复发送或 Nonce 空洞。
    这是严重的系统异常，需立即介入。
  runbook: "立即暂停策略，检查 nonce_locks 表状态，手动核查链上 Nonce 序列"
```

---

### 4.4 `HighBroadcastFailureRate`

```yaml
alert: HighBroadcastFailureRate
expr: |
  rate(defi_fsm_state_transitions_total{to_state="FAILED"}[10m]) /
  rate(defi_fsm_state_transitions_total{from_state="SIGNED"}[10m]) > 0.1
for: 5m
labels:
  severity: warning
  group: fsm
annotations:
  summary: "广播失败率过高：过去 10 分钟失败率 {{ $value | humanizePercentage }}"
  description: |
    超过 10% 的交易从 SIGNED 推进至 FAILED，说明广播层存在系统性问题。
    可能是 Flashbots Relay 故障、公共 Mempool 拥堵，或 Gas 估算持续偏低。
```

---

## 5. 财务风控告警

### 5.1 `StrategyDrawdownAlert`

```yaml
alert: StrategyDrawdownAlert
expr: |
  defi_strategy_max_drawdown_pct{} >
  defi_strategy_backtest_mdd_pct{} * 1.5
for: 0s          # 立即触发
labels:
  severity: critical
  group: finance
annotations:
  summary: "策略 {{ $labels.strategy_id }} 实时回撤超过回测基准 1.5 倍"
  description: |
    实时最大回撤超过回测最大回撤的 1.5 倍，触发自动暂停（LIVE → PAUSED）。
    来源：PRD 评估指标体系 §4.1 预警机制。
  runbook: "查看策略 PnL 曲线和最近交易记录，判断是市场异常还是策略逻辑问题"
```

**自动响应：** 同步触发策略自动暂停（FSM 策略状态 LIVE → PAUSED），无需等待人工介入。

---

### 5.2 `ReconciliationFailure`

```yaml
alert: ReconciliationFailure
expr: |
  increase(defi_reconciliation_failures_total[5m]) > 0
for: 0s
labels:
  severity: critical
  group: finance
annotations:
  summary: "账实对账失败！账户：{{ $labels.account_id }}"
  description: |
    内部账本余额与链上实际余额出现差异（超过 1 wei）。
    这是零容忍事件，可能意味着 Transfer 事件未被索引到，或双分录逻辑存在 Bug。
    对应策略已自动暂停。
  runbook: "立即人工核查账本差异，对比 ledger_entries 与链上 Transfer 事件"
```

---

### 5.3 `ToxicFlowDetected`

```yaml
alert: ToxicFlowDetected
expr: |
  increase(defi_mev_toxic_flow_detections_total[30m]) >= 3
for: 0s
labels:
  severity: warning
  group: finance
annotations:
  summary: "策略 {{ $labels.strategy_id }} 连续 3 次检测到毒性流"
  description: |
    策略交易后价格持续逆向运动，疑似被知情套利者反向收割。
    连续 3 次触发后，系统已自动暂停该策略（见 §4.2）。
    AI 反馈飞轮（§6.4）将生成优化建议。
  runbook: "分析最近几笔交易的执行价 vs 后续价格走势，判断信号质量和执行路由"
```

---

## 6. 安全防御告警

### 6.1 `WhitelistViolationAlert`

```yaml
alert: WhitelistViolationAlert
expr: |
  increase(defi_security_whitelist_violations_total[1h]) > 3
for: 0s
labels:
  severity: critical
  group: security
annotations:
  summary: "单小时内白名单违规超过 3 次！Agent：{{ $labels.agent_id }}"
  description: |
    MPC Whitelist Proxy 在 1 小时内拦截超过 3 次针对非白名单地址的签名请求。
    高频白名单违规可能意味着 Zone A 遭受入侵，AI 策略代码被篡改。
    需立即隔离对应 Agent 容器，触发 Kill Switch 进入防御模式。
  runbook: "立即触发全局断路器（§5.3），检查 Zone A 容器完整性"
```

---

### 6.2 `ApprovalQueueBacklog`

```yaml
alert: ApprovalQueueBacklog
expr: |
  sum(defi_approval_pending_total) > 3
for: 5m
labels:
  severity: warning
  group: security
annotations:
  summary: "待审批交易积压：当前有 {{ $value }} 笔交易等待管理员确认"
  description: |
    待审批队列积压，可能因管理员未在线或审批流程存在问题。
    积压超过 30 分钟的交易将自动超时并标记为 FAILED。
  runbook: "检查 Admin Web Portal，处理待审批队列；若管理员无法登录，检查 Admin-Approval-API 状态"
```

---

### 6.3 `GovernanceCriticalAlert`

```yaml
alert: GovernanceCriticalAlert
expr: |
  defi_governance_risk_level{level="CRITICAL"} == 1
for: 0s
labels:
  severity: critical
  group: security
annotations:
  summary: "协议 {{ $labels.protocol_id }} 存在 CRITICAL 级治理风险"
  description: |
    治理哨兵（§5.2）捕获到协议紧急暂停/底层合约迁移等高危提案。
    相关协议已标记为 SUSPENDED，已暂停该协议的所有新发单。
    需评估是否执行紧急撤资。
  runbook: "查看治理哨兵日志，评估提案内容，决定是否触发 Kill Switch 撤资"
```

---

### 6.4 `MTLSAuthFailure`

```yaml
alert: MTLSAuthFailure
expr: |
  increase(defi_security_mtls_auth_failures_total[1h]) > 5
for: 0s
labels:
  severity: critical
  group: security
annotations:
  summary: "Zone B → Zone C mTLS 认证失败次数异常：{{ $value }} 次/小时"
  description: |
    Zone B 向 Zone C 发起的 mTLS 连接认证失败次数超过阈值。
    可能是证书即将过期、证书被意外替换，或存在中间人攻击尝试。
  runbook: "检查 Zone B 客户端证书有效期，对照 §1.3 证书管理规范检查轮换状态"
```

---

## 7. 系统性能告警

### 7.1 `HighEndToEndLatency`

```yaml
alert: HighEndToEndLatency
expr: |
  histogram_quantile(0.99,
    rate(defi_fsm_transition_duration_ms_bucket{transition="end_to_end"}[5m])
  ) > 500
for: 5m
labels:
  severity: warning
  group: performance
annotations:
  summary: "端到端 P99 延迟超过 500ms：当前 {{ $value }}ms"
  description: |
    从 AI 信号产生到 SIMULATED 状态的 P99 延迟持续超过 500ms 目标。
    按 §1.2 §6.2 的瓶颈排查顺序：Go-Execution-Engine CPU → Redis 内存 → PostgreSQL 锁等待 → RPC 响应时间。
```

---

### 7.2 `HighGasCostRatio`

```yaml
alert: HighGasCostRatio
expr: |
  sum by (strategy_id) (
    rate(defi_gas_cost_usdc_total[24h])
  ) /
  sum by (strategy_id) (
    rate(defi_gross_pnl_usdc_total[24h])
  ) > 0.3
for: 1h
labels:
  severity: warning
  group: performance
annotations:
  summary: "策略 {{ $labels.strategy_id }} Gas 成本占比过高：{{ $value | humanizePercentage }}"
  description: |
    Gas 成本占毛收益的比例超过 30%（来自 PRD 评估指标体系 G5 门控阈值）。
    对应 PRD 指标体系 §5.1 Gas 成本占比，长期超标意味着策略净收益严重受损。
  runbook: "检查策略执行频率，考虑增大单笔交易规模或降低发单频率"
```

---

## 8. 告警路由配置

```yaml
# alertmanager.yml
route:
  group_by: ['alertname', 'strategy_id']
  group_wait: 30s
  group_interval: 5m
  repeat_interval: 4h
  receiver: default-receiver

  routes:
    # CRITICAL 告警：立即通知，电话+即时通讯
    - match:
        severity: critical
      receiver: critical-oncall
      repeat_interval: 15m   # 15 分钟内未处理则重复

    # 安全类 CRITICAL：额外通知安全工程师
    - match:
        severity: critical
        group: security
      receiver: security-team
      continue: true          # 继续路由到 critical-oncall

receivers:
  - name: critical-oncall
    pagerduty_configs:
      - service_key: "<PAGERDUTY_KEY>"
    webhook_configs:
      - url: "https://hooks.slack.com/services/..."
        send_resolved: true

  - name: security-team
    email_configs:
      - to: "security@team.com"
    webhook_configs:
      - url: "https://hooks.slack.com/services/security-channel"
```

---

## 9. 告警阈值来源追溯

所有告警阈值均有明确来源，修改阈值须同时更新来源文档：

| 告警名 | 阈值 | 来源文档 | 章节 |
|---|---|---|---|
| `CriticalWatermarkLag` | > 2 blocks | PRD 数据基础设施规范 | §3.3 水位线熔断条件 |
| `OraclePriceSkew` | > 50 bps | PRD 评估指标体系 | §7 健康类指标 |
| `StrategyDrawdownAlert` | > 回测 MDD × 1.5 | PRD 评估指标体系 | §4.1 MDD 预警机制 |
| `ReconciliationFailure` | > 1 wei | PRD 评估指标体系 | §7 对账差异率零容忍 |
| `HighGasCostRatio` | > 30% | PRD 验证门控标准 | G5 Gas 成本占比阈值 |
| `FSMTaskStuck` | BROADCASTED > 5min | 架构文档 §3.3 | Recovery Manager 触发时间 |
| `ApprovalQueueBacklog` | > 3 笔积压 | 架构文档 §5.1 | 审批超时 30 分钟 |

---

*上一篇：[6.2 Prometheus 指标定义](./6.2_Prometheus指标定义.md) | 下一篇：[6.4 AI 反馈飞轮](./6.4_AI反馈飞轮.md)*
