
# 🚀 DeFi 自动化交易基建平台 - 机构级 PRD 3.0

## 零、 项目愿景与设计哲学 (Vision & Philosophy)

打造一个为**“多智能体（AI Agents）与人类量化研究员”**提供全生命周期支持的多链 DeFi 交易基础设施。
系统的核心目标是：**将策略迭代周期从数周压缩至数小时，并在极度黑暗的 Web3 森林中，通过极端的防呆工程与微观状态控制，确保百万级资金的绝对安全。**

**四大核心设计哲学：**
1. **AI Native 但零信任 (Zero-Trust AI)：** 拥抱 AI 生成策略，但在底层使用严格的强类型约束和沙盒隔离，彻底斩断 AI 幻觉带来的资金灾难。
2. **状态驱动而非价格驱动 (State-Driven)：** 彻底抛弃虚假的“K线回测”，所有验证和评估必须建立在微观 Tick 级真实流动性状态之上。
3. **确定性执行 (Deterministic Execution)：** 在异步的多链环境中，通过原子包、重组（Reorg）监控和分布式锁，消灭所有“中间失败状态”。
4. **工业级抗毁性 (Industrial Resiliency)：** 承认基础设施（RPC、L2、预言机）会随时崩溃，构建多层哨兵监控与全局物理级“断路器”。

---

## 一、 核心架构与功能模块划分 (Core Modules)

系统划分为五大支柱模块，涵盖从代码编写到实盘交易、再到系统自进化的全链路闭环。

### 模块 1：策略开发与多链适配引擎 (Development & Adapter Engine)
*目标：抹平多链与多协议的复杂性，提供防呆的策略编写环境。*

*   **1.1 强类型 AI 接口层 (Type-Safe Schema)：**
    *   所有 API 输入/输出必须通过 Pydantic/Zod 等 Schema 定义。
    *   **防呆拦截器：** SDK 底层自动校验并统一 `Wei/Ether` 等 Decimal 精度，校验地址格式，拦截 90% 以上的 AI 幻觉和“胖手指”。
*   **1.2 协议适配器注册表 (Protocol Adapter Registry)：**
    *   引入 Adapter 模式解耦底层协议（如 `Adapter.Swap(Uniswap_V3)`）。当协议升级（如切至 V4）时，只需更新全局 Adapter，千万个 AI 策略代码无需修改，保证**向前兼容性**。
*   **1.3 多链与统一账户抽象 (Chain-Agnostic Layer)：**
    *   构建全局统一资金池视图。SDK 提供高级的跨链原语（如 `bridge_and_execute()`），策略层无需关心资金分布在 Arbitrum 还是 Optimism。
*   **1.4 配置级 GitOps 版本控制：**
    *   策略逻辑代码与风控参数（如最大滑点、杠杆率）彻底分离，所有参数修改纳入 GitOps 流程，支持一键回滚。

### 模块 2：硬核沙盒与验证防线 (Hardcore Sandbox & Validation)
*目标：在碰触主网前，通过主动攻击与规则断言找出所有逻辑漏洞。*

*   **2.1 本地全节点交易预演 (Pre-Trade Simulation)：**
    *   任何一笔交易广播前，强制在本地 Fork 节点（如 Anvil）进行无损模拟计算。**不模拟通过，绝不发单。**
*   **2.2 不变性风控断言 (Invariant Checking)：**
    *   定义策略的物理底线。例如：“无论执行何种操作，账户 U 本位总资产跌幅不得超过 0.5%”。一旦模拟阶段打破不变性，交易在内存池被拦截。
*   **2.3 极端模糊测试与攻击演练 (Fuzzing & Economic Sandbox)：**
    *   **参数 Fuzzing：** 主动向测试环境注入极端条件（Gas 飙升 1000 倍、流动性抽干 90%），验证策略是安全退出还是陷入死循环。
    *   **攻击模拟：** 模拟预言机操纵、闪电贷攻击等剧本，验证策略的平仓逃生逻辑。
*   **2.4 容器化高并发沙盒集群：**
    *   支持动态调度 Docker 化的模拟环境，满足成百上千个 AI Agent 同时验证策略的需求。

### 模块 3：海量数据管道与全状态评估引擎 (Data ETL & State Evaluation)
*目标：提供最高置信度的实盘预演，绝不欺瞒交易员。*

*   **3.1 工业级数据清洗管道 (Data ETL Pipeline)：**
    *   建立从归档节点（Archive Node）提取 Tick 级事件的流式处理引擎（Stream Processing），防止内存溢出（OOM）。
    *   冷热数据分离：ClickHouse 存储海量历史 Tick 用于回测，Redis 存储当前毫秒级状态用于实盘比对。
*   **3.2 状态级高保真回测 (State-based Backtesting)：**
    *   重放真实的资金池深度变动，精准计算不同深度下的真实滑点、Gas 费损耗与 DEX 阶梯手续费。
*   **3.3 资金效率与蒙特卡洛模拟 (Monte Carlo Simulation)：**
    *   针对 LP 提供者和借贷策略，生成数万种极端价格路径，精准测算无常损失（IL）极值和连环清算概率。自动触发跨链库存调拨（Inventory Rebalancing）。

### 模块 4：确定性执行与“哨兵”监控模块 (Deterministic Execution & Sentinel)
*目标：在黑暗森林中抗击拥堵、重组与黑客，确保交易确定性。*

*   **4.1 哨兵预测性熔断系统 (Sentinel Service) [核心护城河]：**
    *   **L2 排序器监控：** 实时监听 L2 Sequencer 心跳。宕机瞬间触发链下熔断，切断发单。
    *   **预言机/重组监控：** 监控多源价格偏差及链上**区块重组（Reorg）**。若依赖的状态被 Reorg 抹除，立刻自动回滚链下记账并告警。
*   **4.2 分布式 Nonce 锁与原子包并发管理 (Concurrency & Atomic Bundles)：**
    *   **Nonce 锁：** 引入分布式锁管理同一钱包的 Nonce 发送队列，彻底解决多 Agent 并发导致的交易冲突死锁。
    *   **Flashbots 原子包：** 确保跨协议组合交易“要么全部成功，要么全部失败”，消灭中间卡壳状态，同时防范 MEV 三明治攻击。
*   **4.3 全局物理级“断路器” (Global Kill Switch & MPC)：**
    *   独立于所有业务逻辑外的高权限 Dashboard，一键全网撤销授权、抽离流动性。支持机构级 MPC 多方异步签名接入。

### 模块 5：全链路追踪与 AI 自进化飞轮 (Observability & AI Evolution)
*目标：系统极度可观测，并将实盘损耗转化为 AI 的迭代养料。*

*   **5.1 交易全生命周期追踪 (Distributed Tracing)：**
    *   为每笔交易生成唯一 `Trace_ID`，打通“AI Prompt -> 代码生成 -> 沙盒模拟 -> 链上打包 -> 对账分析”的完整调用链，快速定位线上 Bug。
*   **5.2 深度微观归因分析 (Post-Trade Attribution)：**
    *   交易完成后，自动比对：“预期滑点 vs 实际滑点”、“预期 Gas vs 实际 Gas”、“预期路由 vs 实际路由”。
*   **5.3 AI 反馈闭环 (AI Feedback Loop)：**
    *   将归因报告格式化喂给 AI Agent，强制 AI 自我修正：“由于你上次未考虑某池子的 tick 拥挤度，导致实际滑点偏高 1%，请修改你的路由算法”。

---

## 二、 工业化极端状况应对矩阵 (Industrial Edge Case Matrix)

| 触发场景 (Scenario) | 基础设施应对机制 (System Reaction) | 涉及模块 |
| :--- | :--- | :--- |
| **AI 错将 USDC 按 18 位精度发单** | **强类型拦截：** Schema 校验识别单位异常，阻断代码生成，打回给 AI 重写。 | 1.1 接口层 |
| **3个 AI Agent 同时向单一主钱包发单** | **分布式锁生效：** 系统接管队列，依序分配 Nonce；若估算 Gas 冲突则合并或打回排队。 | 4.2 执行层 |
| **网络发生 5 个区块的深度重组 (Reorg)** | **哨兵修正：** 侦测到状态变更，清退这 5 个区块内记录的本地假利润，重置策略的最新状态上下文。 | 4.1 哨兵监控 |
| **Arbitrum 突然宕机或 RPC 被限流** | **智能降级：** 哨兵切断新开仓请求；RPC Proxy 自动切换备用节点并开启慢速心跳探测。 | 4.1 / 4.2 |
| **执行策略发现预期收益已被夹子套利 (MEV)** | **防夹保护：** Flashbots/Private Mempool 隐匿交易；若强制滑点被击穿，交易自动失效（Revert）保护本金。 | 2.1 / 4.2 |
| **系统突发恶性 Bug 导致持续错误建仓** | **双重防线：** 不变性断言（资产跌幅超过设定阈值）自动终止策略；管理员可按下**全局 Kill Switch** 一键撤资。 | 2.2 / 4.3 |

---

## 三、 研发落地路线图 (Phased Implementation Roadmap)

**不要试图在一个迭代周期内构建全部，采用渐进式架构铺设：**

### Phase 1: 防呆开发基建与确定性执行 (The Deterministic Core)
*   **重点：** 确保单链环境下“能写出不出错的代码”且“能安全地发出去”。
*   **建设：** 强类型 SDK（Pydantic）、Adapter 协议字典、本地 Anvil 模拟拦截器、分布式 Nonce 队列管理。

### Phase 2: 全状态回测与数据引擎 (The Truth Engine)
*   **重点：** 搭建海量数据清洗与存储架构，让评估结果拥有绝对置信度。
*   **建设：** 搭建冷热分离的 ClickHouse/Redis 数据管道，跑通基于真实 Tick 状态的流式回测引擎，放弃一切 K 线指标系统。

### Phase 3: 哨兵监控与工业抗毁性 (The Sentinel & Sandbox)
*   **重点：** 系统具备感知黑暗森林风险的能力，以及防御黑天鹅的底线。
*   **建设：** 部署 L2 Sequencer/Reorg 监控哨兵，开发高并发 Fuzzing 模糊测试集群，上线全局 Kill Switch 大屏。

### Phase 4: AI 闭环与自主运营 (The Autonomous Flywheel)
*   **重点：** 实现完全无人值守的机构级自适应量化平台。
*   **建设：** 引入全链路 `Trace_ID` 追踪，实现交易后的微观归因对账单生成，打通 AI Agent 根据对账单自动修改代码的反馈飞轮。

