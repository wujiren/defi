# 🚀 DeFi 自动化交易基础设施平台 - PRD 2.0 (机构级)

## 一、 项目愿景与核心目标
打造一个对“人类与AI”均友好的**多链 DeFi 策略研发与全生命周期管理基建**。将策略从“灵感 -> 代码 -> 验证 -> 实盘 -> 归因进化”的周期缩短至几小时，并通过**极端防呆设计（Fail-safe）**与**微观状态模拟**，确保每一行代码、每一笔资金池的绝对安全。

### 核心设计哲学：
1. **AI Native 但不盲目信任：** 通过严格的类型约束（Type-Safe），彻底消灭 AI 产生幻觉导致的基础错误（如单位换算、地址错误）。
2. **抛弃 K 线，拥抱状态：** 所有的回测和评估必须基于链上微观流动性（Tick-level State），而非误导性的价格 K 线。
3. **闭环自进化：** 交易结束不是终点，自动生成归因报告并反哺给 AI，实现策略的自适应优化。

---

## 二、 核心功能模块划分 (五大支柱)

### 模块1：策略开发与多链抽象引擎 (Development & Agnostic Engine)
*目标：极简开发，抹平底层复杂性，让 AI 懂 DeFi，让跨链像单链一样简单。*

*   **1.1 强类型 AI 接口层 (Type-Safe Schema)：**
    *   强制使用 Pydantic/Zod 等 Schema 定义策略参数和输出。
    *   **防呆拦截：** 底层 SDK 自动处理 `Wei` 与 `Ether` 的 Decimal 精度转换，校验所有传入的合约地址格式，拦截 50% 以上的 AI 幻觉和人类“胖手指”错误。
*   **1.2 多链与统一账户抽象 (Chain-Agnostic Layer)：**
    *   构建“统一资金池视图”，策略无需关心资金在 Arbitrum 还是 Base，只关注全局购买力。
    *   提供标准化原语：`swap()`, `add_liquidity()`, `borrow()`，以及高级的跨链原语 `bridge_and_execute()`。
*   **1.3 配置级 GitOps (Config Versioning)：**
    *   策略逻辑与运行参数（如最大滑点限制、杠杆率、单次动用资金上限）分离。
    *   所有参数修改必须有版本控制记录，支持一键回滚。

### 模块2：硬核安全验证与沙盒系统 (Hardcore Security & Sandboxing)
*目标：在策略触碰真实主网前，通过“主动攻击”找出所有致命漏洞。*

*   **2.1 交易预模拟与不变性断言 (Pre-Simulation & Invariants)：**
    *   所有交易广播前，强制在 Local Fork（如 Anvil）中模拟。
    *   **不变性校验（Invariant Checking）：** 无论执行什么动作，“账户总 U 本位价值跌幅不得超过设定阈值”，否则交易直接在内存池拦截。
*   **2.2 模糊测试引擎 (Fuzzing Environment)：**
    *   主动对策略进行参数级压力测试。例如系统自动生成极端场景：“LP 池深度突然抽干 90%”、“Gas 飙升 1000 倍”，观察策略是报错中断、死循环，还是安全退出。
*   **2.3 经济攻击模拟 (Economic Attack Sandbox)：**
    *   内置常见 DeFi 攻击剧本（如闪电贷操纵预言机价格、吸血鬼攻击巨量抽资），测试策略在协议遭遇危机时的应对逻辑。
*   **2.4 绝对隔离沙箱：** 策略仅拥有其被分配资金（Vault）的专属授权，从合约底层杜绝单一策略 Bug 掏空整个金库。

### 模块3：基于全状态的综合评估引擎 (State-Based Evaluation Engine)
*目标：最真实的盈亏预演，精准评估资金效率与极端风险。*

*   **3.1 状态级高保真回测 (State-based Backtesting)：**
    *   **摒弃传统 K 线回测。** 接入 Archive Node 数据，重放历史真实的 Tick 级流动性变动。
    *   精准计算 DeFi 真实摩擦：包含准确的动态 Gas 费、不同流动性深度下的真实滑点、DEX 手续费阶梯。
*   **3.2 资金效率与库存再平衡 (Capital Efficiency & Rebalancing)：**
    *   监控策略在不同协议/多链的资金利用率（APR 追踪）。
    *   当某处机会耗尽或借贷利率飙升至亏损临界点时，触发自动调拨预案。
*   **3.3 蒙特卡洛极端路径模拟：** 生成未来数万种可能的价格几何布朗运动路径，专项评估 LP 策略的**无常损失（IL）极值**和杠杆策略的**连环清算概率**。

### 模块4：稳定执行与“哨兵”监控模块 (Execution & Sentinel Sentinel)
*目标：在黑暗森林中稳健生存，先知先觉地躲避基础设施崩溃。*

*   **4.1 哨兵预测性熔断监控 (Sentinel Service) [核心护城河]：**
    *   **L2 排序器监控：** 实时监听 L2 Sequencer 心跳（出块状态）。若 L2 发生延迟或宕机，立刻触发链下熔断，暂停发单。
    *   **预言机心跳监控：** 监控 Chainlink 等预言机的更新频率与多源价格偏差。偏差过大时激活“防操纵护盾”，拒绝交易。
*   **4.2 智能路由与防夹 (Routing & MEV Protection)：**
    *   动态多 RPC 轮询，自动剔除落后或限流节点。
    *   强制集成 Flashbots / 私有 RPC，隐藏策略意图，防止三明治攻击。
*   **4.3 动态 Gas 与 Nonce 管理：** 自动处理 Pending 交易（加速或覆盖撤销），确保策略在剧烈波动时不被卡死。

### 模块5：深度归因分析与 AI 自进化模块 (Attribution & AI Evolution)
*目标：将每一次失败和损耗转化为下一次迭代的养料。*

*   **5.1 交易后深度对账单 (Post-Trade Attribution)：**
    *   每笔交易完成后自动生成微观报告，精准对比：**预期滑点 vs 实际滑点**、**预期 Gas vs 实际 Gas**、**应得代币 vs 实得代币**。
*   **5.2 AI 反馈飞轮 (Feedback Loop)：**
    *   将归因报告格式化为 Prompt，自动反馈给 AI 策略编写 Agent。
    *   *场景：* “你的策略执行成功，但实际滑点比预期高了 1.5%，导致利润降低 40%，因为你忽略了当时的池子深度。请在下一版策略中更新你的滑点计算公式并重新输出代码。”

---

## 三、 极端边缘状况与应对矩阵 (Edge Cases Fallback Matrix)

| 触发场景 (Scenario) | 基建应对机制 (System Reaction) | 介入层级 |
| :--- | :--- | :--- |
| **AI 输出 `amount=100` (误将 USDC 当作 18 位)** | **Schema 层拦截：** Pydantic 校验发现精度不匹配，拒绝进入模拟，打回给 AI 重写。 | SDK开发层 |
| **Arbitrum Sequencer 突然停止出块 5 分钟** | **哨兵层告警：** 触发熔断，挂起所有需发送至 ARB 的开仓指令，直到恢复正常。 | 监控层 |
| **目标池子遭遇闪电贷，流动性瞬间枯竭** | **模拟层拦截 / Fuzzing预案起效：** 交易发送前的 Local Fork 模拟发现 `min_amount_out` 无法满足，交易被取消，保护资金。 | 验证执行层 |
| **单边暴跌，RPC 极度拥堵，补仓交易卡在 Pending** | **动态 Gas 层介入：** Nonce 管理器侦测超时，自动以原 Gas 的 1.25 倍+ 重发交易（Speed up），直至打包。 | 底层执行层 |
| **由于未知 Bug，策略导致总资产缩水 3%** | **不变性断言触发 (Invariants)：** 沙箱环境检测到越过“单次运行资产下降不超过 1%”的底线，直接终止该策略实例并发送紧急警报。 | 验证/监控层 |

---

## 四、 实施路径与演进路线图 (Roadmap)

工程复杂度极高，建议采用**“自下而上，先安全后智能”**的敏捷演进策略：

### 阶段 1：高墙深院的单链 MVP (Focus: 安全与类型约束)
*   锁定单条活跃 L2（如 Arbitrum）。
*   搭建强类型的 Python/Rust SDK（引入 Pydantic 强制校验）。
*   实现基于 Anvil 的本地 Fork 交易预模拟机制（必须跑通：不模拟不发交易）。
*   实现基础的 RPC 路由和 Gas/Nonce 自动管理。

### 阶段 2：状态回测与哨兵监控 (Focus: 真实评估与防灾)
*   摒弃 K 线，引入基于历史 Tick 数据（The Graph/Envio 提取）的**状态级回测引擎**。
*   部署 **Sentinel Service**：实现对 L2 Sequencer 心跳和核心预言机价格的实时监控和熔断机制。
*   实现策略参数的 GitOps 配置管理。

### 阶段 3：多链扩展与极端测试 (Focus: 规模化与抗压)
*   引入统一账户模型，实现跨链（Cross-chain）的动作抽象库。
*   上线 **Fuzzing（模糊测试）引擎**，主动向策略注入流动性枯竭、价格闪崩等极端参数进行抗压测试。
*   实现蒙特卡洛模拟工具包。

### 阶段 4：AI 闭环与自动化调拨 (Focus: 无人值守与自进化)
*   上线**深度归因分析模块**，实现“预期 vs 实际”的对账。
*   打通 **AI 反馈飞轮**，让 AI 根据对账单自动修复和优化策略代码。
*   实现基于资金利用率的自动化跨链库存再平衡（Inventory Rebalancing）。