# 🏛️ DeFi 自动化交易与资管基础设施 - PRD 5.0 (终极机构版)

## 零、 顶层设计哲学 (The Philosophy)

打造一个**“多智能体（AI Agents）与人类协同”**的机构级 DeFi 资管中台。
系统核心使命：在充满对抗的链上环境中，通过**物理级隔离、金融级对账、确定性执行**，构建一个能够承载千万级美金的自动化交易堡垒。

**四大不可逾越的底线：**
1.  **零信任架构 (Zero-Trust)：** AI 仅负责“提议”，人类/代码负责“批准”。私钥永远不触网，永远不被 AI 读取。
2.  **账本即真理 (Ledger-First)：** 拒绝模糊的“大概盈亏”。引入 Mark-to-Market（公允价值）与双分录账本，确保每一分钱的去向都有据可查。
3.  **确定性执行 (Deterministic Execution)：** 承认网络不可靠。通过幂等重试、原子包与重组监控，消除“中间状态”。
4.  **权限宪法化 (Constitutional Governance)：** 管理员权限受限。核心参数修改必须经过时间锁（Timelock），杜绝“上帝之手”的误操作或作恶。

---

## 一、 六大支柱模块 (The 6 Pillars)

### 模块 1：策略大脑与协议适配 (Strategy & Abstraction)
*目标：抹平多链差异，约束 AI 幻觉，实现一次编写，到处运行。*

*   **1.1 强类型 AI Schema (Type-Safe Interface)：**
    *   **输入/输出约束：** 强制使用 Pydantic/Zod 定义策略参数。
    *   **防呆层：** SDK 底层自动处理 `Wei/Ether` 精度转换，校验合约地址 checksum，拦截 99% 的格式错误。
*   **1.2 协议适配器注册表 (Adapter Registry)：**
    *   **统一原语：** 提供 `Adapter.swap()`, `Adapter.add_liquidity()` 等标准接口。
    *   **版本解耦：** 底层协议升级（如 Uniswap V3 -> V4）时，仅需更新 Adapter，上层千万个 AI 策略无需修改代码，保障**向前兼容性**。
*   **1.3 治理风险感知哨兵 (Governance Sentinel)：**
    *   **提案监控：** 自动爬取 Snapshot/Tally 提案。
    *   **风险熔断：** 当持仓协议出现“修改清算阈值”、“增加协议费”等重大提案时，自动将相关策略标记为 Risk-Off，甚至提前平仓。

### 模块 2：硬核验证与沙盒防线 (Validation & Sandbox)
*目标：在碰触主网前，通过极限施压找出逻辑漏洞。*

*   **2.1 EVM 级全节点预演 (Pre-Trade Simulation)：**
    *   **无损模拟：** 交易广播前，强制在本地 Anvil/Fork 节点执行。**模拟失败或 Gas 超标，绝不发单。**
*   **2.2 不变性风控断言 (Invariant Checking)：**
    *   **物理底线：** 定义全局规则（如：“单次交易滑点不得 > 0.5%”、“U 本位净值回撤不得 > 1%”）。模拟阶段一旦触线，直接拦截。
*   **2.3 极端模糊测试 (Fuzzing) & 影子模式 (Shadow Mode)：**
    *   **压力测试：** 向策略注入“流动性枯竭”、“Gas 飙升 1000 倍”等极端参数，验证系统的异常处理能力。
    *   **影子交易：** 新策略上线初期，连接实时数据运行但不发单，验证其在“毒性流”环境下的真实表现。

### 模块 3：资金运营与跨链调度 (Treasury & Execution) [核心增强]
*目标：让资金时刻处于最高效的配置状态，并确保执行的确定性。*

*   **3.1 跨链库存再平衡 (Active Inventory Rebalancing)：**
    *   **水位监控：** 实时监控各链资金利用率（Capital Utilization Rate）。
    *   **自动调度：** 当 Chain A 利用率 > 90% 且 Chain B 闲置 > 50% 时，计算最优跨链路径（对比 Stargate/Across 的费率与时间），生成调度提案。
*   **3.2 智能路由与原子执行 (Smart Routing & Atomics)：**
    *   **多路 MEV 广播：** 集成 Flashbots, BloXroute 等私有中继，防夹（Sandwich Protection）。
    *   **原子包 (Atomic Bundle)：** 确保多步操作（如：跨链->换币->质押）要么全部成功，要么全部回滚，杜绝资金卡在中间状态。
*   **3.3 幂等状态机 (Idempotent FSM)：**
    *   **死局自愈：** 处理 Nonce 冲突、RPC 超时。支持阶梯式 Gas 加速（Speed up）和超时自动撤单（Cancel tx）。

### 模块 4：全口径财务会计引擎 (Full-Spectrum Accounting) [核心增强]
*目标：拒绝糊涂账，精准还原每一笔收益与损耗。*

*   **4.1 双分录与秒级对账 (Double-Entry Bookkeeping)：**
    *   每次链上交互，数据库同步生成借贷分录。
    *   **对账哨兵：** 每 10 个区块比对链下账本 vs 链上 `balanceOf`。误差超过 $10^{-6}$ 即触发熔断。
*   **4.2 公允价值估值 (Mark-to-Market, MtM)：**
    *   **多维计价：** 不仅记录代币数量，通过预言机实时计算 LP Token、LST (stETH) 的 U 本位价值。
    *   **影子资产识别：** 自动追踪未领取的奖励（Unclaimed Rewards），将其计入总资产，防止因“未变现收益”导致的风控误杀。
*   **4.3 软滑点与毒性流审计：**
    *   计算**市场冲击成本**。若发现策略频繁在毒性流（Toxic Flow）中被套利者反向收割，自动暂停该策略。

### 模块 5：系统治理与安全宪法 (Governance & Security) [核心增强]
*目标：防御外部黑客与内部作恶，确保系统控制权的绝对安全。*

*   **5.1 机构级 MPC 签名流 (MPC Signing)：**
    *   **私钥隔离：** AI 仅生成无签名的交易体。签名由 MPC 节点（如 Fireblocks/自建）根据白名单规则自动完成。
    *   **大额多签：** 超过阈值（如 $10k）的交易，自动挂起，等待人类管理员二次确认。
*   **5.2 管理员时间锁 (Admin Timelock)：**
    *   **配置宪法：** 修改核心风控参数（如最大滑点、白名单合约）的操作，必须经过 **24 小时时间锁**。
    *   **公示期：** 修改指令发出后进入倒计时，Guardian（冷钱包）有一票否决权，防止黑客夺权后瞬间修改规则。
*   **5.3 全局物理断路器 (Global Kill Switch)：**
    *   独立于业务逻辑的高权限 Dashboard。一键撤销所有 Token 授权（Revoke）、紧急抽离流动性（Emergency Withdraw）。

### 模块 6：全链路可观测与自进化 (Observability & Evolution)
*   **6.1 全局 Trace ID：** 打通“AI 提议 -> 模拟 -> 签名 -> 广播 -> 对账”全链路日志。
*   **6.2 AI 反馈飞轮：** 将归因报告（预期 vs 实际滑点）转化为 Prompt，强制 AI 优化下一版策略代码。

---

## 二、 工业化极端场景应对矩阵 (Resiliency Matrix)

| 场景分类 | 极端状况描述 | 系统的确定性响应 (Deterministic Resolution) | 涉及模块 |
| :--- | :--- | :--- | :--- |
| **资金效率** | **Arbitrum 机会涌现，但资金都在主网吃灰** | **库存再平衡：** 监测到 APR 差价，自动计算 Bridge 损耗，发起跨链调度提案，经 MPC 签名后执行资金搬运。 | 3.1 |
| **财务会计** | **策略持有大量 Curve LP，币价跌但手续费赚了很多** | **MtM 估值：** 系统识别到 LP 价值下降但 Unclaimed CRV 增加，综合计算后判定总资产为正收益，**不触发止损**。 | 4.2 |
| **安全风控** | **管理员私钥被盗，黑客试图修改最大滑点为 100%** | **时间锁拦截：** 修改指令进入 24h 倒计时。监控系统报警，团队使用冷钱包 Guardian 否决该操作并冻结管理员账号。 | 5.2 |
| **网络异常** | **发单后 RPC 超时，且链上发生 5 区块重组** | **FSM + 重组监控：** 状态机检测到超时自动加速重发；哨兵检测到 Reorg，回滚本地记账，重置策略状态。 | 3.3 |
| **市场风险** | **Aave 提案将某抵押品 LTV 从 80% 降至 0%** | **治理哨兵：** 爬虫捕获提案，提前 48 小时预警，系统自动触发平仓或还款逻辑，避免连环清算。 | 1.3 |

---

## 三、 研发落地阶段规划 (Implementation Roadmap)

**Phase 1: 堡垒地基 (The Fortress Foundation)**
*   **核心交付：** MPC 签名集成、Anvil 本地模拟拦截器、强类型 SDK、双分录账本数据库。
*   **目标：** 确保资金安全，哪怕策略全是错的，钱也转不走。

**Phase 2: 真理之眼 (The Eye of Truth)**
*   **核心交付：** Mark-to-Market 估值引擎、复杂收益归因、Tick 级全状态回测系统。
*   **目标：** 确保账目精准，能够正确评估策略的真实盈亏。

**Phase 3: 自动化肢体 (The Automated Limbs)**
*   **核心交付：** 跨链库存再平衡、幂等状态机 (FSM)、智能路由与防夹。
*   **目标：** 实现资金的高效流转和执行的确定性。

**Phase 4: 治理与进化 (Governance & Evolution)**
*   **核心交付：** 管理员 Timelock、治理提案哨兵、AI 反馈闭环飞轮。
*   **目标：** 实现系统的抗审查性与自适应进化能力。
