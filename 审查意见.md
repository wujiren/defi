## 阶段 0

### 🔴 发现的错误与缺失（建议修正）

#### 1. 缺失：物理熔断的关键占位符 (Missing Parameters)

在 §0.6 **核心占位符清单**中，虽然列出了 `max_slippage_bps`，但缺失了**模块 4.1 (Sync Sentinel)** 中最重要的物理熔断参数。

* **建议补全**：
* `data_watermark_max_lag`：默认值 `2`（区块）。
* `price_deviation_threshold_bps`：默认值 `50`（对应 0.5% 三源预言机偏离阈值）。



#### 2. 错误：G1-G8 门控名称与阶段对应关系 (Gating Alignment)

在 §0.5 **验证门控对照表**中，存在两处细微的不一致：

* **G5 (Flow Audit)**：在之前的文档（模块 9）中，G5 属于“预演期（Staging）”，但在 `README.md` 表格中被归类到了“测试期”。
* **G7 (Gov Sentinel)**：在模块 9 中属于“上线期”，在 `README.md` 中被归类到了“预演期”。
* **修正建议**：请核对 PRD，确保阶段划分严格一致（通常 G5 深度审计是进入实盘 Staging 的门槛）。

#### 3. 缺失：Trace ID 的标准格式定义

§0.7 术语表中提到了 **全链路追踪 (Trace ID)**，但没有定义其物理格式。

* **建议增加**：在备注中注明“强制使用 `UUID v4` 格式”，以保持与 `全链路 Trace ID 日志规范` 文档的同步。

#### 4. 技术术语细微错误

在“财务与会计术语”表中：

* **已实现收益**：描述为“交易 CONFIRMED 后写入...”，建议改为“交易 CONFIRMED 并经过 Indexer 确认后...”，因为链上确认到数据库账本写入存在轻微延迟，需强调“最终性”。

---

## 阶段 1

### 🔴 发现的潜在问题与改进建议

#### 1. 1.1 文档：缺失“状态机持久化”的物理存放说明

* **观察**：在 `1.1` 的 Zone B 组件中提到了 PostgreSQL 和 Redis，但未明确说明在多机房或跨可用区（AZ）部署时，FSM 的强一致性如何保证。
* **建议**：在 §3.2 组件列表中补充说明：“PostgreSQL 建议采用主从高可用部署（Sync Replication），确保在 Zone B 内部节点故障时 FSM 状态不丢失。”

#### 2. 1.2 文档：缺少“Anvil 仿真节点”的并发规格限制

* **观察**：`1.2` 给予了 Anvil 节点 2.0 Core 和 4 GB 内存，并使用 `tmpfs`。这对于单次仿真足够，但如果有 50 个 Agent 同时发起提议，可能会导致性能瓶颈。
* **建议**：在 §3 资源限制中增加一行：“并发仿真配额：单台 Anvil 节点建议承载不超过 X 个并发仿真任务，超过需水平扩容。”

#### 3. 1.3 文档：Trace ID 丢弃策略的实现位置不明确

* **观察**：文档提到“无标记请求在网关层拒绝”，但未指明是哪个网关。
* **建议**：明确定义 Zone B 的入站网关职责。例如在 §2.2 中补充：“所有进入 Zone B 的 gRPC 请求必须由 **Go-Core-Engine 的拦截器 (Interceptor)** 强制校验 Trace ID。若缺失或格式错误，直接丢弃且不计入审计日志，防止日志泛滥攻击。”

#### 4. 命名一致性微调 (Consistency)

* 在 `1.1` 中提到了“影子模式（G6）”，而在 `README.md` 的审查中我们讨论过门控命名的对齐。请确保此处引用的 G1-G8 序号与即将重构的 `7.2_G1-G8门控对齐.md` 保持绝对同步。

---

## 阶段 2
### 🔴 发现的细微漏洞与改进建议

#### 1. 2.1 文档：缺失“影子模式”在协议层的显式标记

* **观察**：在 `trading.proto` 的 `TradeRequest` 定义中，虽然提到了 Adapter 模式，但未在代码片段中看到 `bool is_shadow` 或 `ExecutionMode` 字段。
* **风险**：如果协议层不强制携带此标记，Zone B 的 FSM 可能无法在接收请求的第一时间识别该交易是否应在 G8 关卡前物理截断，容易导致误操作风险。
* **建议**：在 `TradeRequest` 中增加 `bool is_shadow = 7;` 字段，并在注释中强调其作为“物理保险丝”的作用。

#### 2. 2.2 文档：消费者组命名规范的缺失

* **观察**：文档提到“为每个 Agent 分配唯一的 Group ID”，但未定义命名格式。
* **建议**：在 §2.2 增加命名规范建议，例如 `cg_{zone}_{agent_id}_{version}`，这对于多版本并行测试（A/B Testing）时的 Offset 管理至关重要。

#### 3. 2.3 文档：多链 Gas 估算的“锚点价格”时效性

* **观察**：在 §6 代码示例中，计算 Gas 使用的是确认时的 ETH 价格。
* **风险**：对于 L2（如 Base）而言，Gas 成本包含 L1 Data Fee。在极端波动下，确认时的价格可能与提议时差异巨大。
* **建议**：补充说明“计算 Realized PnL 时，必须同时记录提议时和确认时的双重 Gas 价格，以审计 AI 的滑点预估精度”。

#### 4. 2.4 文档：ClickHouse 索引的“毒性”覆盖

* **观察**：目前的索引层仅覆盖了 `protocol_id` 和 `block`。
* **建议**：为了支持模块 6 要求的“毒性流分析（Toxic Flow）”，建议在归档元数据中增加 `tx_type` 索引，以便快速筛选出导致大额滑点或 Revert 的特定历史交易样本。

---


## 阶段 3

### 🔍 细微改进建议 (Peer Review)

虽然整体结构非常稳健，但在细节实现上，我有几点建议可以进一步提升系统健壮性：

* **水位线拦截（3.1）：** 在 `StaleDataError` 发生时，建议在 Python 基类中增加一个“退避（Backoff）”策略。如果连续多次拦截，应主动暂停推理，防止无效 gRPC 请求占满 Zone B 的连接池。
* **预言机阈值（3.2）：** 交叉校验公式使用两两绝对差值的最大值：

$$\max(|P_1 - P_2|, |P_2 - P_3|, |P_1 - P_3|) > \Delta$$



这个公式极其严格。建议在配置中心为不同波动的代币（如 ETH vs. 模因币）设置**阶梯式 $\Delta$**，否则在高波动时期可能会引发误杀熔断。
* **FSM 状态锁（3.3）：** 建议在 `trade_tasks` 表上明确声明**行级乐观锁（Version 或 UpdatedAt）**，防止 `Recovery Manager` 和 `FSM Worker` 在极端高并发下同时操作同一笔订单（尽管 Go 端已有 Nonce 锁，但 DB 层的双重防护更稳）。

---

## 阶段 4


## 阶段 5

## 阶段 6
