# DeFi 自动化交易基础设施

> **数据基础设施规范**  
> *Data Infrastructure Specification*  
> PRD 附属文档 · 版本 1.0 · 2026

---

## 一、文档目的
本文档定义 DeFi 自动化交易基础设施中所有数据层的规范，包括数据的获取、存储、清洗、版本管理和访问接口。

数据层是整个系统的基石，策略评估、风控熔断、对账核查均依赖高质量、可复现的数据。本规范解决三个核心问题：

- **一致性：** 回测、影子模式、实盘使用完全相同的数据访问接口，策略代码无需感知数据来源差异

- **可复现性：** 任意历史时间点的数据快照可被精确重建，确保验证结果可审计

- **新鲜度保障：** 实盘决策使用的数据必须满足水位线要求，过期数据自动触发熔断

## 二、数据分层架构
系统数据按来源和用途分为四层，每层有明确的职责边界：

| **层级** | **名称**   | **数据内容**                                      | **主要消费方**                      |
|----------|------------|---------------------------------------------------|-------------------------------------|
| **L1**   | 链上原始层 | 区块头、交易收据、事件日志（Event Log）、合约状态 | 索引器、对账模块                    |
| **L2**   | 协议解析层 | DEX 价格/流动性 Tick、借贷协议 LTV、收益率曲线    | 策略决策引擎、预言机校验            |
| **L3**   | 聚合计算层 | OHLCV 聚合、TWAP、波动率序列、资金利用率快照      | 回测引擎、蒙特卡洛模拟              |
| **L4**   | 业务语义层 | 策略 PnL 序列、对账记录、Gas 消耗统计、验证报告   | 评估系统、AI 反馈飞轮、管理员仪表盘 |

**核心原则：** 上层数据由下层数据派生，任何 L3/L4 数据均可从 L1 原始数据完整重建。L1 数据是系统的唯一真相来源（Single Source of Truth）。

## 三、链上数据获取规范
### 3.1 RPC 节点管理
所有链上数据获取必须通过 SDK 统一的 RPC 管理层，禁止策略代码直接调用 RPC。

| **规范项** | **要求**                                 | **说明**                                    |
|------------|------------------------------------------|---------------------------------------------|
| 节点冗余   | 每条链至少配置 3 个 RPC 节点             | 主节点故障时自动切换，保障连续性            |
| 节点类型   | 至少 1 个自建/专用节点 + 公共节点兜底    | 自建节点优先，降低对第三方服务的依赖        |
| 同步检测   | 每次调用前检查 eth_blockNumber 是否最新  | 落后 >2 个区块则标记为 StaleNode，切换节点 |
| 请求限速   | 遵循各节点的速率限制，SDK 内置退避重试   | 避免被封禁导致数据中断                      |
| 归档节点   | 回测专用归档节点（Archive Node）独立配置 | 普通节点不保存历史状态，无法支持回测        |
| 链上读取   | 所有 eth_call 必须指定 block_number      | 禁止使用 latest 标签，防止重放不一致        |

### 3.2 事件日志（Event Log）索引
链上事件是协议解析层（L2）数据的核心来源，必须通过索引器持续同步。

| **索引对象**              | **关键事件**                                | **同步延迟要求**            |
|---------------------------|---------------------------------------------|-----------------------------|
| Uniswap V3/V4 池          | Swap、Mint、Burn、Collect、Flash            | ≤ 1 个区块                  |
| 借贷协议（Aave/Compound） | Deposit、Borrow、Repay、Liquidate           | ≤ 2 个区块                  |
| 代币合约                  | Transfer（策略相关地址）                    | ≤ 1 个区块                  |
| 策略合约                  | 全部自定义事件                              | ≤ 1 个区块（实时监控）      |
| 治理合约                  | ProposalCreated、VoteCast、ProposalExecuted | ≤ 10 个区块（允许轻微延迟） |

**索引工具选择：** 优先自建轻量索引器（基于 ethers.js 事件过滤），仅在需要复杂查询时引入 The Graph / Subgraph。自建索引器的数据须存入本地数据库，不依赖外部 API 的实时可用性。

### 3.3 数据水位线（High Watermark）机制
所有实盘决策必须强制通过水位线校验，确保基于最新链上状态做出判断。

| **校验字段**      | **获取方式**           | **熔断条件**                     | **触发动作**                  |
|-------------------|------------------------|----------------------------------|-------------------------------|
| last_sync_block   | 索引器写入，每区块更新 | CurrentBlock - SyncBlock > 2    | 抛出 StaleDataError，停止发单 |
| last_price_update | 预言机模块写入         | 数据时间戳 > 30 秒              | 标记价格为 Stale，拒绝使用    |
| last_balance_sync | 余额扫描模块写入       | CurrentBlock - BalanceBlock > 5 | 触发余额重新同步，暂停交易    |
| rpc_node_block    | 每次 RPC 调用前检测    | 落后主节点 > 2 个区块           | 自动切换至备用 RPC 节点       |

## 四、历史数据规范（回测专用）
### 4.1 数据精度要求
回测数据的精度决定了回测结果与实盘的接近程度，必须使用交易级别数据而非聚合 OHLCV 数据。

| **数据类型** | **最低精度要求**                            | **禁止使用**     | **说明**                       |
|--------------|---------------------------------------------|------------------|--------------------------------|
| 价格数据     | 每笔 Swap 事件的精确成交价                  | 1分钟/小时 OHLCV | OHLCV 会掩盖价格跳动和滑点     |
| 流动性数据   | 每个 Mint/Burn 事件后的流动性快照           | 日均流动性       | 流动性在区块内会发生剧烈变化   |
| Gas 价格     | 每个区块的 baseFee + priorityFee 记录       | 月均 Gas 均值    | Gas 成本计算必须使用历史真实值 |
| 链上延迟     | 每笔交易的 blockTimestamp - submitTimestamp | 固定延迟假设     | 实际延迟在网络拥堵时会剧烈波动 |

### 4.2 历史数据存储规范
| **规范项**     | **要求**                                               |
|----------------|--------------------------------------------------------|
| 存储格式       | Parquet 列式存储，按链 + 协议 + 日期三级分区           |
| 压缩方式       | Snappy 压缩，平衡读取速度和存储空间                    |
| 最小保留时长   | 全量历史数据永久保留（用于回测和审计）                 |
| 数据完整性校验 | 每日对历史数据运行区块哈希校验，检测数据篡改或损坏     |
| 冷热分层       | 近 90 天热数据（SSD）；90 天以上冷数据（HDD/对象存储） |
| 备份策略       | 每日全量快照备份，保留最近 30 个快照                   |

### 4.3 数据版本管理与可复现性
每次回测必须能在任意未来时间点被精确复现，这要求数据具备版本快照能力。

| **可复现要素** | **实现方式**                               | **校验方法**                   |
|----------------|--------------------------------------------|--------------------------------|
| 数据范围锁定   | 回测任务记录 start_block 和 end_block      | 重放时使用相同区块范围         |
| 数据版本哈希   | 对使用的数据集计算 SHA-256 哈希，写入报告  | 比对哈希确认数据未变更         |
| 协议参数快照   | 记录回测时各协议的手续费率、LTV 等参数版本 | 避免因协议升级导致历史参数变化 |
| 随机数种子     | Fuzzing 和蒙特卡洛的随机数种子写入报告     | 使用相同种子可精确复现模拟结果 |
| SDK 版本锁定   | 回测报告记录 SDK 版本号和 EVM 数学库版本   | 版本不同时给出差异警告         |

## 五、实时数据流规范（实盘专用）
### 5.1 数据流架构
实盘决策依赖低延迟的实时数据推送，采用发布-订阅模型，与历史数据存储解耦：

| **数据流类型** | **推送频率**                | **最大延迟容忍** | **消费方**                   |
|----------------|-----------------------------|------------------|------------------------------|
| 新区块通知     | 每个新区块                  | 500ms            | 水位线校验、FSM 状态更新     |
| 池子价格变动   | 每笔 Swap 事件              | 1 个区块         | 三源预言机校验、策略决策引擎 |
| 账户余额变动   | 策略相关地址的每笔 Transfer | 1 个区块         | 对账模块、风控断言           |
| Gas 价格更新   | 每个区块的 baseFee          | 1 个区块         | Gas 估算模块、FSM 执行层     |
| 治理事件       | 治理合约事件                | 10 个区块        | 治理哨兵模块                 |

### 5.2 预言机数据规范
三源预言机（Chainlink、Uniswap TWAP、DEX Slot0）的数据获取和校验规范：

| **数据源**       | **获取方式**               | **刷新频率**                                     | **可信度说明**                       |
|------------------|----------------------------|--------------------------------------------------|--------------------------------------|
| Chainlink        | 链上合约 latestRoundData() | 按 Chainlink 心跳（通常 1 小时或偏差 0.5% 触发） | 抗操纵性最强，但更新频率较低         |
| Uniswap TWAP     | 观察区间 = 最近 30 分钟    | 每个区块重新计算                                 | 抗闪电贷攻击，但对快速价格变化响应慢 |
| DEX Slot0        | slot0() 直接读取当前价格   | 实时（每笔 Swap 后更新）                         | 最实时但易被闪电贷瞬间操纵           |
| 中位价（决策用） | 三源价格的中位数           | 三源中最慢的为准                                 | 用于策略决策，消除单源异常值         |

**熔断逻辑：** 当 max(|P1-P2|, |P2-P3|, |P1-P3|) > 0.5% 时，拒绝本次决策，记录熔断事件。熔断期间中位价不更新，防止基于失真价格下单。

## 六、统一数据访问接口（SDK DataAPI）
策略代码通过统一的 DataAPI 访问所有数据，不区分回测和实盘场景，SDK 在运行时自动路由至正确数据源：

### 6.1 核心接口
| **接口**                               | **返回内容**                       | **回测数据源**        | **实盘数据源**      |
|----------------------------------------|------------------------------------|-----------------------|---------------------|
| data.price(token_pair, block?)         | 三源价格 + 中位价 + 水位线状态     | 历史 Swap 事件重放    | 实时预言机聚合      |
| data.liquidity(pool, block?)           | 当前流动性深度 + Tick 分布         | 历史 Mint/Burn 重放   | 实时链上查询        |
| data.balance(address, token, block?)   | 指定地址的代币余额                 | 历史 Transfer 重放    | 实时链上查询        |
| data.gas_price(block?)                 | baseFee + 推荐 priorityFee         | 历史区块 baseFee 记录 | 实时区块数据        |
| data.pool_state(pool, block?)          | 池子完整状态（slot0 + tickBitmap） | 历史状态快照          | 实时合约读取        |
| data.events(contract, event, from, to) | 指定合约的事件日志                 | 本地索引查询          | 本地索引 + 实时补全 |

**设计核心：** block 参数可选。回测时必须传入 block_number 以获取历史状态；实盘时省略 block 参数，自动使用最新已确认区块。水位线校验对实盘调用自动触发，回测调用跳过此检查。

### 6.2 数据新鲜度标注
所有数据接口返回值都附带新鲜度元信息，策略代码可主动检查：

| **元信息字段** | **类型**       | **含义**                                   |
|----------------|----------------|--------------------------------------------|
| sync_block     | uint64         | 数据所对应的链上区块高度                   |
| sync_timestamp | unix timestamp | 数据同步到本地的时间戳                     |
| is_stale       | boolean        | 当前数据是否超过水位线阈值                 |
| source         | enum           | 数据来源：BACKTEST / REALTIME / CACHE      |
| confidence     | float \[0,1\]  | 三源预言机一致性得分，1.0 表示三源完全一致 |

## 七、数据质量与清洗规范
### 7.1 异常数据识别规则
| **异常类型**      | **识别方法**                                  | **处理方式**                       |
|-------------------|-----------------------------------------------|------------------------------------|
| 价格跳点          | 单区块价格变化超过 10%（非极端行情期间）      | 标记为可疑，触发三源交叉验证       |
| 缺失区块          | 区块序列中存在间隔（如 10001 直接跳到 10003） | 从备用 RPC 节点重新获取缺失区块    |
| 重复事件          | 相同 txHash + logIndex 出现多次               | 去重，保留第一条记录               |
| 链上重组（Reorg） | 某区块高度的区块哈希发生变化                  | 回滚受影响区块的全部数据，重新索引 |
| 时间戳异常        | 区块时间戳比前一区块小（矿工异常）            | 使用区块高度作为时间轴替代时间戳   |
| RPC 返回异常      | null 值 / 字段缺失 / 数值溢出                 | 拒绝写入，记录异常日志，触发重试   |

### 7.2 数据血缘追踪
每条 L3/L4 层数据必须能追溯到其来源的 L1 原始数据，实现完整的数据血缘：

- **交易记录：** 每条 PnL 记录关联对应的 txHash + logIndex

- **价格数据：** 每个 TWAP 值关联计算所用的原始 Swap 事件列表

- **对账记录：** 每条余额变动关联触发它的 Transfer 事件

- **验证报告：** 每份报告关联回测使用的数据集哈希（可精确复现）

## 八、多链数据统一规范
系统需同时处理多条链（如 Ethereum、Arbitrum、Base、Optimism）的数据，必须统一以下规范：

| **规范项**   | **统一标准**                                                 | **说明**                                         |
|--------------|--------------------------------------------------------------|--------------------------------------------------|
| 时间基准     | 所有时间轴统一使用 Ethereum 主网区块高度作为锚点             | 各 L2 区块速度不同，使用区块高度会导致时间轴混乱 |
| 代币标识     | 统一使用 canonical 地址（主网地址 + 链 ID）                  | 同一资产在不同链上地址不同，需统一映射           |
| 价格基准     | U 本位统一换算为 USDC（6 位小数）                            | 跨链比较时消除不同稳定币的微小价差影响           |
| 跨链资金在途 | 资金从 A 链发出到 B 链确认期间，在双链账本中均记录为「在途」 | 防止资金在途期间对账差异误报                     |
| Gas 统一计量 | 各链 Gas 统一折算为 USD（以执行时 ETH/链原生代币价格为准）   | 不同链的 Gas 单位不同，需统一为 USD 才可比较     |

## 九、文档版本记录
| **版本** | **日期**   | **变更内容**                             | **作者**      |
|----------|------------|------------------------------------------|---------------|
| v1.0     | 2026-02-25 | 初始版本，定义四层数据架构与全部访问规范 | DeFi 策略团队 |
