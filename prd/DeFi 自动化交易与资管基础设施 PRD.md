# DeFi 自动化交易基础设施

> **DeFi 自动化交易与资管基础设施 PRD**
> *Decentralized Finance Automated Trading Infrastructure — Product Requirements Document*
> 顶层需求文档 · 版本 5.1 · 2026

---

## 零、顶层设计哲学 (The Philosophy)

打造一个**"多智能体（AI Agents）与人类协同"**的机构级 DeFi 资管中台。系统核心使命：在充满对抗的链上环境中，通过**物理级隔离、金融级对账、确定性执行**，构建一个能够承载千万级美金的自动化交易堡垒。

---

### 📚 附属规范体系导航 (Documentation Map)

本 PRD 为顶层架构与业务总纲，为确保落地不发生变异，具体的执行参数与约束边界请严格参照以下 5 份附属规范：

1. **《策略生命周期定义说明文档》**：解决【流程合规】问题。定义了策略从 DRAFT 到 DEPRECATED 的 8 种状态，及灰度/实盘的审批差异。
2. **《验证门控标准说明文档》**：解决【准入硬门槛】问题。定义了 G1–G8 关卡的自动化测试标准（如 1000 次 Fuzzing、EVM 位级对齐）。
3. **《评估指标体系说明文档》**：解决【AI 如何打分】问题。定义了 25 个包含收益、风险（回撤）、成本（IL/MEV 损耗）的数学计算口径。
4. **《数据基础设施规范》**：解决【防范回测陷阱】问题。定义了 L1–L4 的数据分层、统一 DataAPI、以及用于实盘的水位线（High Watermark）防死锁机制。
5. **《非功能性量化指标说明文档》**：解决【物理级健壮性】问题。定义了快慢路径的延迟预算（P99 < 800ms）、SLA 以及与熔断绑定的分级告警机制。

> **开发原则：当主 PRD 的概念性描述与附属文档的数值阈值发生冲突时，以附属规范的量化定义为准。**

---

## 一、六大支柱模块 (The 6 Pillars)

### 模块 1：策略大脑与协议适配 (Strategy & Abstraction)

**1.1 强类型 AI Schema 与 EVM 仿真数学库**

**核心问题：** 链下策略代码与链上智能合约在数学计算上存在系统性差异——链上 Solidity 使用整数除法、固定的溢出行为和特定的舍入方向，而链下 Python/JavaScript 默认使用浮点数运算。这一差异会导致回测结果与实盘存在不可预测的偏差，轻则影响收益估算准确性，重则导致回测显示盈利而实盘亏损的"回测陷阱"。

**需求目标：** SDK 的数学计算模块必须消除上述差异，确保：
- 策略开发者编写的任何数值计算，其结果与相同逻辑部署到链上后的执行结果完全一致
- 回测阶段的收益/损耗估算与实盘误差控制在可接受范围内（见评估指标体系文档）
- AI Agent 生成的策略参数在链下验证通过后，无需人工二次校验数学逻辑的正确性

**验收标准：** 数学库的验收由验证门控 G2（EVM 仿真精度关卡）负责，具体测试场景和通过阈值见《验证门控标准》文档第三章。

* **1.2 协议适配器注册表 (Adapter Registry)：** 解耦底层协议逻辑（如 Uniswap V3/V4）。底层合约升级时，仅需更新全局 Adapter，千万个 AI 策略无需改动代码。
* **1.3 治理风险感知哨兵 (Governance Sentinel)：** 自动爬取 Snapshot/Tally 提案。当持仓协议出现"修改 LTV"或"增加手续费"等重大变动时，自动熔断相关策略。

---

### 模块 2：硬核验证与沙盒防线 (Validation & Sandbox)

* **2.1 三源预言机交叉校验 (Triple-Oracle Guard)：**
  * **校验逻辑：** 任何决策执行前，必须对比三个独立源的价格：$P_{Chainlink}$、$P_{Uniswap\_TWAP}$、$P_{DEX\_Slot0}$。
  * **熔断条件：** 设 $\Delta$ 为偏离阈值（默认 **0.5%**），若满足以下公式则拦截交易：
$$\max(|P_1 - P_2|, |P_2 - P_3|, |P_1 - P_3|) > \Delta$$

* **2.2 不变性风控断言 (Invariant Checking)：** 定义物理底线（如："单次执行后 U 本位跌幅不得超 **1%**"），模拟破线直接拦截。

* **2.3 极端模糊测试 (Fuzzing) & 影子模式 (Shadow Mode)：** 主动注入极端参数（如 Gas 飙升 **1000** 倍）。新策略需经过"影子模式"实盘压力测试（只跑逻辑不发单）。

  策略从草稿到获得实盘发单授权，必须严格遵循单向状态流转，不得跳过任何准入环节。关于各状态的定义与流转条件，请参阅**《策略生命周期定义说明文档》**；关于静态分析、Fuzzing、影子模式的硬性通过阈值（如 1000 轮 Fuzzing 零破线、影子模式最短持续时长），请参阅**《验证门控标准说明文档》- G1 至 G8 关卡规范**。

---

### 模块 3：资金运营与确定性执行 (Treasury & Execution)

* **3.1 幂等状态机 (Idempotent FSM)：**
  * **自愈逻辑：** 引入交易生命周期管理器。处理"已发单但无 Hash"、"Nonce 冲突"、"RPC 超时"等异常。
  * **状态流转：** `INIT -> SIMULATED -> SIGNED -> BROADCASTED -> CONFIRMED/REORG`
  * **工程目标：** FSM 的核心设计目标是在混沌环境下（节点重启、网络中断、进程崩溃）避免重复发单与资金损失。其抗崩溃验收标准（含混沌工程测试场景与通过阈值），严格参照**《非功能性量化指标说明文档》- 交易幂等性指标**章节。

* **3.2 智能路由与原子执行 (Smart Routing & Atomics)：** 集成 Flashbots 等私有中继防夹。确保多步操作（跨链->换币->质押）要么全成，要么全败。
* **3.3 跨链库存再平衡 (Active Inventory Rebalancing)：** 自动监控各链资金利用率。当 Chain A 缺钱而 Chain B 闲置时，自动触发最优路径的资金调度。

---

### 模块 4：财务会计与数据水位线 (Accounting & Data)

* **4.1 双分录对账与公允价值 (MtM)：** 数据库同步生成借贷分录。自动追踪未领取的奖励（Unclaimed Rewards），防止因账面"未变现收益"导致的风控误杀。

* **4.2 数据水位线监控 (High Watermark)：**
  * **同步校验：** 任何发单决策必须强制校验数据源的 `last_sync_block`。
  * **熔断逻辑：** 若 $\text{CurrentBlock} - \text{SyncBlock} > 2$，系统立即抛出 `StaleDataError` 并停止发单，防止基于过时状态决策。
  * **告警联动：** 水位线熔断会导致系统物理停止发单，属于高优先级静默盲区风险。为防止熔断在无人感知的情况下持续生效，告警系统的触发时序须与熔断严格对齐，分级告警机制（包括触发条件、通知渠道与响应 SLA）详见**《非功能性量化指标说明文档》- 监控告警规范**章节。底层链上数据的抓取与版本快照机制，参阅**《数据基础设施规范》**。

* **4.3 软滑点与毒性流审计：** 计算市场冲击成本。若发现被套利者反向收割，自动暂停该策略。

---

### 模块 5：系统治理与安全宪法 (Governance & Security)

* **5.1 机构级 MPC 签名流 (MPC Signing)：**
  * AI 策略仅生成无签名的 Payload，签名由独立的 MPC 节点根据白名单规则自动完成。
  * **大额多签：** 当单笔交易金额超过大额审批阈值时，交易自动挂起，进入人工审批队列，须等待管理员二次确认后方可签名执行。大额审批阈值采用与策略所处生命周期阶段挂钩的差异化控制机制：预上线阶段（STAGED）与正式生产阶段（LIVE）的阈值逻辑不同，具体定义以**《策略生命周期定义说明文档》**中的对应章节为准。

  > ⚠️ **待评审参数：大额审批阈值**
  > 当前占位值：$10,000（绝对金额，仅作初期参考）
  > 需在项目启动评审会上，结合以下因素确认最终值：预期单笔交易规模中位数、策略所处生命周期阶段（STAGED vs LIVE）、团队审批响应能力（审批人时区覆盖）、可接受的审批等待延迟上限。
  > 确认后填入系统配置中心，本文档与《策略生命周期定义说明文档》同步更新。

* **5.2 管理员时间锁 (Admin Timelock)：**
  * 时间锁的管控边界须明确：其作用范围是**全局核心风控参数**的链上修改（如全局最大滑点阈值、合约白名单的增删），修改须经过等待期后方可生效。Guardian 钱包拥有"一票否决权"，可在等待期内取消任何变更。
  * **注意：** 策略状态流转（如上线审批、资金调拨触发）属于链下业务管控流程，**不经过 24h 时间锁**，其控制权边界与审批规则由**《策略生命周期定义说明文档》**定义。

  > ⚠️ **待评审参数：时间锁等待时长**
  > 当前占位值：24 小时
  > 需在项目启动评审会上，结合以下因素确认最终值：团队成员时区分布（需保证所有核心成员有足够时间审查变更）、紧急参数调整的业务需求（是否需要快速通道）、是否参考行业主流实践（如 Compound 使用 48 小时）。
  > 确认后同步更新链上时间锁合约的初始化参数。

* **5.3 全局物理断路器 (Global Kill Switch)：** 一键撤销所有 Token 授权（Revoke）、紧急抽离流动性。

---

### 模块 6：全链路可观测 (Observability)

* **6.1 全局 Trace ID：** 打通"AI 提议 -> 模拟 -> 签名 -> 广播 -> 确认 -> 对账"全链路日志。
* **6.2 AI 反馈飞轮：** 自动将实际盈亏损耗转化为 Prompt，强制 AI 迭代优化。飞轮优化的核心打分依据来源于多维度量化指标的综合评判（包含 Sharpe、最大回撤、无常损失 IL、MEV 损耗等），详细打分公式和权重见**《评估指标体系说明文档》**；已退役策略的归档与语料转化流程，见**《策略生命周期定义说明文档》- DEPRECATED 状态**。

---

## 二、工业化极端场景处理矩阵 (Resiliency Matrix)

| **场景分类** | **极端状况描述** | **系统的确定性响应 (Deterministic Resolution)** |
| --- | --- | --- |
| **数据风险** | RPC 节点同步延迟，AI 以为价格还没涨 | **水位线拦截：** 模块 4.2 检测到 `SyncBlock` 落后，拒绝发单 |
| **价格风险** | 目标池被闪电贷攻击，Slot0 价格瞬间暴跌 | **三源校验：** 模块 2.1 发现 Slot0 与 Chainlink 偏差超 **0.5%**，拦截模拟 |
| **网络风险** | 发单后断网，不知交易是否在链上排队 | **FSM 自愈：** 重启后 FSM 读取 `BROADCASTED` 状态，自动查询链上 Nonce。若卡住则触发阶梯 Gas 加速 |
| **治理风险** | 底层协议宣布要升级合约并迁移流动性 | **治理哨兵：** 爬虫捕获提案，提前标记该协议为"待清理"，AI 提前撤资 |
| **计算风险** | 回测由于精度舍入，认为赚了 1U，实盘亏了 1U | **位对齐数学库：** 模块 1.1 强制链下模拟 Solidity 舍入逻辑，消除回测误差 |

---

## 三、研发落地阶段规划 (Implementation Roadmap)

**说明：** 以下时间估算基于 [待填写：团队规模] 人投入，各阶段时长为参考值，须在项目启动会上结合实际资源确认。各阶段里程碑中涉及的具体测试用例、数值阈值与通过标准，均以**《验证门控标准说明文档》**中对应关卡（G1–G8）的定义为最终依据。

---

### Phase 1：安全地基（参考工期：6–8 周）

**核心交付物：** MPC 签名机、Anvil 本地仿真环境、EVM 数学库、基础 DataAPI 框架。

**里程碑验收标准（全部满足方可进入 Phase 2）：**
- MPC 签名机完成单元测试，可正确处理无签名 Payload 并返回签名结果
- Anvil 环境可对指定历史区块进行分叉，EVM 数学库通过**《验证门控标准说明文档》G2 精度关卡**的全部测试用例
- DataAPI 可对接至少 1 条链的实时 RPC，水位线校验逻辑可触发 StaleDataError

**主要负责角色：** 基础设施工程师（MPC + Anvil）、SDK 工程师（数学库 + DataAPI）

---

### Phase 2：会计核算（参考工期：4–6 周）

**核心交付物：** Mark-to-Market 估值引擎、双分录账本、数据水位线监控、对账服务。

**里程碑验收标准：**
- 任意历史区块的账面净值可在 30 秒内准确计算，误差 ≤ 1 wei
- 双分录账本与链上余额对账差异 = 0，通过 100 笔测试交易验证
- 水位线监控可在 SyncBlock 落后超阈值时，在 1 个区块内触发熔断停止发单；配套告警须在熔断触发后同步推送，验收标准见**《非功能性量化指标说明文档》- 监控告警规范**

**主要负责角色：** 后端工程师（账本 + 对账）、数据工程师（水位线监控）

---

### Phase 3：执行肢体（参考工期：6–8 周）

**核心交付物：** 幂等 FSM 状态机、跨链库存再平衡、Flashbots 私有 MEV 路由、三源预言机校验。

**里程碑验收标准：**
- FSM 通过混沌测试：随机 kill 进程 1000 次，零重复执行、零资金丢失；详细测试场景定义见**《非功能性量化指标说明文档》- 交易幂等性指标**
- 跨链再平衡可自动检测链间资金失衡，并完成端到端转账（含对账确认）
- 私有路由与公开 mempool 路由的 MEV 损耗对比测试，私有路由损耗降低 ≥ 50%
- 三源预言机校验通过**《验证门控标准说明文档》G 系列关卡**中价格一致性验收场景

**主要负责角色：** 区块链工程师（FSM + 跨链）、MEV 工程师（私有路由）

---

### Phase 4：治理闭环（参考工期：3–4 周）

**核心交付物：** 24h 管理员时间锁、治理提案爬虫、AI 反馈飞轮、全局 Kill Switch。

**里程碑验收标准：**
- 时间锁变更操作经过完整 24h 等待期后方可执行，Guardian 一票否决可在 1 分钟内生效
- 治理爬虫可在提案发布后 1 小时内完成捕获并推送告警
- Kill Switch 在生产环境演练中，可在 60 秒内完成所有 Token 授权撤销
- AI 反馈飞轮完成首次端到端测试：退役策略数据成功转化为优化 Prompt 并输入模型；打分维度与权重以**《评估指标体系说明文档》**为准

**主要负责角色：** 智能合约工程师（时间锁）、数据工程师（爬虫）、AI 工程师（反馈飞轮）

---

## 附：参数评审检查清单

建议在项目启动时同步评审以下所有待确认参数，避免后期逐个修改：

| **参数** | **占位值** | **需要参考的决策因素** |
|------|--------|------------------|
| 大额审批阈值 | $10,000 | 预期交易规模、策略生命周期阶段（STAGED vs LIVE）、审批响应能力 |
| 时间锁等待时长 | 24 小时 | 团队时区、紧急调整需求 |
| 预言机偏差熔断阈值 | 0.5% | 目标交易对的正常价差范围 |
| 数据水位线落后区块数 | 2 个区块 | 可接受的数据延迟 vs 熔断频率 |
| 单策略资金池占比上限 | 5%（Staged）| 风险分散要求、策略信任度 |
| 影子模式最短持续时间 | 72 小时 | 团队审查节奏 |
| 蒙特卡洛最低轮次 | 5,000 轮 | 可接受的统计置信度 vs 计算成本 |

## 文档版本记录

| **版本** | **日期** | **变更内容** | **作者** |
|----------|----------|--------------|----------|
| v5.0 | 2026-02-25 | 初始版本，定义六大支柱模块与研发路线图 | DeFi 策略团队 |
| v5.1 | 2026-02-25 | 补充附属文档引用索引、文档导航地图、Phase 验收标准附属文档引用 | DeFi 策略团队 |
