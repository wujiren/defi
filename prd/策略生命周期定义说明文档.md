# DeFi 自动化交易基础设施

> **策略生命周期定义说明文档**  
> *Strategy Lifecycle Definition*  
> PRD 附属文档 · 版本 1.0 · 2026

---

## 一、文档目的与背景
本文档是《DeFi 自动化交易与资管基础设施 PRD》的附属规范文件，专门定义策略从创建到退役的完整生命周期体系。

策略生命周期管理解决以下核心问题：

- **状态可追溯：** 每个策略在任意时刻都有明确的状态，团队成员和 AI Agent 均可查询。

- **门控可量化：** 每次状态流转都有清晰的准入标准，避免依赖主观判断上线策略。

- **风险可隔离：** 不同状态的策略拥有不同的资金权限，将风险限制在可控范围内。

- **自动化可落地：** AI Agent 可依据状态机自动触发验证、评估流程，减少人工介入。

## 二、核心状态机总览
策略共有 8 个状态，分为主干流转路径与异常路径两类。

| **DRAFT**                                                   | →   | **VALIDATED** | →   | **EVALUATED** | →   | **SHADOWED** | →   | **STAGED** | →   | **LIVE** |
|-------------------------------------------------------------|-----|---------------|-----|---------------|-----|--------------|-----|------------|-----|----------|
| **LIVE** ⇄ **PAUSED** | **LIVE / PAUSED** → **DEPRECATED** |     |               |     |               |     |              |     |            |     |          |

**主干路径：** DRAFT → VALIDATED → EVALUATED → SHADOWED → STAGED → LIVE

**异常路径：** LIVE ⇄ PAUSED（可恢复）；LIVE / PAUSED → DEPRECATED（终态）

**回退路径：** 任何阶段验证失败，均可回退至 DRAFT 重新修改，不丢失历史验证报告。

## 三、各状态详细定义
### 3.1 DRAFT（草稿）
策略代码存在，但尚未经过任何系统验证，是所有策略的起点。

| **📝 DRAFT** |                                                                     |
|--------------|---------------------------------------------------------------------|
| **准入条件** | 实现 BaseStrategy 接口；风控参数字段完整填写（invariants 不为空）   |
| **允许操作** | 本地修改代码；手动调用单项仿真（如仅运行 EVM 数学库精度检查）       |
| **禁止操作** | 任何形式的资金接触，包括影子模式和 Staged 执行                      |
| **资金权限** | 无（零资金访问）                                                    |
| **退出条件** | 调用 sdk.validate() 全流水线，静态分析、Fuzzing、不变性断言全部通过 |
| **负责角色** | 策略开发者                                                          |

### 3.2 VALIDATED（已验证）
策略通过了安全性验证，证明在极端场景下不会产生超出预期的损失。此阶段关注「不会出错」，尚未评估「是否赚钱」。

| **✅ VALIDATED** |                                                                                |
|------------------|--------------------------------------------------------------------------------|
| **准入条件**     | 静态分析通过；Fuzzing 无破线（极端参数注入全部在约束内）；不变性断言 100% 满足 |
| **允许操作**     | 进入评估流水线（sdk.evaluate()）；查看验证报告；提交 Code Review               |
| **禁止操作**     | 直接进入影子模式或真实资金部署                                                 |
| **资金权限**     | 无                                                                             |
| **核心证明**     | 在 Gas 飙升 1000 倍、流动性枯竭、预言机偏差等极端场景下策略行为合规            |
| **退出条件**     | 完成回测 + 蒙特卡洛评估，绩效指标达到开发者预设阈值                            |
| **负责角色**     | 策略开发者 + 自动化验证系统                                                    |

### 3.3 EVALUATED（已评估）
策略在历史和模拟场景下具备预期的盈利能力，风险收益比在可接受范围内。

| **📊 EVALUATED** |                                                                                                  |
|------------------|--------------------------------------------------------------------------------------------------|
| **准入条件**     | Sharpe Ratio > 开发者设定阈值；最大回撤 \< 阈值；Gas 成本在合理范围内；蒙特卡洛置信区间满足要求 |
| **允许操作**     | 申请进入影子模式部署；与历史策略对比分析；调整策略参数后重新评估                                 |
| **核心证明**     | 回测 + 蒙特卡洛模拟均显示策略在统计意义上具备正期望收益                                          |
| **资金权限**     | 无                                                                                               |
| **退出条件**     | 开发者人工确认评估报告，提交影子部署申请                                                         |
| **注意事项**     | SDK 提供评估数据，不替开发者做决策。评估报告必须归档，用于后续 AI 反馈飞轮                       |
| **负责角色**     | 策略开发者（人工确认）                                                                           |

### 3.4 SHADOWED（影子运行）
策略在真实市场环境中完整运行，FSM 状态机、水位线检查、预言机校验全部激活，但最后一步不广播交易。这是最接近实盘的预演阶段。

| **👁 SHADOWED**   |                                                                                      |
|------------------|--------------------------------------------------------------------------------------|
| **准入条件**     | EVALUATED 状态 + 开发者人工确认评估报告                                              |
| **允许操作**     | 观察真实触发频率；记录水位线命中情况；统计预言机熔断次数；对比影子收益与实际市场变化 |
| **禁止操作**     | 广播任何真实交易；修改策略逻辑（须退回 DRAFT）                                       |
| **资金权限**     | 只读（查询余额、价格，不操作资金）                                                   |
| **最短持续时间** | 建议 ≥ 72 小时，覆盖完整的市场波动周期（工作日 + 周末）                              |
| **退出条件**     | 影子模式假设收益与回测预期偏差在 ±15% 以内；且无系统性异常触发                       |
| **负责角色**     | 策略开发者 + 运营审查                                                                |

### 3.5 STAGED（预上线）
策略获准使用真实资金进行灰度验证，资金上限受严格约束。目的是验证 MPC 签名、链上执行、对账的完整真实闭环。

| **🚀 STAGED** |                                                                         |
|---------------|-------------------------------------------------------------------------|
| **准入条件**  | SHADOWED 通过 + 管理员人工审批                                          |
| **资金限制**  | 最大持仓不超过全局资金池的 5%（可配置）                                 |
| **单笔限制**  | 超过 \$10,000 的交易自动挂起，须管理员二次确认后方可签名执行            |
| **允许操作**  | 真实资金的完整交易执行；全链路 Trace ID 验证；实盘 PnL 与影子模式对比   |
| **退出条件**  | 连续运行 ≥ 7 天无异常；实盘表现与影子模式偏差 ≤ 20%；管理员最终审批通过 |
| **负责角色**  | 管理员（审批）+ 自动化监控                                              |

### 3.6 LIVE（生产运行）
策略全权运行，资金限制放开至策略设计上限，MPC 自动签名生效，AI 反馈飞轮激活。

| **⚡ LIVE**      |                                                                               |
|------------------|-------------------------------------------------------------------------------|
| **准入条件**     | STAGED 通过 + 管理员最终审批（走 24 小时 Admin Timelock）                     |
| **资金权限**     | 策略配置上限内完全自主                                                        |
| **监控要求**     | 全链路 Trace ID 持续输出；实时 PnL 追踪；Mark-to-Market 每区块更新            |
| **自动降级触发** | 连续亏损超阈值 → PAUSED；治理哨兵告警 → PAUSED；数据水位线持续落后 → 暂停发单 |
| **人工操作**     | 管理员可随时手动暂停（→ PAUSED）或退役（→ DEPRECATED）                        |
| **负责角色**     | 系统自动监控 + 管理员兜底                                                     |

### 3.7 PAUSED（暂停）
策略被临时中止，当前仓位保持不动，等待人工介入处理。PAUSED 是可恢复的临时状态，与 DEPRECATED 有本质区别。

| **⏸ PAUSED**             |                                                                                          |
|--------------------------|------------------------------------------------------------------------------------------|
| **触发来源**             | 自动触发：风控熔断、治理风险告警、连续亏损；手动触发：管理员主动暂停                     |
| **与 DEPRECATED 的区别** | PAUSED 是临时状态，问题解决后可恢复 LIVE；DEPRECATED 是终态，不可逆                      |
| **资金状态**             | 仓位冻结，不新开仓，已有仓位按配置决定是否自动清仓                                       |
| **允许操作**             | 查看触发原因和告警详情；修复后重新走 VALIDATED 流程（不需从头开始）；人工确认后恢复 LIVE |
| **恢复条件**             | 管理员确认问题已解决；重新通过受影响模块的验证                                           |
| **负责角色**             | 管理员                                                                                   |

### 3.8 DEPRECATED（已退役）
策略永久停止运行，进入终态。历史数据归档保留，用于 AI 反馈飞轮学习。

| **🗄 DEPRECATED** |                                                                                       |
|------------------|---------------------------------------------------------------------------------------|
| **触发来源**     | 人工主动退役；底层协议升级导致 Adapter 失效；连续触发熔断超过次数上限（如 3 次/7 天） |
| **退役后处理**   | 资金归还资金池；历史对账记录封存；验证报告保留（不可删除）                            |
| **AI 利用**      | 退役数据自动转化为 Prompt，输入 AI 反馈飞轮，用于下一代策略的优化迭代                 |
| **可逆性**       | 不可逆。如需复用逻辑，须以 DEPRECATED 策略为参考，新建 DRAFT 重走全流程               |
| **负责角色**     | 系统自动归档 + 管理员确认                                                             |

## 四、自动状态流转触发矩阵
以下场景由系统自动触发状态变更，无需人工介入：

| **触发条件**     | **当前状态** | **目标状态/动作** | **说明**                                |
|------------------|--------------|-------------------|-----------------------------------------|
| 连续亏损超阈值   | LIVE         | PAUSED            | 风控模块自动触发，等待人工审查          |
| 治理提案告警     | LIVE         | PAUSED            | 治理哨兵捕获底层协议变更提案            |
| 数据水位线落后   | 任意         | 暂停发单          | SyncBlock 落后 >2，抛出 StaleDataError |
| 三源预言机偏差   | VALIDATED+   | 拦截本次交易      | 偏差超 0.5%，单次熔断，不改变状态       |
| Fuzzing 破线     | VALIDATED    | 退回 DRAFT        | 不变性断言失败，需重新修复策略逻辑      |
| 影子模式偏差过大 | SHADOWED     | 退回 EVALUATED    | 实盘偏差超 ±15%，需重新评估             |
| 适配器失效       | LIVE         | DEPRECATED        | 底层协议升级，Adapter Registry 标记失效 |

## 五、与 PRD 模块的对应关系
策略生命周期的每个阶段，均由 PRD 中的具体模块提供技术支撑：

| **生命周期阶段**      | **对应 PRD 模块**                         | **具体职责说明**                               |
|-----------------------|-------------------------------------------|------------------------------------------------|
| DRAFT → VALIDATED     | 模块 2：沙盒防线                          | Fuzzing 极端测试、不变性断言、影子模式前置检查 |
| VALIDATED → EVALUATED | 模块 4：财务会计                          | Mark-to-Market 估值、软滑点审计、双分录验证    |
| SHADOWED              | 模块 2.3：影子模式                        | 真实市场数据驱动、FSM 完整运行、不广播交易     |
| STAGED → LIVE         | 模块 5：MPC 签名流                        | 大额多签审批、24h 时间锁、Guardian 一票否决    |
| PAUSED                | 模块 5.3：全局断路器 + 模块 1.3：治理哨兵 | 一键撤销授权、治理风险自动熔断                 |
| DEPRECATED            | 模块 6.2：AI 反馈飞轮                     | 退役数据转化为 Prompt，驱动策略迭代优化        |

## 六、SDK 接口约定
生命周期管理通过以下标准接口操作，AI Agent 和开发者使用相同的调用方式：

### 6.1 状态查询
**sdk.strategy.status(strategy_id)** → 返回当前状态、上次变更时间、变更原因

### 6.2 主动流转
**sdk.validate(strategy)** → 触发 DRAFT → VALIDATED 全流水线，返回结构化验证报告

**sdk.evaluate(strategy)** → 触发 VALIDATED → EVALUATED，返回绩效评估报告

**sdk.deploy(strategy, mode='shadow')** → 部署至影子模式，mode 可选 shadow / staged / live

### 6.3 管理操作
**sdk.strategy.pause(strategy_id, reason)** → LIVE → PAUSED，记录暂停原因

**sdk.strategy.resume(strategy_id)** → PAUSED → LIVE，需管理员权限

**sdk.strategy.deprecate(strategy_id)** → 任意状态 → DEPRECATED，不可逆，触发归档流程

**注：** 所有状态变更均生成不可篡改的审计日志，包含操作者身份、时间戳和变更原因，通过全局 Trace ID 与链上执行记录关联。

## 七、文档版本记录
| **版本** | **日期**   | **变更内容**                      | **作者**      |
|----------|------------|-----------------------------------|---------------|
| v1.0     | 2026-02-25 | 初始版本，定义 8 状态生命周期体系 | DeFi 策略团队 |
