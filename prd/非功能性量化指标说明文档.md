# DeFi 自动化交易基础设施

> **非功能性量化指标说明文档**  
> *Non-Functional Requirements Specification*  
> PRD 附属文档 · 版本 1.0 · 2026

---

## 一、文档目的
本文档定义 DeFi 自动化交易基础设施的全部非功能性需求（NFR），将所有质量属性转化为可测试、可监控的量化指标。

非功能性需求回答「系统运行得怎么样」，与功能需求「系统能做什么」同等重要。在金融系统中，一个功能正确但延迟过高或可用性不足的系统，在关键时刻可能比没有系统更危险。

本文档涵盖六大维度：

- **性能（Performance）：** 延迟、吞吐量目标

- **可用性（Availability）：** SLA 等级与停机预算

- **可靠性（Reliability）：** 故障恢复与数据一致性

- **安全性（Security）：** 访问控制与审计要求

- **可扩展性（Scalability）：** 并发与容量上限

- **可观测性（Observability）：** 日志、指标、告警规范

## 二、核心指标总览
以下是系统最关键的非功能性量化指标，构成系统验收的底线：

| **维度** | **核心指标**         | **目标值**                 | **测量方式**              |
|----------|----------------------|----------------------------|---------------------------|
| 性能     | 决策到广播端到端延迟 | P99 \< 500ms               | 全链路 Trace ID 计时      |
| 性能     | 链上确认等待时间     | P50 \< 15s（正常 Gas）     | 广播到 CONFIRMED 状态计时 |
| 可用性   | 核心执行链路（P0）   | ≥ 99.9% / 月               | 实时心跳监控              |
| 可用性   | 风控与数据层（P1）   | ≥ 99.5% / 月               | 实时心跳监控              |
| 可靠性   | 交易幂等性           | 100%（零重复执行）         | FSM 状态审计              |
| 可靠性   | 对账差异率           | = 0%（零容忍）             | 每区块自动对账            |
| 可靠性   | 数据可复现性         | 100%（历史回测可精确重放） | 数据哈希校验              |
| 安全性   | 大额人工审批覆盖率   | STAGED：100%（> \$10,000）；LIVE：100%（> 策略资金 15%） | 审批日志审计 |
| 扩展性   | 最大并发策略数       | ≥ 50 个策略同时运行        | 压力测试验证              |
| 可观测性 | 全链路日志覆盖率     | 100% 交易有 Trace ID       | 日志完整性检查            |

## 三、性能指标（Performance）
### 3.1 端到端执行延迟

从策略触发决策到交易广播上链的全链路时间，是衡量系统实时性的核心指标。延迟过高意味着在价格快速变动时，决策基于的价格与实际执行价格之间存在较大偏差。

> **设计说明：延迟预算采用自顶向下分配原则。**
> 总目标 P99 < 800ms 为约束上限，各子阶段预算从总目标分解得出，不可独立设定后再加总倒推。EVM 仿真采用两档模式以兼顾风控完整性与执行速度：**轻量仿真**（常规交易，仅验证不变性断言）和**完整仿真**（大额交易或策略首次执行，完整 Anvil 模拟）。

**常规路径（轻量仿真）：**

| **阶段**         | **时间节点**           | **P50 预算** | **P99 预算** | **超时熔断阈值**           |
|------------------|------------------------|--------------|--------------|----------------------------|
| 数据获取         | 水位线校验完成         | \< 10ms      | \< 30ms      | > 100ms 触发切换备用源     |
| 策略计算         | on_tick() 执行完成     | \< 30ms      | \< 100ms     | > 300ms 取消本次决策       |
| EVM 仿真（轻量） | 不变性断言验证完成     | \< 30ms      | \< 80ms      | > 200ms 降级跳过，记录警告 |
| 签名请求         | MPC 节点返回签名       | \< 80ms      | \< 200ms     | > 2s 告警，> 5s 熔断       |
| 广播上链         | 交易进入 mempool       | \< 30ms      | \< 100ms     | > 500ms 切换 RPC 节点      |
| **常规全链路**   | **触发决策到广播完成** | **\< 180ms** | **\< 510ms** | > 800ms 记录为异常执行     |

**大额 / 首次执行路径（完整仿真）：**

| **阶段**         | **时间节点**           | **P50 预算** | **P99 预算** | **超时熔断阈值**       |
|------------------|------------------------|--------------|--------------|------------------------|
| 数据获取         | 水位线校验完成         | \< 10ms      | \< 30ms      | > 100ms 触发切换备用源 |
| 策略计算         | on_tick() 执行完成     | \< 30ms      | \< 100ms     | > 300ms 取消本次决策   |
| EVM 仿真（完整） | Anvil 完整模拟执行完成 | \< 100ms     | \< 250ms     | > 600ms 取消本次决策   |
| 签名请求         | MPC 节点返回签名       | \< 80ms      | \< 200ms     | > 2s 告警，> 5s 熔断   |
| 广播上链         | 交易进入 mempool       | \< 30ms      | \< 100ms     | > 500ms 切换 RPC 节点  |
| **完整全链路**   | **触发决策到广播完成** | **\< 250ms** | **\< 680ms** | > 1s 记录为异常执行    |

**完整仿真触发条件：** 单笔金额 > 策略分配资金 15%；或该策略在当前区块首次执行；或策略处于 STAGED 状态（全部交易走完整仿真）。

**测量方法：** 全链路 Trace ID 在每个阶段打时间戳，数据写入时序数据库（如 InfluxDB），P50/P99 按滚动 1 小时窗口计算。两条执行路径分别统计，不混合计算。每日生成延迟分布报告。

### 3.2 链上确认延迟
从交易广播到链上最终确认（6 个区块）的等待时间，受网络拥堵和 Gas 策略影响。

| **网络状态** | **判断条件**        | **P50 确认时间**      | **P99 确认时间** | **应对策略**                             |
|--------------|---------------------|-----------------------|------------------|------------------------------------------|
| 正常         | baseFee \< 30 Gwei  | \< 15s（约 1–2 区块） | \< 60s           | 常规 Gas 策略                            |
| 轻度拥堵     | baseFee 30–100 Gwei | \< 30s                | \< 120s          | 提升 priorityFee 10%                     |
| 重度拥堵     | baseFee > 100 Gwei | \< 60s                | \< 300s          | 触发阶梯 Gas 加速机制                    |
| 网络异常     | 交易 > 5min 未确认 | N/A                   | N/A              | FSM 进入 REORG 检测，考虑 Cancel/Replace |

### 3.3 回测与模拟性能
评估系统的计算性能目标，直接影响策略迭代速度：

| **任务类型**     | **数据规模**                      | **目标完成时间** | **并行支持**               |
|------------------|-----------------------------------|------------------|----------------------------|
| 单策略历史回测   | 90 天 Tick 级数据（约 5000 万条） | \< 30 分钟       | 是（多进程）               |
| 蒙特卡洛模拟     | 5000 轮 × 30 天                   | \< 60 分钟       | 是（多进程）               |
| Fuzzing 测试     | 1000 轮极端场景                   | \< 20 分钟       | 是                         |
| EVM 仿真精度测试 | 500 组随机输入                    | \< 2 分钟        | 否（顺序执行保证可复现性） |
| 影子模式实时计算 | 每区块触发一次                    | \< 2s / 区块     | 是（按策略并行）           |

## 四、可用性指标（Availability）
### 4.1 SLA 等级定义
系统按模块重要性划分三个 SLA 等级，分配不同的停机预算：

| **等级**    | **说明**                     | **年停机上限**     | **月停机上限** | **适用模块**   |
|-------------|------------------------------|--------------------|----------------|----------------|
| **P0 核心** | 策略执行、MPC签名、FSM状态机 | 8.7 小时（99.9%）  | 43 分钟        | 实盘关键路径   |
| **P1 重要** | 风控熔断、预言机校验、对账   | 43.8 小时（99.5%） | 3.6 小时       | 风控与数据层   |
| **P2 一般** | 回测引擎、蒙卡模拟、历史查询 | 87.6 小时（99.0%） | 7.2 小时       | 评估与分析模块 |

### 4.2 可用性计算口径
| **规范项**   | **定义**                                                |
|--------------|---------------------------------------------------------|
| 可用性定义   | 系统能够正确处理请求并返回预期结果的时间比例            |
| 统计周期     | 以自然月为单位计算，不跨月累计                          |
| 停机计入条件 | 核心功能不可用 > 1 分钟，或错误率 > 5% 持续 > 1 分钟 |
| 计划内维护   | 须提前 24 小时通知，纳入停机预算计算（不豁免）          |
| 部分降级处理 | 若仅非核心功能不可用（如历史查询），不计入 P0 停机时间  |
| 数据来源     | 监控系统的心跳探针记录，每 30 秒一次，不可人工修改      |

### 4.3 故障恢复时间目标（RTO / RPO）
| **模块**     | **RTO（恢复时间目标）** | **RPO（恢复点目标）** | **说明**                             |
|--------------|-------------------------|-----------------------|--------------------------------------|
| FSM 状态机   | \< 2 分钟               | 0（零数据丢失）       | 重启后从持久化状态恢复，无需人工介入 |
| MPC 签名服务 | \< 5 分钟               | 0                     | 备用 MPC 节点自动接管                |
| 数据索引器   | \< 10 分钟              | \< 2 个区块           | 重启后从最后同步区块继续，补全缺口   |
| 对账服务     | \< 15 分钟              | 0                     | 对账记录持久化，重启后继续未完成对账 |
| 回测引擎     | \< 30 分钟              | \< 1 小时计算结果     | 非核心路径，允许较长恢复时间         |

## 五、可靠性指标（Reliability）
### 5.1 交易幂等性
同一笔交易在任何异常情况下（网络中断、进程崩溃、Nonce 冲突）只能被执行一次，这是资金安全的底线。

| **异常场景**     | **FSM 预期行为**                                            | **验证方法**                             |
|------------------|-------------------------------------------------------------|------------------------------------------|
| 进程崩溃后重启   | 从 BROADCASTED 状态恢复，查询链上 Nonce 确认是否已上链      | 混沌测试：强制 kill 进程后验证无重复执行 |
| RPC 超时         | 保持 BROADCASTED 状态，定期轮询确认，不重新广播             | 网络隔离测试                             |
| 收到重复触发信号 | 检查 FSM 状态，若已在 SIGNED 及以后状态，拒绝重复处理       | 并发压力测试                             |
| Nonce 冲突       | 检测到 nonce already used 后，标记为 CONFLICT，等待人工确认 | 主动发送 Nonce 冲突交易测试              |
| 链上 Reorg       | 检测到区块哈希变化后，将受影响交易回退至 INIT 状态重新评估  | 本地 Anvil 模拟 Reorg 场景               |

### 5.2 数据一致性
| **一致性场景**     | **目标**                            | **检测频率**           | **违反时的处理**               |
|--------------------|-------------------------------------|------------------------|--------------------------------|
| 账本与链上余额     | 差异 = 0（零容忍）                  | 每区块自动对账         | 立即暂停策略，触发人工核查     |
| FSM 状态与链上状态 | FSM 状态与链上 Nonce / 确认状态一致 | 每区块校验             | 自动触发 FSM 状态修复          |
| 回测数据完整性     | 区块序列无间隔，无重复              | 每日全量校验           | 从备用源重新拉取缺失区块       |
| 验证报告可复现性   | 相同输入 + 相同种子 = 相同结果      | 每次报告生成后抽样验证 | 标记报告为不可信，触发重新生成 |

### 5.3 降级策略
当部分组件不可用时，系统应按以下降级策略保障核心功能：

| **故障组件**     | **降级行为**                                      | **降级期间限制**                  | **恢复条件**                           |
|------------------|---------------------------------------------------|-----------------------------------|----------------------------------------|
| 单个 RPC 节点    | 自动切换至备用节点，记录节点不可用事件            | 无限制，透明切换                  | 备用节点延迟 \< 200ms                  |
| Chainlink 预言机 | 使用 TWAP + Slot0 双源校验，适当放宽偏差阈值至 1% | 仅执行双源校验通过的交易          | Chainlink 数据恢复更新                 |
| MPC 签名服务     | 暂停所有新交易，已在队列中的交易挂起等待          | 零新交易，仓位冻结                | MPC 服务恢复且通过自检                 |
| 索引器同步延迟   | 水位线熔断，停止发单，等待同步追上                | 零新交易                          | SyncBlock 追上至 CurrentBlock - 2 以内 |
| 蒙卡/回测引擎    | 影响验证流程，P0/P1 核心模块不受影响              | 新策略无法完成 EVALUATED 状态流转 | 引擎恢复后继续排队任务                 |

## 六、安全性指标（Security）
### 6.1 访问控制量化要求
| **控制项**       | **量化要求**                                               | **审计方式**                         |
|------------------|------------------------------------------------------------|--------------------------------------|
| 大额交易人工审批（STAGED） | 单笔 > \$10,000 的 100% 需要管理员二次确认，无例外 | 审批日志全量审计，每日报告未审批占比 |
| 大额交易人工审批（LIVE）   | 单笔 > 策略当前分配资金 15% 时须管理员二次确认；首次执行新合约调用须确认；触达不变性断言边界 50% 时须确认 | 审批日志全量审计，按策略维度统计触发率 |
| 参数变更时间锁   | 核心风控参数变更必须经过 ≥ 24 小时时间锁，100% 覆盖        | 链上时间锁合约事件日志               |
| 白名单合约覆盖率 | 策略执行的 100% 合约调用必须在白名单内，零例外             | 每笔交易前静态分析检查               |
| MPC 签名授权     | AI 策略仅生成无签名 Payload，签名 100% 由 MPC 节点独立完成 | 签名来源日志审计                     |
| 管理员操作日志   | 100% 的管理员操作（含查询）生成不可篡改的审计日志          | 日志哈希链校验                       |

### 6.2 密钥与凭据安全
| **规范项**   | **要求**                                                          |
|--------------|-------------------------------------------------------------------|
| 私钥存储     | 私钥不得出现在任何配置文件、日志、环境变量中；全部由 MPC 节点托管 |
| API 密钥轮换 | 第三方 API 密钥（RPC 节点、预言机）每 90 天强制轮换一次           |
| 密钥访问审计 | 每次 MPC 签名操作记录操作者身份、时间戳、授权原因                 |
| 紧急撤销     | 全局 Kill Switch 能在 \< 60 秒内撤销所有 Token 授权（Revoke）     |
| 多签阈值     | Guardian 钱包实行 M-of-N 多签（默认 2-of-3），阈值变更须经时间锁  |

## 七、可扩展性指标（Scalability）
### 7.1 并发容量目标
| **并发维度**       | **当前目标**             | **设计上限** | **扩展方式**              |
|--------------------|--------------------------|--------------|---------------------------|
| 同时运行策略数     | ≥ 50 个策略并发运行      | 200 个       | 水平扩展策略执行进程      |
| 每秒交易触发量     | ≥ 20 TPS（触发，非链上） | 100 TPS      | 消息队列缓冲 + 多消费者   |
| 同时进行的回测任务 | ≥ 5 个并发回测           | 20 个        | 独立计算节点池            |
| 支持的链数量       | ≥ 5 条 EVM 兼容链        | 20 条        | Adapter Registry 按链扩展 |
| 支持的协议数量     | ≥ 10 个 DeFi 协议        | 无硬性上限   | Adapter 插件化注册        |
| 历史数据查询并发   | ≥ 10 个并发查询          | 50 个        | 查询缓存 + 读写分离       |

### 7.2 容量规划基准
以下为单策略的资源消耗基准，用于容量规划和成本估算：

| **资源类型**        | **单策略消耗基准**        | **50 策略估算** | **说明**                             |
|---------------------|---------------------------|-----------------|--------------------------------------|
| 内存（运行时）      | ~50MB / 策略              | ~2.5GB          | 含策略状态、缓存价格、FSM 队列       |
| CPU（稳定运行）     | ~0.1 核 / 策略            | ~5 核           | 数据处理和决策计算                   |
| CPU（EVM 仿真峰值） | ~1 核 / 策略              | ~50 核（短时）  | 仅在执行前模拟时触发，持续 \< 500ms  |
| 存储（历史数据）    | ~50GB / 链 / 月           | 与策略数无关    | 历史数据是共享的，不随策略数线性增长 |
| 网络（RPC 调用）    | ~100 次调用 / 区块 / 策略 | ~5000 次 / 区块 | 按调用频率规划 RPC 节点配额          |

## 八、可观测性指标（Observability）
### 8.1 日志规范
| **日志级别** | **使用场景**                     | **保留时长** | **示例**                           |
|--------------|----------------------------------|--------------|------------------------------------|
| ERROR        | 系统异常、验证失败、对账差异     | 永久保留     | StaleDataError、FSM 非法状态转换   |
| WARN         | 熔断触发、降级启动、阈值临近     | 90 天        | 三源预言机偏差 > 0.3%（未达熔断） |
| INFO         | 正常业务流程、状态变更、交易广播 | 30 天        | 策略触发、交易 CONFIRMED           |
| DEBUG        | 详细计算过程、数据获取明细       | 7 天         | EVM 仿真输入输出、Tick 计算过程    |

**全链路 Trace ID：** 每次策略触发生成唯一 trace_id，贯穿「决策 → 仿真 → 签名 → 广播 → 确认 → 对账」全流程。任意环节的日志均可通过 trace_id 关联。

### 8.2 监控告警规范
| **告警名称**       | **触发条件**                                  | **告警级别** | **响应时限**   |
|--------------------|-----------------------------------------------|--------------|----------------|
| 执行延迟超标       | P99 延迟 > 500ms 持续 5 分钟                 | P1           | \< 30 分钟响应 |
| 对账差异           | 任意对账差异 > 0                             | P0           | \< 10 分钟响应 |
| 数据水位线预警     | SyncBlock 落后 > 1 个区块                    | WARN         | 监控记录，无需立即响应 |
| 数据水位线熔断     | SyncBlock 落后 > 2 个区块（与熔断同步触发）  | P1 ERROR     | \< 15 分钟响应        |
| 数据水位线持续异常 | SyncBlock 落后 > 2 个区块持续 > 3 分钟       | P0 紧急      | \< 5 分钟响应，自动恢复失败须人工介入 |
| 可用性 SLA 临近    | 当月累计停机时间达到 SLA 上限的 80%           | P1           | \< 1 小时评估  |
| 大额交易待审批超时 | 审批队列中有 > \$10,000 交易等待超过 30 分钟 | P2           | \< 1 小时响应  |
| 预言机熔断频率过高 | > 20 次熔断 / 小时                           | P2           | \< 2 小时调查  |
| MPC 签名延迟       | 签名响应时间 > 2 秒                          | P1           | \< 15 分钟响应 |
| FSM 卡死           | 同一交易在 BROADCASTED 状态超过 10 分钟       | P1           | \< 20 分钟响应 |

### 8.3 定期报告要求
| **报告类型** | **频率** | **核心内容**                               | **接收方**          |
|--------------|----------|--------------------------------------------|---------------------|
| 系统健康日报 | 每日     | SLA 达成率、延迟分布、熔断次数、对账状态   | 团队全员            |
| 策略绩效周报 | 每周     | 各策略 PnL、Gas 消耗、资金利用率、异常事件 | 策略开发者 + 管理员 |
| 安全审计月报 | 每月     | 大额审批记录、参数变更记录、密钥轮换状态   | 管理员              |
| 容量规划季报 | 每季度   | 资源消耗趋势、SLA 达成趋势、扩容建议       | 管理员              |

## 九、NFR 验收矩阵
以下指标是系统上线（策略进入 LIVE 状态）前必须通过的非功能性验收条件：

| **验收项**       | **验收标准**                            | **测试方法**                         | **负责人** |
|------------------|-----------------------------------------|--------------------------------------|------------|
| 端到端延迟       | 常规路径 P99 \< 510ms；完整仿真路径 P99 \< 680ms | JMeter / 自定义压测脚本，50 并发策略，按两档路径分别测试 | 技术负责人 |
| 幂等性           | 1000 轮混沌测试零重复执行               | 随机 kill 进程 + Nonce 冲突注入      | 技术负责人 |
| 对账准确性       | 100 笔测试交易零差异                    | Staged 环境全量对账审计              | 运营负责人 |
| MPC 签名覆盖     | 所有交易 100% 经 MPC 签名               | 日志审计：无绕过 MPC 的私钥签名      | 安全负责人 |
| 时间锁有效性     | 参数变更 100% 经过 24h 时间锁           | 提交变更后立即尝试绕过，验证被拦截   | 安全负责人 |
| Kill Switch 响应 | \< 60 秒完成所有 Token 授权撤销         | 生产环境演练（使用测试资产）         | 管理员     |
| 50 策略并发      | 50 个策略同时运行，无资源争用或状态污染 | 并发压力测试，持续 24 小时           | 技术负责人 |
| 数据可复现性     | 同一回测任务重复运行 3 次结果完全一致   | 自动化回归测试                       | 技术负责人 |

## 十、文档版本记录
| **版本** | **日期**   | **变更内容**                               | **作者**      |
|----------|------------|--------------------------------------------|---------------|
| v1.0     | 2026-02-25 | 初始版本，定义六大维度全部非功能性量化指标 | DeFi 策略团队 |
| v1.1     | 2026-02-25 | 依据审查意见修正：延迟预算重构（两档仿真）、大额审批按状态差异化、告警阈值与熔断同步、时间锁适用边界澄清、指标双重标准统一 | DeFi 策略团队 |
