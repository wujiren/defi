# DeFi 自动化交易基础设施

> **验证门控标准说明文档**  
> *Validation Quality Gate Standard*  
> PRD 附属文档 · 版本 1.0 · 2026

---

## 一、文档目的
本文档定义策略生命周期中每个验证关卡（Quality Gate）的具体通过标准，回答「怎么算通过」的问题。所有标准须可被自动化系统执行，确保 AI Agent 能够无歧义地判断策略是否可以推进至下一阶段。

验证门控的设计原则：

- **客观可量化：** 每项标准均有明确的数值阈值，不依赖主观判断

- **分层递进：** G1–G4 保障安全性，G5–G6 评估收益性，G7–G8 验证生产就绪

- **快速失败：** 低成本的关卡（静态分析）优先执行，避免浪费计算资源

- **可配置：** 阈值参数集中管理，不同策略类型可使用差异化配置

## 二、关卡总览
策略从 DRAFT 到 LIVE 需通过 8 个关卡，按执行顺序排列如下：

| **关卡**       | **流转区间**          | **触发方式** | **通过标准**            | **最短耗时** |
|----------------|-----------------------|--------------|-------------------------|--------------|
| G1 静态分析    | DRAFT → VALIDATED     | 全自动       | 类型完整 + 参数合规     | \< 30s       |
| G2 EVM 仿真    | DRAFT → VALIDATED     | 全自动       | 链下链上结果位级对齐    | \< 2min      |
| G3 不变性断言  | DRAFT → VALIDATED     | 全自动       | 全部断言 100% 通过      | \< 5min      |
| G4 Fuzzing     | DRAFT → VALIDATED     | 全自动       | 1000 轮无破线           | \< 30min     |
| G5 回测        | VALIDATED → EVALUATED | 全自动       | Sharpe/回撤/Gas 达标    | \< 60min     |
| G6 蒙特卡洛    | VALIDATED → EVALUATED | 全自动       | 置信区间正收益 ≥ 60%    | \< 90min     |
| G7 影子对比    | SHADOWED → STAGED     | 人工确认     | 偏差 ≤ ±15%，运行 ≥ 72h | ≥ 72h        |
| G8 Staged 验收 | STAGED → LIVE         | 人工审批     | 7天无异常 + 管理员签字  | ≥ 7d         |

**说明：** G1–G6 由 SDK 全自动执行，结果以结构化 JSON 报告输出；G7–G8 需人工确认，但判断依据仍由系统自动计算提供。

> **阈值优先级说明：** 本文档中所有数值型阈值（如 Sharpe ≥ 1.0、MDD ≤ 20%）均为**系统全局底线**，不可逾越。开发者可在策略元数据中声明更严格的自定义阈值，但不得低于系统底线。AI Agent 自动判断时以系统底线为准；若检测到开发者自定义值低于底线，输出 `THRESHOLD_OVERRIDE` 警告并强制使用底线值。

## 三、安全性关卡（G1–G4）
安全性关卡对应生命周期中的 DRAFT → VALIDATED 阶段，目标是证明策略在任何条件下都不会产生超出预期的损失。

### G1 静态分析
在执行任何动态仿真前，先对策略代码和配置进行静态检查，耗时极短，是最低成本的关卡。

| **检查项**      | **通过标准**                                       | **失败处理**                     |
|-----------------|----------------------------------------------------|----------------------------------|
| 接口完整性      | 实现 BaseStrategy 全部必填方法，无缺失             | 报告缺失方法名，拒绝进入后续关卡 |
| invariants 非空 | 至少声明 1 个不变性约束（如 MaxDrawdown）          | 提示开发者补充风控约束           |
| 风控参数类型    | 所有阈值参数类型正确（数值非字符串）且在合理范围内 | 报告具体字段和实际值             |
| 协议适配器存在  | 策略引用的所有 Adapter ID 在注册表中有效           | 列出无效 Adapter ID              |
| 白名单合约      | 策略调用的合约地址全部在白名单内                   | 列出未授权合约地址               |

### G2 EVM 仿真精度
验证链下计算结果与链上 Solidity 执行结果的一致性，消除回测和实盘之间的系统性误差。

| **测试场景**     | **通过标准**                                 | **可接受误差**    |
|------------------|----------------------------------------------|-------------------|
| 整数除法舍入     | 链下结果与 Solidity floor 除法结果完全一致   | 0（必须位级对齐） |
| TickMath 计算    | sqrt(price) 计算结果与链上 TickMath 偏差为 0 | 0（必须位级对齐） |
| uint256 溢出边界 | 边界值（0, 2^256-1）处理与链上行为一致       | 0                 |
| 费率累积计算     | 多步费率复利结果与链上 feeGrowthGlobal 一致  | ≤ 1 wei           |
| 流动性计算       | getLiquidityForAmounts 结果与合约输出一致    | ≤ 1 wei           |

**执行方式：** 对每个计算函数生成 500 组随机输入，对比链下 SDK 与 Anvil fork 上的链上调用结果。全部通过方可进入 G3。

### G3 不变性断言
验证策略声明的所有 invariants 在标准场景下均能被满足，确保物理底线有效。

| **不变性类型**   | **默认阈值**                | **通过标准**    | **说明**                     |
|------------------|-----------------------------|-----------------|------------------------------|
| MaxDrawdown      | 单次执行 U 本位跌幅 ≤ 1%    | 100% 场景下满足 | 保护本金不被单次交易大幅侵蚀 |
| MaxSlippage      | 实际滑点 ≤ 声明滑点容忍度   | 100% 场景下满足 | 防止在流动性薄弱时超额滑点   |
| MaxGasMultiple   | 实际 Gas ≤ 估算 Gas × 3     | 100% 场景下满足 | 防止 Gas 估算严重低估        |
| PositionLimitPct | 单策略持仓 ≤ 资金池上限比例 | 100% 场景下满足 | 隔离单策略风险               |
| 自定义 invariant | 开发者自定义的断言逻辑      | 100% 场景下满足 | 支持扩展                     |

**重要：** 不变性断言要求 100% 通过，无例外。即使 999/1000 场景通过，仍判定为失败，策略退回 DRAFT。

### G4 极端 Fuzzing
主动注入极端和边界参数，测试策略在真实对抗环境下的鲁棒性。这是安全性关卡中耗时最长、覆盖面最广的一关。

| **Fuzzing 维度** | **参数范围**                 | **轮次** | **通过标准**                      |
|------------------|------------------------------|----------|-----------------------------------|
| Gas 价格波动     | 1x ~ 1000x 基准 Gas          | 200 轮   | 无单次亏损超 MaxDrawdown          |
| 流动性枯竭       | 目标池流动性降至 0.1% ~ 100% | 200 轮   | 策略正确拒绝执行或降级处理        |
| 价格极端跳动     | ±10% ~ ±90% 单区块价格变化   | 200 轮   | 三源预言机正确触发熔断            |
| 网络延迟/超时    | RPC 超时 0ms ~ 30s           | 200 轮   | FSM 正确进入 BROADCASTED 状态等待 |
| Nonce 冲突       | 并发发送相同 Nonce 交易      | 100 轮   | 幂等状态机正确处理，无资金丢失    |
| 区块重组         | 模拟 1~3 个区块的 reorg      | 100 轮   | FSM 检测到 REORG，回滚至正确状态  |

**总计：** 1000 轮 Fuzzing，全部通过（0 次破线）方可进入评估阶段。允许策略正确拒绝执行（即触发熔断），但不允许产生超限损失。

## 四、绩效关卡（G5–G6）
绩效关卡对应 VALIDATED → EVALUATED 阶段，目标是证明策略在统计意义上具备正期望收益，且风险收益比可接受。

### G5 历史回测
在真实历史区块数据上重放策略，评估其在已发生市场环境中的表现。

| **指标**                | **默认通过阈值**    | **备注**                           |
|-------------------------|---------------------|------------------------------------|
| 回测时间跨度            | ≥ 90 天历史数据     | 须覆盖牛市、熊市、震荡市各至少一段 |
| 数据精度                | 交易级别（非 OHLC） | 须包含真实链上 tick 数据           |
| 年化 Sharpe Ratio       | **系统底线 ≥ 1.0**（不可逾越；开发者自定义阈值只能更严，不得低于此值）| 基准：无风险利率 = 0（DeFi 场景）；自定义值低于底线时输出 `THRESHOLD_OVERRIDE` 警告 |
| 最大回撤（MDD）         | ≤ 20%               | 以 U 本位计算                      |
| Calmar Ratio            | ≥ 0.5               | 年化收益 / 最大回撤                |
| 总 Gas 成本占比         | ≤ 毛收益的 30%      | Gas 成本必须纳入净收益计算         |
| 资金利用率              | ≥ 40%               | 长期闲置资金视为策略效率低下       |
| 盈亏比（Profit Factor） | ≥ 1.3               | 总盈利 / 总亏损                    |

**回测数据要求：** 须使用 SDK 提供的标准数据源，禁止使用开发者自行清洗的非标数据，确保回测可复现。每次回测生成唯一 Hash 与数据快照绑定。

### G6 蒙特卡洛模拟
在随机化市场参数空间内进行大量模拟，评估策略的统计鲁棒性，消除回测对特定历史路径的过拟合风险。

| **模拟参数** | **随机化范围**         | **说明**                     |
|--------------|------------------------|------------------------------|
| 市场波动率   | 历史波动率的 0.5x ~ 3x | 覆盖低波动与极高波动场景     |
| 流动性深度   | 历史均值的 10% ~ 200%  | 覆盖流动性危机场景           |
| Gas 基准价格 | 历史均值的 0.5x ~ 10x  | 覆盖网络拥堵场景             |
| 起始时间偏移 | 随机选取历史区间起点   | 避免对特定市场周期的路径依赖 |
| 手续费率变动 | ±50% 范围内随机变化    | 模拟协议费率调整             |

| **统计指标**     | **通过标准**      | **含义**                      |
|------------------|-------------------|-------------------------------|
| 正收益模拟占比   | ≥ 60%             | 超过 60% 的随机场景下策略盈利 |
| 中位数年化收益   | ≥ 0%              | 中位数场景不亏损              |
| 最差 5% 分位回撤 | ≤ 40%             | 极端情况下损失可控            |
| 收益标准差       | ≤ 中位数收益的 3x | 收益分布不能过度发散          |
| 模拟总轮次       | ≥ 5000 轮         | 确保统计置信度                |

## 五、生产就绪关卡（G7–G8）
生产就绪关卡需要人工参与确认，但判断依据由系统自动计算提供，确保决策有数据支撑。

### G7 影子模式对比验收
对比影子模式下的假设执行结果与真实市场变化，验证策略逻辑在真实数据驱动下的行为符合预期。

| **验收项**     | **通过标准**                                | **说明**                         |
|----------------|---------------------------------------------|----------------------------------|
| 最短运行时长   | ≥ 72 小时连续运行                           | 覆盖工作日 + 周末的完整市场周期  |
| 假设收益偏差   | 与 G5 回测预期偏差 ≤ ±15%                   | 偏差过大说明回测存在过拟合       |
| 触发频率偏差   | 实际触发次数与回测预期偏差 ≤ ±30%           | 频率偏差过大说明市场条件假设错误 |
| 熔断误触率     | 预言机/水位线误触发次数 ≤ 5 次/天           | 过多误触发说明阈值需要调整       |
| 系统稳定性     | 无 StaleDataError / FSM 状态异常 / 对账差异 | 基础设施层必须完全健康           |
| Gas 估算准确性 | 实际 Gas 与估算偏差 ≤ ±20%                  | 影子模式的 Gas 估算须与实盘一致  |

**人工确认要求：** 系统自动生成影子模式报告，开发者和运营负责人须在报告上签字确认，方可申请进入 STAGED。

### G8 Staged 生产验收
用真实小额资金验证完整交易闭环，包括 MPC 签名、链上执行、对账的端到端流程。

| **验收项**      | **通过标准**                     | **说明**                             |
|-----------------|----------------------------------|--------------------------------------|
| 最短运行时长    | ≥ 7 个自然日                     | 覆盖完整周度市场节奏                 |
| 实盘与影子偏差  | 净收益偏差 ≤ ±20%                | 超出说明影子模式存在系统性缺陷       |
| 交易成功率      | ≥ 95%                            | 失败含：revert / Gas 不足 / 签名超时 |
| 对账差异        | 零差异（账本与链上余额完全一致） | 任何对账差异均视为严重缺陷           |
| 大额审批流畅度  | >\$10,000 单笔均走完审批流程    | 验证多签流程无卡点                   |
| Trace ID 完整性 | 100% 交易有完整的全链路日志      | 不可有孤立交易记录                   |
| 管理员最终签字  | 资金负责人书面审批通过           | 不可绕过                             |

## 六、策略类型差异化阈值
不同策略类型的风险收益特征不同，G5–G6 的部分阈值可按策略类型进行差异化配置：

| **指标**       | **做市策略** | **套利策略** | **收益聚合** | **跨链再平衡** |
|----------------|--------------|--------------|--------------|----------------|
| 最小 Sharpe    | ≥ 0.8        | ≥ 1.5        | ≥ 0.6        | ≥ 0.5          |
| 最大回撤       | ≤ 15%        | ≤ 10%        | ≤ 25%        | ≤ 20%          |
| Gas 成本占比   | ≤ 40%        | ≤ 20%        | ≤ 30%        | ≤ 50%          |
| 正收益蒙卡占比 | ≥ 55%        | ≥ 70%        | ≥ 60%        | ≥ 55%          |
| 最短影子运行   | 72h          | 48h          | 72h          | 96h            |

**说明：** 阈值参数集中存储在 SDK 配置中心，开发者在策略元数据中声明策略类型，系统自动应用对应阈值。自定义阈值须经管理员审批，且不得低于表中最宽松值的 80%。

## 七、多指标裁决规则
当多个指标出现冲突时，按以下优先级裁决：

| **优先级** | **裁决规则**       | **典型场景**                  | **处理方式**                         |
|------------|--------------------|-------------------------------|--------------------------------------|
| P0         | 任意安全性指标失败 | G1–G4 任一关卡不通过          | 立即终止，退回 DRAFT，不进行后续评估 |
| P1         | 对账差异 > 0      | Staged 阶段账本与链上不一致   | 立即暂停策略，触发人工核查           |
| P2         | 核心指标不达标     | Sharpe 达标但最大回撤超限     | 整体判定失败，不可用单项指标达标抵消 |
| P3         | Gas 成本指标不达标 | 收益指标均达标但 Gas 占比过高 | 判定失败，建议优化执行路径后重测     |
| P4         | 辅助指标不达标     | 资金利用率偏低                | 生成警告但不阻断，开发者可确认后继续 |

## 八、验证报告输出规范
每次关卡执行后，SDK 自动生成结构化报告，格式须满足以下要求：

- **唯一标识：** 每份报告携带 report_id（UUID）和 strategy_version_hash，确保可追溯

- **关卡结论：** 每个关卡输出 PASS / FAIL / WARN 三态结论，附具体触发原因

- **指标快照：** 所有数值型指标必须包含实际值、阈值和偏差百分比三列

- **可复现性：** 报告必须包含数据源 block_range、随机数种子（Fuzzing/蒙卡），确保结果可重现

- **AI 可消费：** 输出标准 JSON 格式，供 AI 反馈飞轮自动解析并生成优化 Prompt

- **不可篡改：** 报告生成后内容锁定，修改须生成新版本，历史版本永久保留

## 九、文档版本记录
| **版本** | **日期**   | **变更内容**                      | **作者**      |
|----------|------------|-----------------------------------|---------------|
| v1.0     | 2026-02-25 | 初始版本，定义 G1–G8 全部门控标准 | DeFi 策略团队 |
| v1.1     | 2026-02-25 | 依据审查意见修正：延迟预算重构（两档仿真）、大额审批按状态差异化、告警阈值与熔断同步、时间锁适用边界澄清、指标双重标准统一 | DeFi 策略团队 |
