# 🏛️ DeFi 自动化交易与资管基础设施 - PRD 5.1 (终极工业版)

## 零、 顶层设计哲学 (The Philosophy)

打造一个**“多智能体（AI Agents）与人类协同”**的机构级 DeFi 资管中台。系统核心使命：在充满对抗的链上环境中，通过**物理级隔离、金融级对账、确定性执行**，构建一个能够承载千万级美金的自动化交易堡垒。

---

## 一、 六大支柱模块 (The 6 Pillars)

### 模块 1：策略大脑与协议适配 (Strategy & Abstraction)

**1.1 强类型 AI Schema 与 EVM 仿真数学库**
**核心问题：** 链下策略代码与链上智能合约在数学计算上存在系统性差异——链上 Solidity 使用整数除法、固定的溢出行为和特定的舍入方向，而链下 Python/JavaScript 默认使用浮点数运算。这一差异会导致回测结果与实盘存在不可预测的偏差，轻则影响收益估算准确性，重则导致回测显示盈利而实盘亏损的"回测陷阱"。

**需求目标：** SDK 的数学计算模块必须消除上述差异，确保：
- 策略开发者编写的任何数值计算，其结果与相同逻辑部署到链上后的执行结果完全一致
- 回测阶段的收益/损耗估算与实盘误差控制在可接受范围内（见评估指标体系文档）
- AI Agent 生成的策略参数在链下验证通过后，无需人工二次校验数学逻辑的正确性

**验收标准：** 数学库的验收由验证门控 G2（EVM 仿真精度关卡）负责，具体测试场景和通过阈值见《验证门控标准》文档第三章。

* **1.2 协议适配器注册表 (Adapter Registry)：** 解耦底层协议逻辑（如 Uniswap V3/V4）。底层合约升级时，仅需更新全局 Adapter，千万个 AI 策略无需改动代码。
* **1.3 治理风险感知哨兵 (Governance Sentinel)：** 自动爬取 Snapshot/Tally 提案。当持仓协议出现“修改 LTV”或“增加手续费”等重大变动时，自动熔断相关策略。

### 模块 2：硬核验证与沙盒防线 (Validation & Sandbox)

* **2.1 三源预言机交叉校验 (Triple-Oracle Guard) [新增微调]：**
* **校验逻辑：** 任何决策执行前，必须对比三个独立源的价格：$P_{Chainlink}$、$P_{Uniswap\_TWAP}$、$P_{DEX\_Slot0}$。
* **熔断条件：** 设 $\Delta$ 为偏离阈值（默认 **0.5%**），若满足以下公式则拦截交易：

$$\max(|P_1 - P_2|, |P_2 - P_3|, |P_1 - P_3|) > \Delta$$




* **2.2 不变性风控断言 (Invariant Checking)：** 定义物理底线（如：“单次执行后 U 本位跌幅不得超 **1%**”），模拟破线直接拦截。
* **2.3 极端模糊测试 (Fuzzing) & 影子模式 (Shadow Mode)：** 主动注入极端参数（如 Gas 飙升 **1000** 倍）。新策略需经过“影子模式”实盘压力测试（只跑逻辑不发单）。

### 模块 3：资金运营与确定性执行 (Treasury & Execution)

* **3.1 幂等状态机 (Idempotent FSM) [核心升级]：**
* **自愈逻辑：** 引入交易生命周期管理器。处理“已发单但无 Hash”、“Nonce 冲突”、“RPC 超时”等异常。
* **状态流转：** `INIT -> SIMULATED -> SIGNED -> BROADCASTED -> CONFIRMED/REORG`。


* **3.2 智能路由与原子执行 (Smart Routing & Atomics)：** 集成 Flashbots 等私有中继防夹。确保多步操作（跨链->换币->质押）要么全成，要么全败。
* **3.3 跨链库存再平衡 (Active Inventory Rebalancing)：** 自动监控各链资金利用率。当 Chain A 缺钱而 Chain B 闲置时，自动触发最优路径的资金调度。

### 模块 4：财务会计与数据水位线 (Accounting & Data)

* **4.1 双分录对账与公允价值 (MtM)：** 数据库同步生成借贷分录。自动追踪未领取的奖励（Unclaimed Rewards），防止因账面“未变现收益”导致的风控误杀。
* **4.2 数据水位线监控 (High Watermark) [新增微调]：**
* **同步校验：** 任何发单决策必须强制校验数据源的 `last_sync_block`。
* **熔断逻辑：** 若 $\text{CurrentBlock} - \text{SyncBlock} > 2$，系统立即抛出 `StaleDataError` 并停止发单，防止基于过时状态决策。


* **4.3 软滑点与毒性流审计：** 计算市场冲击成本。若发现被套利者反向收割，自动暂停该策略。

### 模块 5：系统治理与安全宪法 (Governance & Security)

 **5.1 机构级 MPC 签名流（MPC Signing）**

 AI 策略仅生成无签名的 Payload，签名由独立的 MPC 节点根据白名单规则自动完成。

 **大额多签：** 当单笔交易金额超过大额审批阈值时，交易自动挂起，进入人工审批队列，须等待管理员二次确认后方可签名执行。

 > ⚠️ **待评审参数：大额审批阈值**
 > 当前占位值：$10,000
 > 需在项目启动评审会上，结合以下因素确认最终值：预期单笔交易规模中位数、团队审批响应能力（审批人时区覆盖）、可接受的审批等待延迟上限。
 > 确认后填入系统配置中心，本文档同步更新。

---

 **5.2 管理员时间锁（Admin Timelock）**

 修改核心风控参数（如最大滑点阈值、合约白名单）的操作，必须经过时间锁等待期后方可生效。Guardian 钱包拥有"一票否决权"，可在等待期内取消任何变更。

 > ⚠️ **待评审参数：时间锁等待时长**
 > 当前占位值：24 小时
 > 需在项目启动评审会上，结合以下因素确认最终值：团队成员时区分布（需保证所有核心成员有足够时间审查变更）、紧急参数调整的业务需求（是否需要快速通道）、是否参考行业主流实践（如 Compound 使用 48 小时）。
 > 确认后同步更新链上时间锁合约的初始化参数。

* **5.3 全局物理断路器 (Global Kill Switch)：** 一键撤销所有 Token 授权（Revoke）、紧急抽离流动性。

### 模块 6：全链路可观测 (Observability)

* **6.1 全局 Trace ID：** 打通“AI 提议 -> 模拟 -> 签名 -> 广播 -> 确认 -> 对账”全链路日志。
* **6.2 AI 反馈飞轮：** 自动将实际盈亏损耗转化为 Prompt，强制 AI 迭代优化。

---

## 二、 工业化极端场景处理矩阵 (Resiliency Matrix)

| 场景分类 | 极端状况描述 | 系统的确定性响应 (Deterministic Resolution) |
| --- | --- | --- |
| **数据风险** | **RPC 节点同步延迟，AI 以为价格还没涨** | **水位线拦截：** 模块 4.2 检测到 `SyncBlock` 落后，拒绝发单。 |
| **价格风险** | **目标池被闪电贷攻击，Slot0 价格瞬间暴跌** | **三源校验：** 模块 2.1 发现 Slot0 与 Chainlink 偏差超 **0.5%**，拦截模拟。 |
| **网络风险** | **发单后断网，不知交易是否在链上排队** | **FSM 自愈：** 重启后 FSM 读取 `BROADCASTED` 状态，自动查询链上 Nonce。若卡住则触发阶梯 Gas 加速。 |
| **治理风险** | **底层协议宣布要升级合约并迁移流动性** | **治理哨兵：** 爬虫捕获提案，提前标记该协议为“待清理”，AI 提前撤资。 |
| **计算风险** | **回测由于精度舍入，认为赚了 1U，实盘亏了 1U** | **位对齐数学库：** 模块 1.1 强制链下模拟 Solidity 舍入逻辑，消除回测误差。 |

---

## 三、 研发落地阶段规划 (Implementation Roadmap)

### 三、研发落地阶段规划
**说明：** 以下时间估算基于 [待填写：团队规模] 人投入，各阶段时长为参考值，须在项目启动会上结合实际资源确认。
---
**Phase 1：安全地基**（参考工期：6–8 周）
核心交付物：MPC 签名机、Anvil 本地仿真环境、EVM 数学库、基础 DataAPI 框架。
里程碑验收标准（全部满足方可进入 Phase 2）：
- MPC 签名机完成单元测试，可正确处理无签名 Payload 并返回签名结果
- Anvil 环境可对指定历史区块进行分叉，EVM 数学库通过 G2 精度关卡的全部测试用例
- DataAPI 可对接至少 1 条链的实时 RPC，水位线校验逻辑可触发 StaleDataError
主要负责角色：基础设施工程师（MPC + Anvil）、SDK 工程师（数学库 + DataAPI）
---
**Phase 2：会计核算**（参考工期：4–6 周）
核心交付物：Mark-to-Market 估值引擎、双分录账本、数据水位线监控、对账服务。
里程碑验收标准：
- 任意历史区块的账面净值可在 30 秒内准确计算，误差 ≤ 1 wei
- 双分录账本与链上余额对账差异 = 0，通过 100 笔测试交易验证
- 水位线监控可在 SyncBlock 落后超阈值时，在 1 个区块内触发熔断停止发单
主要负责角色：后端工程师（账本 + 对账）、数据工程师（水位线监控）
---
**Phase 3：执行肢体**（参考工期：6–8 周）
核心交付物：幂等 FSM 状态机、跨链库存再平衡、Flashbots 私有 MEV 路由、三源预言机校验。
里程碑验收标准：
- FSM 通过混沌测试：随机 kill 进程 1000 次，零重复执行、零资金丢失
- 跨链再平衡可自动检测链间资金失衡，并完成端到端转账（含对账确认）
- 私有路由与公开 mempool 路由的 MEV 损耗对比测试，私有路由损耗降低 ≥ 50%
主要负责角色：区块链工程师（FSM + 跨链）、MEV 工程师（私有路由）
---
**Phase 4：治理闭环**（参考工期：3–4 周）
核心交付物：24h 管理员时间锁、治理提案爬虫、AI 反馈飞轮、全局 Kill Switch。
里程碑验收标准：
- 时间锁变更操作经过完整 24h 等待期后方可执行，Guardian 一票否决可在 1 分钟内生效
- 治理爬虫可在提案发布后 1 小时内完成捕获并推送告警
- Kill Switch 在生产环境演练中，可在 60 秒内完成所有 Token 授权撤销
- AI 反馈飞轮完成首次端到端测试：退役策略数据成功转化为优化 Prompt 并输入模型
主要负责角色：智能合约工程师（时间锁）、数据工程师（爬虫）、AI 工程师（反馈飞轮）

---

## 附：参数评审检查清单

建议在项目启动时同步评审以下所有待确认参数，避免后期逐个修改：

| 参数 | 占位值 | 需要参考的决策因素 |
|------|--------|------------------|
| 大额审批阈值 | $10,000 | 预期交易规模、审批响应能力 |
| 时间锁等待时长 | 24 小时 | 团队时区、紧急调整需求 |
| 预言机偏差熔断阈值 | 0.5% | 目标交易对的正常价差范围 |
| 数据水位线落后区块数 | 2 个区块 | 可接受的数据延迟 vs 熔断频率 |
| 单策略资金池占比上限 | 5%（Staged）| 风险分散要求、策略信任度 |
| 影子模式最短持续时间 | 72 小时 | 团队审查节奏 |
| 蒙特卡洛最低轮次 | 5,000 轮 | 可接受的统计置信度 vs 计算成本 |