# 🏛️ DeFi 自动化交易与资管基础设施 - PRD 5.1 (终极工业版)

## 零、 顶层设计哲学 (The Philosophy)

打造一个**“多智能体（AI Agents）与人类协同”**的机构级 DeFi 资管中台。系统核心使命：在充满对抗的链上环境中，通过**物理级隔离、金融级对账、确定性执行**，构建一个能够承载千万级美金的自动化交易堡垒。

---

## 一、 六大支柱模块 (The 6 Pillars)

### 模块 1：策略大脑与协议适配 (Strategy & Abstraction)

* **1.1 强类型 AI Schema 与 EVM 仿真数学库：**
* **仿真精度：** SDK 必须内置 EVM 兼容的数学引擎，模拟 Solidity 的溢出检查与舍入逻辑。确保链下计算与链上 `TickMath` 位级对齐。
* **计算公式：** 必须支持 $60+$ 位精度运算，例如在计算 $\sqrt{P}$ 时：

$$\text{price\_safe} = \text{scaling\_factor} \times \text{floor}(\text{evm\_math\_logic})$$




* **1.2 协议适配器注册表 (Adapter Registry)：** 解耦底层协议逻辑（如 Uniswap V3/V4）。底层合约升级时，仅需更新全局 Adapter，千万个 AI 策略无需改动代码。
* **1.3 治理风险感知哨兵 (Governance Sentinel)：** 自动爬取 Snapshot/Tally 提案。当持仓协议出现“修改 LTV”或“增加手续费”等重大变动时，自动熔断相关策略。

### 模块 2：硬核验证与沙盒防线 (Validation & Sandbox)

* **2.1 三源预言机交叉校验 (Triple-Oracle Guard) [新增微调]：**
* **校验逻辑：** 任何决策执行前，必须对比三个独立源的价格：$P_{Chainlink}$、$P_{Uniswap\_TWAP}$、$P_{DEX\_Slot0}$。
* **熔断条件：** 设 $\Delta$ 为偏离阈值（默认 **0.5%**），若满足以下公式则拦截交易：

$$\max(|P_1 - P_2|, |P_2 - P_3|, |P_1 - P_3|) > \Delta$$




* **2.2 不变性风控断言 (Invariant Checking)：** 定义物理底线（如：“单次执行后 U 本位跌幅不得超 **1%**”），模拟破线直接拦截。
* **2.3 极端模糊测试 (Fuzzing) & 影子模式 (Shadow Mode)：** 主动注入极端参数（如 Gas 飙升 **1000** 倍）。新策略需经过“影子模式”实盘压力测试（只跑逻辑不发单）。

### 模块 3：资金运营与确定性执行 (Treasury & Execution)

* **3.1 幂等状态机 (Idempotent FSM) [核心升级]：**
* **自愈逻辑：** 引入交易生命周期管理器。处理“已发单但无 Hash”、“Nonce 冲突”、“RPC 超时”等异常。
* **状态流转：** `INIT -> SIMULATED -> SIGNED -> BROADCASTED -> CONFIRMED/REORG`。


* **3.2 智能路由与原子执行 (Smart Routing & Atomics)：** 集成 Flashbots 等私有中继防夹。确保多步操作（跨链->换币->质押）要么全成，要么全败。
* **3.3 跨链库存再平衡 (Active Inventory Rebalancing)：** 自动监控各链资金利用率。当 Chain A 缺钱而 Chain B 闲置时，自动触发最优路径的资金调度。

### 模块 4：财务会计与数据水位线 (Accounting & Data)

* **4.1 双分录对账与公允价值 (MtM)：** 数据库同步生成借贷分录。自动追踪未领取的奖励（Unclaimed Rewards），防止因账面“未变现收益”导致的风控误杀。
* **4.2 数据水位线监控 (High Watermark) [新增微调]：**
* **同步校验：** 任何发单决策必须强制校验数据源的 `last_sync_block`。
* **熔断逻辑：** 若 $\text{CurrentBlock} - \text{SyncBlock} > 2$，系统立即抛出 `StaleDataError` 并停止发单，防止基于过时状态决策。


* **4.3 软滑点与毒性流审计：** 计算市场冲击成本。若发现被套利者反向收割，自动暂停该策略。

### 模块 5：系统治理与安全宪法 (Governance & Security)

**5.1 机构级 MPC 签名流 (MPC Signing)：** AI 策略仅生成无签名的 Payload，签名由独立的 MPC 节点（如 Fireblocks）根据白名单规则自动完成。**大额多签：** 单笔交易金额超过阈值（默认 **$10,000**）时，交易自动挂起，进入人工审批队列，须等待管理员二次确认后方可签名执行。
* **5.2 管理员时间锁 (Admin Timelock)：** 修改核心风控参数（如最大滑点、白名单）的操作，必须经过 **24 小时时间锁**。Guardian 钱包拥有“一票否决权”。
* **5.3 全局物理断路器 (Global Kill Switch)：** 一键撤销所有 Token 授权（Revoke）、紧急抽离流动性。

### 模块 6：全链路可观测 (Observability)

* **6.1 全局 Trace ID：** 打通“AI 提议 -> 模拟 -> 签名 -> 广播 -> 确认 -> 对账”全链路日志。
* **6.2 AI 反馈飞轮：** 自动将实际盈亏损耗转化为 Prompt，强制 AI 迭代优化。

---

## 二、 工业化极端场景处理矩阵 (Resiliency Matrix)

| 场景分类 | 极端状况描述 | 系统的确定性响应 (Deterministic Resolution) |
| --- | --- | --- |
| **数据风险** | **RPC 节点同步延迟，AI 以为价格还没涨** | **水位线拦截：** 模块 4.2 检测到 `SyncBlock` 落后，拒绝发单。 |
| **价格风险** | **目标池被闪电贷攻击，Slot0 价格瞬间暴跌** | **三源校验：** 模块 2.1 发现 Slot0 与 Chainlink 偏差超 **0.5%**，拦截模拟。 |
| **网络风险** | **发单后断网，不知交易是否在链上排队** | **FSM 自愈：** 重启后 FSM 读取 `BROADCASTED` 状态，自动查询链上 Nonce。若卡住则触发阶梯 Gas 加速。 |
| **治理风险** | **底层协议宣布要升级合约并迁移流动性** | **治理哨兵：** 爬虫捕获提案，提前标记该协议为“待清理”，AI 提前撤资。 |
| **计算风险** | **回测由于精度舍入，认为赚了 1U，实盘亏了 1U** | **位对齐数学库：** 模块 1.1 强制链下模拟 Solidity 舍入逻辑，消除回测误差。 |

---

## 三、 研发落地阶段规划 (Implementation Roadmap)

1. **Phase 1 (地基)：** 搭建 **MPC 签名机**、**Anvil 模拟器**、**EVM 仿真数学库**。*（红线：先有避难所，再谈赚钱。）*
2. **Phase 2 (会计)：** 实现 **Mark-to-Market 估值**、**双分录账本**、**数据水位线监控**。*（红线：账对不平就停机。）*
3. **Phase 3 (肢体)：** 跑通 **幂等状态机 (FSM)**、**跨链再平衡**、**私有 MEV 路由**。*（红线：确保交易“生要见单，死要见尸”。）*
4. **Phase 4 (治理)：** 上线 **24h 管理员时间锁**、**治理提案爬虫**、**AI 反馈闭环**。
