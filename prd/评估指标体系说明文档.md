# DeFi 自动化交易基础设施

> **评估指标体系说明文档**
> *Strategy Evaluation Metrics Framework*
> PRD 附属文档 · 版本 1.1 · 2026

---

## 一、文档目的

本文档定义策略评估阶段（VALIDATED → EVALUATED）使用的完整指标体系，包括每个指标的计算口径、适用场景和优先级关系。目标是确保所有评估结果客观、可复现、可被 AI Agent 自动消费。

指标体系的设计原则：
- **口径统一：** 每个指标的计算公式、单位、时间窗口明确定义，不同策略使用相同口径，结果可横向对比
- **DeFi 适配：** 充分考虑 DeFi 特有因素：Gas 成本、无常损失（IL）、链上延迟、MEV 损耗
- **分层分类：** 指标按收益、风险、成本、效率、健康五类组织，避免单一维度的误导性结论
- **场景差异化：** 回测与蒙特卡洛模拟使用相同指标但不同阈值，链上与链下数据分别追踪

---

## 二、指标全景总览

评估体系共包含 5 大类、25 个核心指标：

| **类别** | **简称** | **涵盖指标** | **核心用途** |
|---|---|---|---|
| **收益类** | RETURN | 净收益率、年化收益率、Sharpe Ratio、Sortino Ratio、Calmar Ratio、盈亏比 | 衡量策略赚多少 |
| **风险类** | RISK | 最大回撤、平均回撤、回撤持续期、波动率、下行波动率、VaR（95%） | 衡量策略亏多少 |
| **成本类** | COST | Gas 成本占比、实际滑点、MEV 损耗估算、无常损失（IL）、协议手续费 | 衡量策略花多少 |
| **效率类** | EFFICIENCY | 资金利用率、交易成功率、平均持仓时长、换手率、信号触发频率 | 衡量资金用得好不好 |
| **健康类** | HEALTH | 对账差异率、数据新鲜度、熔断触发率、链上确认延迟 | 衡量基础设施是否正常 |

---

## 三、收益类指标（RETURN）

收益类指标衡量策略的盈利能力，所有收益均以 U 本位（USDC/USDT）计算，排除代币价格本身的涨跌影响。

### 3.1 净收益率

| **项目** | **定义** |
|---|---|
| 计算公式 | 净收益率 = (期末净值 - 期初净值) / 期初净值 × 100% |
| 计算口径 | 期末净值 = 链上资产 MtM 估值 + 已实现收益 + 未领取奖励 - 未偿还债务 |
| 时间单位 | 以自然日为基准单位，支持任意时间区间聚合 |
| U 本位说明 | 所有资产折算为 USDC，使用三源预言机中位价，非 Slot0 价格 |
| 排除项 | 不包含：代币价格波动导致的账面浮盈浮亏（即非 DeFi 策略收益部分） |

### 3.2 Sharpe Ratio

| **项目** | **定义** |
|---|---|
| 计算公式 | Sharpe = 年化超额收益 / 年化收益标准差 |
| 超额收益 | DeFi 场景无风险利率 = 0（不使用传统金融的国债利率） |
| 年化方式 | 日收益率 × 365，或区块收益率 × (365 × 7200)（按以太坊平均出块数） |
| 收益频率 | 以每个策略执行周期（区块或自定义间隔）为最小单位计算 |
| 适用场景 | 回测（历史数据）和蒙特卡洛模拟（随机路径）均使用此公式 |
| 注意事项 | Sharpe 对正态分布假设敏感，须配合 Sortino Ratio 使用以补充非对称风险信息 |

### 3.3 Sortino Ratio

| **项目** | **定义** |
|---|---|
| 计算公式 | Sortino = 年化超额收益 / 年化下行标准差 |
| 下行标准差 | 仅统计收益为负的周期，正收益周期不计入分母 |
| 优势 | 比 Sharpe 更适合 DeFi 策略：上涨波动不应被惩罚，只有下行风险才是真正风险 |
| 与 Sharpe 的关系 | Sortino ≥ Sharpe（因为分母更小），两者差距越大说明策略上行弹性越好 |

### 3.4 盈亏比（Profit Factor）

| **项目** | **定义** |
|---|---|
| 计算公式 | Profit Factor = 总盈利之和 / \|总亏损之和\| |
| 统计粒度 | 以每次完整的开仓-平仓为一个计算单元 |
| 解读方式 | PF = 1.3 表示每亏 1U，平均盈利 1.3U；PF < 1 表示长期必亏 |
| 注意事项 | 样本量须 ≥ 30 次完整交易，样本过少的 PF 无统计意义 |

---

## 四、风险类指标（RISK）

风险类指标衡量策略的损失暴露程度，是验证门控中权重最高的一类。

### 4.1 最大回撤（MDD）

| **项目** | **定义** |
|---|---|
| 计算公式 | MDD = (波峰净值 - 波谷净值) / 波峰净值 × 100% |
| 统计方式 | 以策略全生命周期的历史最高净值为波峰起点，滚动计算 |
| U 本位 | 所有净值以 USDC 计价，排除代币价格波动 |
| 与 Calmar 的关系 | Calmar Ratio = 年化收益率 / MDD，综合衡量每单位回撤换来多少收益 |
| 预警机制 | 实时 MDD 超过回测 MDD 的 1.5 倍时，自动触发策略暂停告警 |

### 4.2 下行波动率

| **项目** | **定义** |
|---|---|
| 计算公式 | 下行标准差 = sqrt(mean(min(r - target, 0)^2))，target 通常取 0 |
| 与普通波动率的区别 | 普通波动率惩罚上涨波动；下行波动率只关注亏损周期的离散程度 |
| 适用场景 | 做市策略和收益聚合策略更应关注下行波动率，而非总波动率 |

### 4.3 VaR（95% 置信区间）

| **项目** | **定义** |
|---|---|
| 含义 | 在 95% 的情况下，单日最大损失不超过 VaR 值 |
| 计算方法 | 历史模拟法：取历史日收益分布的第 5 百分位数（负值取绝对值） |
| 报告形式 | 以 U 本位绝对金额表示，如「VaR(95%) = $3,200」 |
| 局限性 | VaR 不描述超出置信区间后的极端损失，须配合压力测试结果使用 |

---

## 五、成本类指标（COST）

成本类指标是 DeFi 策略评估中最容易被忽视、也最容易导致「回测盈利实盘亏损」的关键维度。

### 5.1 Gas 成本占比

| **项目** | **定义** |
|---|---|
| 计算公式 | Gas 占比 = 累计 Gas 费用 / 累计毛收益 × 100% |
| Gas 费用计算 | = gasUsed × effectiveGasPrice，以执行时 ETH 价格折算为 USDC |
| 统计范围 | 包含策略执行的全部交易：开仓、平仓、再平衡、收益领取 |
| 净收益公式 | 净收益 = 毛收益 - Gas 费用 - 滑点损耗 - 协议手续费 - MEV 损耗 |
| 注意事项 | 回测中须使用历史真实 Gas 数据，不得使用当前 Gas 价格估算历史成本 |

### 5.2 无常损失（IL）

| **项目** | **定义** |
|---|---|
| 定义 | 提供流动性相比直接持有资产的机会成本损失 |
| 计算公式 | IL = 2 × sqrt(price_ratio) / (1 + price_ratio) - 1，price_ratio = 现价 / 入场价 |
| 适用策略 | 仅适用于 AMM 做市策略（Uniswap V3/V4 集中流动性） |
| 报告形式 | 以百分比表示，并换算为 U 本位绝对金额 |
| 与手续费收入的关系 | 净做市收益 = 手续费收入 - 无常损失；两者必须同时追踪，不可只看其一 |

### 5.3 MEV 损耗估算

| **项目** | **定义** |
|---|---|
| 含义 | 策略交易被夹击（sandwich）或抢先（frontrun）导致的额外滑点损耗 |
| 估算方法 | 对比交易的预期执行价（提交时）与实际执行价（上链后），差值即为 MEV 损耗估算 |
| 使用 Flashbots 的影响 | 私有中继可降低 MEV 损耗，须分别统计公开 mempool 与私有路由的损耗差异 |
| 报告触发 | 单次 MEV 损耗超过交易规模 0.3% 时，记录为高危 MEV 事件，纳入策略风险评分 |

---

## 六、效率类指标（EFFICIENCY）

效率类指标衡量策略对资金的使用效率和执行质量，是识别「占着资金不干活」问题的关键维度。

### 6.1 资金利用率

| **项目** | **定义** |
|---|---|
| 计算公式 | 资金利用率 = 平均活跃持仓规模 / 分配给策略的资金总量 × 100% |
| 统计周期 | 以每日收盘时的持仓快照计算，取评估区间内的算术平均 |
| 解读 | < 40%：资金大量闲置，策略效率低；40%–80%：正常范围；> 90%：警惕过度杠杆 |
| 注意事项 | 跨链再平衡策略的「在途资金」须计入活跃持仓，不得计为闲置 |

### 6.2 交易成功率

| **项目** | **定义** |
|---|---|
| 计算公式 | 成功率 = 成功确认的交易数 / 发起的交易总数 × 100% |
| 失败分类 | 链上 Revert / Gas 不足 / 签名超时 / 滑点超限自动取消 / Nonce 冲突 |
| 分类统计 | 须分别统计各类失败原因的占比，以便定向优化 |
| 关联指标 | 高失败率通常伴随 Gas 浪费（revert 交易仍消耗 Gas）和执行延迟 |

### 6.3 换手率

| **项目** | **定义** |
|---|---|
| 计算公式 | 年化换手率 = (买入总额 + 卖出总额) / 2 / 平均净值 × (365 / 统计天数) |
| 用途 | 换手率过高通常意味着 Gas 成本侵蚀显著；换手率过低可能意味着策略响应迟钝 |
| 参考范围 | 做市策略：100%–500%/年；套利策略：1000%–5000%/年；收益聚合：10%–100%/年 |

---

## 七、健康类指标（HEALTH）

健康类指标衡量基础设施层的运行质量，是策略能否稳定生产的前提条件。健康类指标不计入收益评分，但任何一项严重异常均可触发策略暂停。

| **指标** | **计算方式** | **健康阈值** | **异常触发动作** |
|---|---|---|---|
| 对账差异率 | 账本余额与链上实际余额之差 / 链上余额 | = 0（零容忍） | 立即暂停策略，触发人工核查 |
| 数据新鲜度 | 当前区块 - 最新同步区块（SyncBlock） | ≤ 2 个区块 | 抛出 StaleDataError，停止发单 |
| 熔断触发率 | 每日三源预言机熔断次数 | ≤ 5 次 / 天 | 超出则审查阈值设置是否合理 |
| 链上确认延迟 | 从广播到 CONFIRMED 的平均等待区块数 | ≤ 3 个区块（正常 Gas） | 延迟过长触发阶梯 Gas 加速 |
| FSM 异常率 | 进入非预期状态（如卡在 BROADCASTED）的交易占比 | ≤ 0.1% | 记录异常，触发自愈逻辑 |

---

## 八、指标优先级与综合评分

当多项指标出现冲突时，按以下优先级框架进行综合判断：

### 8.1 指标层级

> **两层阈值体系说明：**
> - **系统底线（不可逾越）**：本文档定义的全部阈值（如 Sharpe ≥ 1.0、MDD ≤ 20%）为全局最低标准。AI Agent 自动判断以系统底线为准。
> - **策略自定义阈值（只能加严）**：开发者可在策略元数据中声明更高要求（如 Sharpe ≥ 1.5）。自定义阈值只能高于系统底线，不能低于。
> - **冲突裁决规则**：若开发者设定值低于系统底线（如设 Sharpe > 0.5），系统自动以底线值（≥ 1.0）为准，并在验证报告中输出 `THRESHOLD_OVERRIDE` 警告，提示开发者修正配置。

| **层级** | **类别** | **指标** | **规则** |
|---|---|---|---|
| L1（否决） | 健康类全部 | 对账差异率、数据新鲜度 | 任意一项异常 → 立即否决，不进行后续评分 |
| L2（硬性） | 风险类核心 | 最大回撤、VaR(95%) | 超过阈值 → 整体判定失败，不可用其他指标抵消 |
| L3（主评） | 收益类核心 | Sharpe、Sortino、Profit Factor | 核心评分指标，决定策略是否达到上线标准 |
| L4（成本） | 成本类全部 | Gas 占比、IL、MEV 损耗 | 成本过高单独判定失败，不与收益指标互补 |
| L5（参考） | 效率类 | 资金利用率、换手率 | 不作为硬性门控，仅作为优化建议输出 |

### 8.2 综合评分计算

通过所有硬性门控（L1–L4）后，系统计算综合评分用于策略排名和优化方向指引：

| **维度** | **权重** | **计算方式** |
|---|---|---|
| 收益得分 | 40% | Sharpe、Sortino、Calmar 归一化后加权平均 |
| 风险得分 | 30% | MDD、下行波动率反向归一化（越低越好） |
| 成本得分 | 20% | Gas 占比、IL、MEV 损耗反向归一化 |
| 效率得分 | 10% | 资金利用率、交易成功率归一化平均 |

**说明：** 综合评分（0–100 分）仅用于策略横向比较和 AI 优化方向指引，不作为上线的硬性门控。上线唯一标准是通过 G1–G8 全部关卡。

---

## 九、回测与蒙特卡洛的指标差异

同一套指标在不同评估场景下的计算数据源和参考阈值存在差异：

| **指标** | **回测数据源** | **回测阈值** | **蒙卡数据源** | **蒙卡阈值** |
|---|---|---|---|---|
| Sharpe Ratio | 历史真实区块数据 | ≥ 1.0 | 随机路径模拟收益 | 中位数 ≥ 0.8 |
| 最大回撤 | 历史净值曲线 | ≤ 20% | 5000 轮模拟的最差分位 | 最差 5% 分位 ≤ 40% |
| 净收益率 | 历史真实 PnL | 正数即可 | 收益分布 | 正收益轮次占比 ≥ 60% |
| Gas 成本占比 | 历史真实 Gas 记录 | ≤ 30% | 基于 Gas 随机化模拟 | 中位数 ≤ 35% |
| 资金利用率 | 历史持仓快照 | ≥ 40% | 模拟平均持仓比例 | 中位数 ≥ 35% |

**重要原则：** 回测与蒙特卡洛均须通过，两者互补而非互代。回测验证历史表现，蒙卡验证统计鲁棒性。若回测优异但蒙卡结果发散，说明策略对特定历史路径过拟合。

---

## 十、评估报告输出规范

评估完成后，SDK 自动生成标准评估报告，须包含以下内容：
- **基础信息：** strategy_id、version_hash、评估时间戳、数据区块范围、随机数种子
- **逐指标明细：** 25 个指标的实际值、阈值、达标状态（PASS/FAIL/WARN）、偏差百分比
- **综合评分：** 各维度得分和总分，含得分的文字解读（如「Gas 成本偏高，建议优化执行频率」）
- **蒙卡分布图：** 收益分布直方图数据（供前端可视化），含均值、中位数、置信区间标注
- **AI 优化建议：** 基于不达标指标，自动生成针对性的优化方向描述，输入 AI 反馈飞轮
- **对比基准：** 若存在同类型的历史策略，自动附上横向对比得分差异

---

## 十一、文档版本记录

| **版本** | **日期** | **变更内容** | **作者** |
|---|---|---|---|
| v1.0 | 2026-02-25 | 初始版本，定义 5 大类 25 个核心指标及计算口径 | DeFi 策略团队 |
| v1.1 | 2026-02-25 | 依据审查意见修正：延迟预算重构（两档仿真）、大额审批按状态差异化、告警阈值与熔断同步、时间锁适用边界澄清、指标双重标准统一 | DeFi 策略团队 |
