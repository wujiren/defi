# 架构文档重构实施计划 v1.0

> 审查用途：本计划描述从现有 18 份散乱文档，重构为结构化文档体系的完整步骤。
> 每个阶段完成后需审查确认，再进入下一阶段。

---

## 一、总体原则

| 原则 | 说明 |
|---|---|
| 内容优先于新增 | 优先整合已有内容，只在有明确空白时才新写 |
| 逐阶段交付 | 每阶段产出可独立阅读的文档，不等全部完成再交付 |
| 来源可追溯 | 每份目标文档注明内容来自哪些源文件，方便校对 |
| PRD 不动 | PRD 及其附属文档（指标体系、门控标准等）不纳入重构范围，保持原样 |

---

## 二、目标文档结构

```
📄 README.md                         ← 导读总览（新写）
📁 01_部署架构/
   ├── 1.1_三区网络拓扑.md            ← 合并
   ├── 1.2_容器资源配额.md            ← 提取
   └── 1.3_网络安全策略.md            ← 提取
📁 02_数据总线与契约/
   ├── 2.1_Protobuf契约.md            ← 合并去重
   ├── 2.2_Redis_Stream实时管道.md    ← 合并去重
   ├── 2.3_多链数据统一规范.md        ← 提取自PRD附属文档
   └── 2.4_历史数据归档.md            ← 提取
📁 03_核心执行引擎/
   ├── 3.1_策略Agent与水位线拦截.md   ← 合并
   ├── 3.2_验证层：EVM仿真与预言机.md ← 合并
   ├── 3.3_幂等状态机FSM.md           ← 整理
   ├── 3.4_MEV路由与防夹执行.md       ← 独立
   └── 3.5_数据库Schema汇总.md        ← 提取汇总
📁 04_财务与结算/
   ├── 4.1_双分录会计系统.md          ← 整理
   └── 4.2_资产估值与审计.md          ← 整理
📁 05_安全防御/
   ├── 5.1_MPC签名与白名单拦截.md     ← 整理
   ├── 5.2_治理风险哨兵.md            ← 从模块1迁移
   └── 5.3_全局断路器与时间锁.md      ← 整理
📁 06_可观测性/
   ├── 6.1_全链路Trace_ID规范.md      ← 整理
   ├── 6.2_Prometheus指标定义.md      ← 新写
   ├── 6.3_告警规则集.md              ← 新写
   └── 6.4_AI反馈飞轮.md              ← 从模块6迁移补全
📁 07_验证与回测/
   ├── 7.1_回测引擎与数据接口.md      ← 整理
   └── 7.2_G1-G8门控实现细节.md       ← 整理对齐
📁 08_参考实现/
   ├── Go_轻量仿真器原型.md           ← 直接迁移
   └── Python_策略Agent基类.md        ← 直接迁移
```

---

## 三、分阶段实施计划

### 阶段 0：基础框架（第1步）

**目标：** 建立导读文档，让整个体系有"地图"

**产出：** `README.md`

**内容清单：**
- §0.1 SSOT 声明（PRD 管指标主权，Arch 管实现主权）
- §0.2 版本管理策略（变更审批流、版本对应表）
- §0.3 端到端请求链路（从 AI 信号到链上确认的完整流程，带章节索引）
- §0.4 G1-G8 实现导航表（关卡 → 对应实现章节的映射）
- §0.5 文档索引（全部文档列表 + 一句话说明）

**来源文件：** 无（新写，内容从各模块提炼关键节点）

**注意事项：**
- §0.3 端到端链路是新写内容，需要从各模块文档中提炼关键节点
- §0.4 导航表需要与 PRD 的`验证门控标准说明文档.md`的 G1-G8 定义对齐

---

### 阶段 1：部署架构（第2-4步）

**目标：** 解决两份部署文档命名不统一、内容重叠的问题

#### 第2步：1.1_三区网络拓扑.md

**操作类型：** 合并

**来源文件：**
- `系统部署架构图_物理隔离版_.md`（主体内容）
- `部署架构_基于_Docker_的微服务分发配置.md`（补充容器分布描述）

**整合规则：**
- 统一区域命名：Zone A = 策略计算区，Zone B = 模拟验证区，Zone C = 核心签名区
- 两份文档的三区描述合并，去除重复的"隔离策略"段落
- 保留"极端故障下的物理响应"章节（目前只在物理隔离版中）

**冲突点：** 两份文档的 Zone 命名不一致，以`系统部署架构图`的逻辑区名为准，用 Docker 文档的 Zone A/B/C 作为别名注释

#### 第3步：1.2_容器资源配额.md

**操作类型：** 提取

**来源文件：**
- `部署架构_基于_Docker_的微服务分发配置.md`（第2节：容器资源规格与配额）

**整合规则：**
- 直接提取资源配额表格
- 补充说明各容器对应的逻辑模块（如 Go-Core-Engine 对应模块3 FSM）

#### 第4步：1.3_网络安全策略.md

**操作类型：** 提取

**来源文件：**
- `部署架构_基于_Docker_的微服务分发配置.md`（第3节：Docker 网络拓扑与安全）
- `系统部署架构图_物理隔离版_.md`（物理组件与网络拓扑表格）

**整合规则：**
- Docker 网络配置（YAML片段）+ 物理环境对照表合并为一份
- 防火墙规则和 VPC 配置统一在此处，其他文档引用本节

---

### 阶段 2：数据总线与契约（第5-8步）

**目标：** 解决两份 Proto 文档重复、两份 Redis 文档重复的问题

#### 第5步：2.1_Protobuf契约.md

**操作类型：** 合并去重

**来源文件：**
- `_全套_proto_契约文件汇编.md`（主体，包含 common/trading/data_stream 三个文件）
- `核心交易_Protobuf_契约定义.md`（包含更详细的设计解析）

**整合规则：**
- Proto 定义以`全套汇编`为准（更完整，包含三个 proto 文件）
- "设计关键点深度解析"章节从`核心交易定义`文档中保留并追加
- 删除两份文档中完全重复的 BigAmount、Context 定义，只保留一处

**重复内容清单（需去除其中一份）：**
- BigAmount 消息定义（两份文档各有一份，内容相同）
- Context 消息定义（两份文档各有一份，内容相同）
- TradeRequest/TradeResponse（结构相同，字段注释略有差异，以更详细的为准）

#### 第6步：2.2_Redis_Stream实时管道.md

**操作类型：** 合并去重

**来源文件：**
- `数据基础设施_基于_Redis_Stream_的_Pub-Sub_流转拓扑.md`（主体：四层模型 L1-L4、Topic 划分）
- `数据层_基于_Redis_Stream_的多_Agent_高频推送架构.md`（补充：Python 消费侧、性能指标）

**整合规则：**
- 以四层模型（L1-L4）为骨架组织内容
- L1/L2（Go 生产者）部分从"多 Agent 推送架构"文档中补充细节
- L4（Python 消费者）部分从"多 Agent 推送架构"文档完整移入
- 性能指标表格保留（目前只在"多 Agent"文档中）
- 架构演进（NATS/Kafka）章节保留在末尾

**重复内容清单（需去除其中一份）：**
- Consumer Group 机制说明（两份文档均有，合并为一段）
- ACK 可靠性闭环描述（两份文档均有，合并为一段）
- StaleDataError 触发逻辑（两份文档均有，保留更详细的版本）

#### 第7步：2.3_多链数据统一规范.md

**操作类型：** 提取

**来源文件：**
- `数据基础设施规范.md`（PRD 附属文档，第八节：多链数据统一规范）

**整合规则：**
- 直接提取第八节内容（时间基准、代币标识、价格基准、跨链在途、Gas 折算）
- 在文档头部说明：本文档是架构实现规范，对应 PRD 数据基础设施规范 §8

#### 第8步：2.4_历史数据归档.md

**操作类型：** 提取整理

**来源文件：**
- `模块_7_数据归档与回测引擎.md`（7.1 架构设计、7.3 归档服务设计）
- `数据基础设施规范.md`（第四节：历史数据规范）

**整合规则：**
- 归档服务（Go Archiver）+ ETL 管道架构 + 数据存储规范合并
- IDataProvider 接口定义移至 §7.1（回测引擎），此处只保留归档侧

---

### 阶段 3：核心执行引擎（第9-13步）

**目标：** 重组执行链路，Sync Sentinel 前置，MEV 独立成节

#### 第9步：3.1_策略Agent与水位线拦截.md

**操作类型：** 合并

**来源文件：**
- `Python_模块_策略_Agent_的_gRPC_客户端基类.md`（BaseStrategyAgent 实现）
- `模块_4_财务会计与数据水位线.md`（§4.1 Sync Sentinel 部分 + Go 实现代码）

**整合规则：**
- 文档结构：① Sync Sentinel 水位线拦截（Go 实现，前置为第一节）→ ② Python Agent 基类（消费侧水位线感知）
- 强调两者的联动：Python 的 `last_seen_block` → gRPC Context → Go 端 Sentinel 校验
- 评价标准表格合并（保留两者中更严格的指标）

#### 第10步：3.2_验证层：EVM仿真与三源预言机.md

**操作类型：** 合并整理

**来源文件：**
- `模块_2_硬核验证与沙盒防线.md`（§2.1 三源预言机、§2.2 不变性断言）
- `Go_模块_基于_StateDB_的轻量仿真器原型实现.md`（仿真器实现细节）
- `模块_1_策略大脑与协议适配.md`（§1.1 EVM 仿真数学库）

**整合规则：**
- 文档结构：① 三源预言机校验 → ② EVM 仿真执行（StateDB + 轻量仿真器）→ ③ 不变性断言
- M1 §1.1 的数学库描述和 Go 仿真器原型合并为完整实现描述
- Fuzzing 和影子模式的概述保留在此，实现细节引用 §7.2

#### 第11步：3.3_幂等状态机FSM.md

**操作类型：** 整理（内容最完整，基本保留）

**来源文件：**
- `模块_3_幂等状态机_FSM_.md`（主体，基本完整）

**整合规则：**
- 内容基本保留，补充以下两点：
  - 在状态流转表中标注各状态对应的 Prometheus 指标埋点（`fsm_state_count`）
  - 在 BROADCASTED 状态说明中添加对 §3.4 MEV 路由的引用
- 删除模块末尾"模块评价标准"中关于 MEV 的内容（已移至 3.4）

#### 第12步：3.4_MEV路由与防夹执行.md

**操作类型：** 独立整理

**来源文件：**
- `模块_8_MEV_路由与防夹执行.md`（完整迁移）

**整合规则：**
- 内容直接迁移，调整与 FSM 的接口说明（FSM 的 BROADCASTED 阶段调用本模块）
- 在文档头部说明：本模块在 FSM §3.3 的 BROADCASTED 阶段被调用

#### 第13步：3.5_数据库Schema汇总.md

**操作类型：** 提取汇总

**来源文件：**
- `模块_3_幂等状态机_FSM_.md`（§3.3 trade_tasks、nonce_locks）
- `模块_4_财务会计与数据水位线.md`（§4.4 accounts、asset_balances、ledger_entries、unclaimed_rewards）

**整合规则：**
- 将散落在两个模块中的全部 SQL Schema 汇总到一处
- 按所属层级组织：执行层表（trade_tasks、nonce_locks）→ 财务层表（accounts、ledger_entries 等）
- 每张表注明"由哪个模块写入、由哪个模块读取"

---

### 阶段 4：财务与安全（第14-19步）

#### 第14步：4.1_双分录会计系统.md

**操作类型：** 整理

**来源文件：**
- `模块_4_财务会计与数据水位线.md`（§4.2 双分录会计、§4.4 数据库设计中的财务部分）

**整合规则：**
- Schema 部分引用 §3.5（已汇总），此处只保留业务逻辑
- 补充跨链在途资金的双分录处理规则（来自 Redis Stream 文档的 §3.3 Saga 模式描述）

#### 第15步：4.2_资产估值与审计.md

**操作类型：** 整理

**来源文件：**
- `模块_4_财务会计与数据水位线.md`（§4.3 审计与风控感知）

**整合规则：**
- 软滑点审计 + 毒性流分析 + MtM 公允价值合并
- 与 §6.3 告警规则的联动关系需标注（毒性流触发告警）

#### 第16步：5.1_MPC签名与白名单拦截.md

**操作类型：** 整理

**来源文件：**
- `模块_5_安全堡垒与治理风控.md`（§5.1 MPC 架构、§5.2 白名单拦截 Go 代码）

**整合规则：**
- 内容基本保留
- 大额审批需补充 LIVE 阶段的相对比例规则（资金 15%），目前文档只有 STAGED 的 $10,000 绝对值阈值
- 与 PRD `策略生命周期定义说明文档.md` §3.5/§3.6 对齐

#### 第17步：5.2_治理风险哨兵.md

**操作类型：** 迁移

**来源文件：**
- `模块_1_策略大脑与协议适配.md`（§1.3 治理风险感知哨兵）
- `模块_9_验证门控_G1-G8.md`（G7 治理环境感应部分）

**整合规则：**
- 从模块 1 迁出，归入安全防御篇
- G7 门控的触发逻辑合并进来（哨兵捕获提案 → 触发 G7 熔断）

#### 第18步：5.3_全局断路器与时间锁.md

**操作类型：** 整理

**来源文件：**
- `模块_5_安全堡垒与治理风控.md`（§5.3 时间锁 + §5.4 全局断路器）

**整合规则：**
- 内容基本保留
- Kill Switch 的触发路径补充说明：Web Portal → Zone B → Zone C 的调用链

#### 第19步：5.1 补充——大额审批双阈值对齐

**操作类型：** 内容补充（修复 PRD 与架构文档的冲突）

**冲突说明：**
- PRD `策略生命周期定义说明文档.md` 明确区分两种阈值：
  - STAGED 阶段：绝对金额 $10,000
  - LIVE 阶段：相对比例，单笔 > 当前分配资金 15%
- 现有架构文档（模块 5、模块 9）只提到 $10,000，缺少 LIVE 阶段的相对比例

**修复方式：** 在 §5.1 中新增"审批阈值按状态差异化"章节，对应两种情形

---

### 阶段 5：可观测性（第20-23步）

#### 第20步：6.1_全链路Trace_ID规范.md

**操作类型：** 整理迁移

**来源文件：**
- `全链路_Trace_ID_的日志规范.md`（完整迁移，内容已较完整）

**整合规则：**
- 内容基本保留
- 补充与 §6.2 Prometheus 指标的联动（Trace ID 触发的延迟告警对应哪个 Metric）

#### 第21步：6.2_Prometheus指标定义.md

**操作类型：** 新写

**内容清单（从各模块的关键数值提炼）：**

| 指标名 | 类型 | 含义 | 来源模块 |
|---|---|---|---|
| `fsm_state_count` | Counter | FSM 各状态的转换次数 | 模块3 |
| `fsm_stuck_total` | Counter | 卡死在某状态超时的任务数 | 模块3 |
| `rpc_latency_ms` | Histogram | RPC 节点响应延迟 | 模块4 |
| `watermark_lag_blocks` | Gauge | 当前数据水位线滞后区块数 | 模块4 |
| `oracle_deviation_bps` | Gauge | 三源预言机最大价格偏差（万分位） | 模块2 |
| `strategy_pnl_usd` | Gauge | 各策略实时 PnL（U 本位） | 模块4 |
| `mev_loss_bps` | Histogram | MEV 损耗分布（万分位） | 模块8 |
| `recovery_trigger_total` | Counter | Recovery Manager 自愈触发次数 | 模块3 |
| `approval_pending_total` | Gauge | 当前待审批的大额交易数 | 模块5 |
| `nonce_conflict_total` | Counter | Nonce 冲突发生次数 | 模块3 |

#### 第22步：6.3_告警规则集.md

**操作类型：** 新写（从各模块的熔断条件提炼）

**内容清单：**

| 告警名 | 触发条件 | 级别 | 对应模块 |
|---|---|---|---|
| `CriticalWatermarkLag` | watermark_lag > 2 blocks | CRITICAL | §3.1 |
| `OraclePriceSkew` | oracle_deviation > 50 bps | CRITICAL | §3.2 |
| `FSMTaskStuck` | BROADCASTED 状态 > 5 min | WARNING | §3.3 |
| `HighRecoveryRate` | recovery_trigger > 5次/小时 | WARNING | §3.3 |
| `ApprovalQueueBacklog` | approval_pending > 3 | WARNING | §5.1 |
| `StrategyDrawdownAlert` | 实时 MDD > 回测 MDD × 1.5 | CRITICAL | §4.2 |
| `ToxicFlowDetected` | 毒性流审计命中 | WARNING | §4.2 |
| `RPCNodeDown` | 全部主备 RPC 节点无响应 | CRITICAL | §3.1 |

#### 第23步：6.4_AI反馈飞轮.md

**操作类型：** 补全

**来源文件：**
- `模块_6_全链路可观测.md`（§6.2 AI 反馈飞轮，内容极简，需大幅补全）
- PRD `评估指标体系说明文档.md`（第十节：评估报告输出规范中的 AI 优化建议部分）
- PRD `策略生命周期定义说明文档.md`（§3.8 DEPRECATED 状态的 AI 利用描述）

**需补全的内容：**
- 量化评分到 Prompt 的转化流程（哪些指标触发哪类优化建议）
- 退役策略数据的归档和语料清洗流程
- 飞轮闭环：链上结果 → 评分 → Prompt → 新策略迭代

---

### 阶段 6：验证与回测（第24-25步）

#### 第24步：7.1_回测引擎与数据接口.md

**操作类型：** 整理合并

**来源文件：**
- `模块_7_数据归档与回测引擎.md`（§7.1 架构设计、§7.2 IDataProvider 接口）
- `数据基础设施规范.md`（第四节：历史数据规范，第六节：统一数据访问接口）

**整合规则：**
- IDataProvider 接口（Python 侧）+ DataAPI 接口（SDK 侧）合并说明
- 强调回测和实盘使用相同接口、不同数据源（依赖注入模式）
- BacktestProvider 实现细节完整保留

#### 第25步：7.2_G1-G8门控实现细节.md

**操作类型：** 整理对齐（解决最关键的跨文档冲突）

**来源文件：**
- `模块_9_验证门控_G1-G8_策略生命周期管理.md`（架构侧实现描述）
- PRD `验证门控标准说明文档.md`（权威定义，不可修改）

**对齐规则：**
- 本文档以 PRD 门控标准为准（PRD = 指标主权）
- 架构文档描述"如何实现"，不重复定义"通过标准"
- 门控编号和名称必须与 PRD 完全一致

**当前冲突需修复：**

| 冲突项 | PRD 定义 | 模块9现状 | 修复方式 |
|---|---|---|---|
| G1 名称 | 静态分析 | Static & Schema | 统一为 PRD 名称，括号内保留英文 |
| G3 含义 | 不变性断言 | Backtest Scoring（回测） | 重新对应，G3=不变性，G5=回测 |
| G4 含义 | 极端 Fuzzing | Fuzzing Test（一致） | 基本一致，细节对齐 |
| G5 含义 | 历史回测 | Flow Audit（滑点审计） | 重新对应 |
| G6 含义 | 蒙特卡洛模拟 | Shadow Mode | 重新对应 |
| G7 含义 | 影子模式对比 | Gov Sentinel | 重新对应 |
| G8 含义 | Staged 验收 | MPC Approval | 重新对应 |

---

### 阶段 7：参考实现（第26-27步）

#### 第26步：Go_轻量仿真器原型.md

**操作类型：** 直接迁移

**来源文件：** `Go_模块_基于_StateDB_的轻量仿真器原型实现.md`

**整合规则：** 内容完整，直接迁移。补充与 §3.2 的引用关系说明。

#### 第27步：Python_策略Agent基类.md

**操作类型：** 直接迁移

**来源文件：** `Python_模块_策略_Agent_的_gRPC_客户端基类.md`

**整合规则：** 内容完整，直接迁移。补充与 §3.1 的引用关系说明。

---

## 四、废弃文档清单

重构完成后，以下文档被新文档完全覆盖，可以归档：

| 废弃文档 | 内容去向 |
|---|---|
| `系统部署架构图_物理隔离版_.md` | → §1.1 + §1.3 |
| `部署架构_基于_Docker_的微服务分发配置.md` | → §1.1 + §1.2 + §1.3 |
| `_全套_proto_契约文件汇编.md` | → §2.1 |
| `核心交易_Protobuf_契约定义.md` | → §2.1 |
| `数据基础设施_基于_Redis_Stream_的_Pub-Sub_流转拓扑.md` | → §2.2 |
| `数据层_基于_Redis_Stream_的多_Agent_高频推送架构.md` | → §2.2 |
| `模块_1_策略大脑与协议适配.md` | → §3.2（主体）+ §5.2（治理哨兵） |
| `模块_2_硬核验证与沙盒防线.md` | → §3.2 |
| `模块_3_幂等状态机_FSM_.md` | → §3.3 + §3.5 |
| `模块_4_财务会计与数据水位线.md` | → §3.1（Sentinel）+ §4.1 + §4.2 + §3.5 |
| `模块_5_安全堡垒与治理风控.md` | → §5.1 + §5.3 |
| `模块_6_全链路可观测.md` | → §6.4（补全后） |
| `模块_7_数据归档与回测引擎.md` | → §2.4 + §7.1 |
| `模块_8_MEV_路由与防夹执行.md` | → §3.4 |
| `模块_9_验证门控_G1-G8.md` | → §7.2（对齐后） |
| `全链路_Trace_ID_的日志规范.md` | → §6.1 |
| `Go_模块_基于_StateDB_的轻量仿真器原型实现.md` | → §08参考实现 |
| `Python_模块_策略_Agent_的_gRPC_客户端基类.md` | → §08参考实现 |

---

## 五、执行顺序与优先级

```
优先级 P0（地基，其他文档依赖）：
  第1步  → README.md
  第25步 → 7.2_G1-G8门控对齐（修复最关键冲突）

优先级 P1（核心执行链路）：
  第9步  → 3.1_策略Agent与水位线拦截
  第10步 → 3.2_验证层
  第11步 → 3.3_幂等状态机FSM
  第13步 → 3.5_数据库Schema汇总

优先级 P2（支撑层）：
  第5步  → 2.1_Protobuf契约（合并去重）
  第6步  → 2.2_Redis_Stream（合并去重）
  第16步 → 5.1_MPC签名（补充双阈值）
  第20步 → 6.1_Trace_ID规范

优先级 P3（补全层）：
  第2-4步  → 部署架构三份文档
  第7-8步  → 多链规范 + 数据归档
  第12步   → 3.4_MEV路由
  第14-15步 → 财务与结算
  第17-18步 → 治理哨兵 + 断路器
  第21-23步 → Prometheus指标 + 告警 + AI飞轮
  第24步   → 7.1_回测引擎
  第26-27步 → 参考实现迁移
```

---

## 六、各阶段交付物与审查检查点

| 阶段 | 交付文档数 | 关键审查点 |
|---|---|---|
| 阶段0 | 1（README） | 端到端链路是否完整；G1-G8 导航表是否与 PRD 对齐 |
| 阶段1 | 3（部署架构） | Zone 命名是否统一；物理隔离描述是否清晰 |
| 阶段2 | 4（数据总线） | 两份重复文档合并后是否有内容遗漏 |
| 阶段3 | 5（执行引擎） | Sync Sentinel 前置后逻辑是否自洽；MEV 独立后引用关系是否完整 |
| 阶段4 | 6（财务+安全） | 大额审批双阈值是否补全；治理哨兵迁移是否完整 |
| 阶段5 | 4（可观测性） | Prometheus 指标覆盖是否完整；告警阈值是否与 PRD 一致 |
| 阶段6 | 2（验证回测） | G1-G8 编号是否与 PRD 完全一致 |
| 阶段7 | 2（参考实现） | 代码示例与对应章节的引用关系是否正确 |

**总计：** 27 步操作，产出 27 份文档（含 README），废弃 18 份旧文档

---

*计划版本：v1.0 | 待审查确认后开始执行*
