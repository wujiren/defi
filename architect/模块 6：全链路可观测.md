## 模块 6：AI 反馈飞轮与 Prompt 模板设计

### 1. 反馈数据流转逻辑 (Feedback Data Flow)

为了让 AI 能够“听懂”链上发生的复杂情况，反馈飞轮遵循以下数据处理路径：

1. **数据采集 (Go Layer)**：从 PostgreSQL 的 `trade_tasks` 和 `ledger_entries` 中提取该 `trace_id` 对应的实盘数据。
2. **损耗审计 (Audit Layer)**：计算“软滑点”和“毒性流”指标。
3. **Prompt 合成 (Python Sidecar)**：将原始数据填充进预设的模板，生成优化建议。
4. **知识沉淀 (AI Engine)**：AI 接收反馈，更新其短期记忆（Vector DB）或调整策略超参数。

---

### 2. 核心 Prompt 模板设计

我们为不同执行结果设计了针对性的模板。

#### 2.1 模板 A：交易失败/熔断分析 (Failure/Revert Analysis)

**适用场景**：交易被 FSM 拦截、仿真失败（Revert）或水位线落后。

> **System Instruction:**
> "你是一个高级 DeFi 策略分析师。你的上一笔交易提议（ID: `{{trace_id}}`）执行失败。请根据以下实盘反馈调整你的参数逻辑。"
> **Execution Context:**
> * **错误类型**: `{{error_code}}` (例如: `STALE_DATA_ERROR`)
> * **仿真结果**: `{{simulation_error}}` (例如: `UniswapV3: INSUFFICIENT_OUTPUT`)
> * **数据水位线高度**: `{{sync_block}}`
> * **当前 Gas 价格**: `{{gas_price}}` Gwei
> 
> 
> **Reflective Task:**
> 1. 分析是否因 `max_slippage` 设置过于保守导致仿真频繁失败。
> 2. 如果是数据过期错误，请评估你的推理耗时是否超过了 2 个区块的物理阈值。
> 3. 请生成一份修正后的参数建议，降低后续 Revert 率。"
> 
> 

#### 2.2 模板 B：执行效率与毒性流审计 (Post-Trade Audit)

**适用场景**：交易成功（CONFIRMED），但滑点或 MEV 损耗过高。

> **System Instruction:**
> "你的交易已成交（Hash: `{{tx_hash}}`），但账本审计发现执行效率存在异常。请复盘并优化。"
> **Performance Metrics:**
> * **已实现盈亏**: `{{pnl_amount}}` `{{symbol}}`
> * **预期滑点 vs 实际滑点**: `{{expected_slippage}}%` / `{{actual_slippage}}%`
> * **MEV/毒性流审计**: 系统检测到执行后价格逆向波动 `{{price_impact_bps}}` bps，存在被套利者收割迹象。
> 
> 
> **Instruction:**
> 1. 评估该协议（`{{protocol_id}}`）当前的流动性深度是否支撑你的交易规模。
> 2. 考虑分批下单（TWAP）或切换至私有路由（Flashbots）以减少毒性流损失。"
> 
> 

---

### 3. 技术实现细节 (Implementation)

#### 3.1 Trace ID 闭环映射

在 Python Agent 侧，我们通过一个名为 `FeedbackLoop` 的组件，利用 `trace_id` 自动从数据库拉取对应的 `mtm_snapshots` 记录。

#### 3.2 向量化存储与长效进化

所有的反馈 Prompt 及其对应的 AI 调整决策会被存入 **向量数据库 (Vector DB)**。

* **逻辑**：当 AI 再次面对类似的行情（如高波动率）时，它会检索带有 `trace_id` 的历史失败案例，从而避免重复设置过低的滑点或错误的 Gas 策略。

---

### 4. 评价标准 (Evaluation Standards)

| 维度 | **好飞轮 (Evolutionary)** | **坏飞轮 (Stagnant)** |
| --- | --- | --- |
| **反馈时效** | 交易 CONFIRMED 后 60 秒内生成反馈 Prompt。 | 仅在每周报表中手动复盘，反馈严重滞后。 |
| **数据颗粒度** | 包含水位线、仿真 Log 和毒性流审计指标。 | 只告诉 AI 赚了还是赔了，没有具体技术损耗分析。 |
| **学习能力** | AI 能根据错误码（如 `STALE_DATA`）主动优化推理算法耗时。 | 同样的精度错误或滑点错误反复出现。 |
