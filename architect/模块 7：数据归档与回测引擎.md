
## ğŸ›ï¸ æ¨¡å— 7ï¼šæ•°æ®å½’æ¡£ä¸å›æµ‹å¼•æ“ (Data Archiving & Backtesting)

### 7.1 æ¶æ„è®¾è®¡ï¼šä»æµå¼åˆ°åˆ—å¼ (From Stream to Columnar)

ä¸ºäº†è§£å†³ Redis å†…å­˜å—é™æ— æ³•å­˜å‚¨å…¨é‡å†å²æ•°æ®çš„é—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦æ„å»ºä¸€ä¸ª **ETL å½’æ¡£ç®¡é“**ï¼Œå°†çƒ­æ•°æ®æ²‰æ·€ä¸ºå†·æ•°æ®ï¼Œå¹¶æä¾›ç»Ÿä¸€çš„æŸ¥è¯¢æ¥å£ã€‚

*   **çƒ­æ•°æ® (Hot):** Redis Streamï¼Œä¿ç•™æœ€è¿‘ 24 å°æ—¶çš„é«˜é¢‘ Tick æ•°æ®ï¼Œä¾›å®ç›˜ Agent å®æ—¶æ¶ˆè´¹ã€‚
*   **å†·æ•°æ® (Cold):** S3 / MinIO (Parquet æ ¼å¼)ï¼Œæ°¸ä¹…ä¿å­˜å†å²å…¨é‡ Tick æ•°æ®ï¼Œä¾›å›æµ‹å¼•æ“ä½¿ç”¨ã€‚
*   **ç´¢å¼•å±‚ (Index):** ClickHouseï¼Œå­˜å‚¨å…ƒæ•°æ®ç´¢å¼•ï¼ˆå¦‚ï¼šâ€œæŸåˆçº¦åœ¨æŸæ—¶é—´æ®µå†…çš„ Parquet æ–‡ä»¶è·¯å¾„â€ï¼‰ï¼ŒåŠ é€Ÿå›æµ‹æ—¶çš„æ•°æ®å®šä½ã€‚

### 7.2 æŠ€æœ¯å®ç°ï¼šç»Ÿä¸€æ•°æ®è®¿é—®å±‚ (Unified Data Provider)

åœ¨ Python ç­–ç•¥ç«¯ï¼Œæˆ‘ä»¬é€šè¿‡**ä¾èµ–æ³¨å…¥**çš„æ–¹å¼ï¼Œè®© Agent æ— æ³•æ„ŸçŸ¥å½“å‰æ˜¯åœ¨â€œå›æµ‹â€è¿˜æ˜¯â€œå®ç›˜â€ã€‚

```python
# data_provider.py

class IDataProvider(ABC):
    @abstractmethod
    def get_ticks(self, pool_address, start_block, end_block):
        pass

class RealtimeProvider(IDataProvider):
    """å®ç›˜æ¨¡å¼ï¼šç›´æ¥è®¢é˜… Redis Stream"""
    def __init__(self, redis_client):
        self.redis = redis_client

    def get_ticks(self, ...):
        # å®æ—¶ç›‘å¬ Redis Channel
        yield from self.redis.subscribe(f"stream:{pool_address}")

class BacktestProvider(IDataProvider):
    """å›æµ‹æ¨¡å¼ï¼šè¯»å–æœ¬åœ°/S3 Parquet æ–‡ä»¶"""
    def __init__(self, s3_client, parquet_path):
        self.s3 = s3_client
        self.path = parquet_path

    def get_ticks(self, pool_address, start_block, end_block):
        # 1. è‡ªåŠ¨å®šä½ Parquet æ–‡ä»¶åˆ†åŒº
        # 2. ä½¿ç”¨ PyArrow é«˜æ•ˆè¯»å–åˆ—å¼æ•°æ®
        # 3. æŒ‰æ—¶é—´æˆ³ yield æ•°æ®ï¼Œæ¨¡æ‹Ÿå®æ—¶æµæ¨é€
        df = pd.read_parquet(f"{self.path}/{pool_address}/part-0001.parquet")
        for _, row in df.iterrows():
            yield self._convert_to_protobuf(row)

# ç­–ç•¥ Agent ä¸­ä½¿ç”¨
class StrategyAgent:
    def __init__(self, data_provider: IDataProvider):
        self.data = data_provider # ç­–ç•¥é€»è¾‘å®Œå…¨ä¸éœ€è¦ä¿®æ”¹
```

### 7.3 å½’æ¡£æœåŠ¡è®¾è®¡ (Go Archiver)

åœ¨ Go æ‰§è¡Œå±‚ï¼ˆZone Bï¼‰ï¼Œéƒ¨ç½²ä¸€ä¸ªè½»é‡çº§çš„ `Archiver` æœåŠ¡ã€‚

*   **èŒè´£**ï¼šä½œä¸º Redis Stream çš„æ¶ˆè´¹è€…ç»„ä¹‹ä¸€ï¼Œåªè¯»ä¸å†™ã€‚
*   **æ‰¹å¤„ç†**ï¼šæ¯ç§¯æ”’ 10,000 æ¡ Tick æ•°æ®æˆ–æ¯éš” 1 åˆ†é’Ÿï¼Œç”Ÿæˆä¸€ä¸ª `.parquet` æ–‡ä»¶å¹¶ä¸Šä¼ è‡³ S3ã€‚
*   **åˆ†åŒºç­–ç•¥**ï¼š`s3://defi-data/chain_id/protocol_id/date/partition_N.parquet`ã€‚

