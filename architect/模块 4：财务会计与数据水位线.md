# ğŸ›ï¸ æ¨¡å— 4ï¼šè´¢åŠ¡ä¼šè®¡ä¸æ•°æ®æ°´ä½çº¿ (Accounting & Data Watermark)

## 4.1 æ•°æ®æ°´ä½çº¿æ¶æ„ (Data High-Watermark Topology)

ä¸ºäº†å®ç° PRD ä¸­è¦æ±‚çš„â€œç¡®å®šæ€§æ•°æ®æ„ŸçŸ¥â€ï¼Œç³»ç»Ÿæ„å»ºäº†ä¸€ä¸ªå¸¦æ—¶é—´æˆ³å¿«ç…§çš„æ•°æ®æµæ°´çº¿ï¼Œç¡®ä¿ AI å†³ç­–å§‹ç»ˆåŸºäºæ–°é²œçš„é“¾ä¸ŠçŠ¶æ€ã€‚

* **åŒæ­¥ç›‘æ§å™¨ (Sync Sentinel)**ï¼šå®æ—¶å¯¹æ¯” RPC èŠ‚ç‚¹çš„æœ€æ–°åŒºå— ($\text{CurrentBlock}$) ä¸æ•°æ®åº“å·²æŒä¹…åŒ–çš„æœ€é«˜æ°´ä½çº¿ ($\text{SyncBlock}$)ã€‚
* **ç¡¬ç†”æ–­æœºåˆ¶ (Hard Circuit Breaker)**ï¼šåœ¨ç­–ç•¥å¼•æ“è®¡ç®—å‰ï¼Œç³»ç»Ÿå¼ºåˆ¶æ‰§è¡Œæ–­è¨€ã€‚è‹¥ $\text{CurrentBlock} - \text{SyncBlock} > 2$ï¼Œåˆ™ç«‹å³æŠ›å‡º `StaleDataError` å¹¶é˜»æ–­å‘å•æµç¨‹ã€‚
* **å‘Šè­¦å¯¹é½**ï¼šç†”æ–­åŠ¨ä½œå¿…é¡»ä¸å‘Šè­¦ç³»ç»ŸåŒæ­¥è§¦å‘ï¼Œç¡®ä¿è¿ç»´äººå‘˜ç¬¬ä¸€æ—¶é—´æ„ŸçŸ¥åŒæ­¥åœæ»ã€‚

---

## 4.2 åŒåˆ†å½•ä¼šè®¡æ ¸ç®—ç³»ç»Ÿ (Double-Entry Ledger & MtM)

ä¸ºäº†é˜²æ­¢èµ„äº§é»‘ç›’åŒ–ï¼Œç³»ç»Ÿé‡‡ç”¨é‡‘èçº§è´¦æœ¬æ¶æ„ï¼Œæ‰€æœ‰é“¾ä¸Šå˜åŠ¨å¿…é¡»åœ¨å†…éƒ¨æ•°æ®åº“æœ‰å¯¹åº”çš„å€Ÿè´·åˆ†å½•ã€‚

* **å·²å®ç°èµ„äº§ (Realized)**ï¼šåŸºäºäº¤æ˜“ç¡®è®¤ (CONFIRMED) å®æ—¶æ›´æ–°ã€‚åŒæ­¥ç”Ÿæˆå€Ÿè´·åˆ†å½•ï¼Œç¡®ä¿æ•°æ®åº“è´¦æœ¬ä¸é“¾ä¸Šä½™é¢è¯¯å·® $\le 1 \text{ wei}$ã€‚
* **æœªé¢†å–å¥–åŠ± (Unclaimed)**ï¼šå®šæ—¶ä»»åŠ¡ï¼ˆæ¯ 5-10 åˆ†é’Ÿï¼‰æŠ“å–åè®®å†…ç§¯æ”’çš„å¥–åŠ±ã€‚è‡ªåŠ¨è¿½è¸ªæœªé¢†å–çš„ Rewardï¼Œé˜²æ­¢å› â€œè´¦é¢å‡€å€¼â€æœªåŒ…å«è¿™éƒ¨åˆ†èµ„äº§è€Œå¯¼è‡´é£æ§è¯¯æ€ã€‚
* **å…¬å…ä»·å€¼ (MtM)**ï¼šç»“åˆä¸‰æºé¢„è¨€æœºä»·æ ¼å®æ—¶é‡ä¼°ï¼Œä¸º AI ç­–ç•¥æä¾›å®æ—¶çš„ U æœ¬ä½å‡€å€¼ (NAV) å’Œå›æ’¤æ•°æ®ã€‚

---

## 4.3 å®¡è®¡ä¸é£æ§æ„ŸçŸ¥ (Post-Trade & Flow Audit)

äº¤æ˜“å®Œæˆåï¼Œç³»ç»Ÿéœ€å…·å¤‡â€œå¤ç›˜èƒ½åŠ›â€æ¥è¯†åˆ«æ½œåœ¨çš„éšæ€§æŸå¤±ã€‚

* **è½¯æ»‘ç‚¹å®¡è®¡**ï¼šè®°å½•æ¯ä¸€ç¬”äº¤æ˜“çš„â€œæ‰§è¡Œä»·â€ä¸â€œæè®®æ—¶å¸‚åœºä»·â€çš„åå·®ï¼Œè®¡ç®—å®é™…çš„å¸‚åœºå†²å‡»æˆæœ¬ã€‚
* **æ¯’æ€§æµåˆ†æ (Toxic Flow Audit)**ï¼šè‹¥å‘ç°ç­–ç•¥å‘å•åï¼Œä»·æ ¼æ€»æ˜¯å‘ä¸åˆ©äºæŒä»“çš„æ–¹å‘ç§»åŠ¨ï¼Œè¯´æ˜ç­–ç•¥æ­£åœ¨è¢«å¥—åˆ©è€…åå‘æ”¶å‰²ã€‚ç³»ç»Ÿå°†è§¦å‘è‡ªåŠ¨æš‚åœå¹¶è¿›å…¥äººå·¥å®¡è®¡ã€‚

---

## 4.4 æ•°æ®åº“ç‰©ç†è®¾è®¡ (PostgreSQL Schema)

é‡‡ç”¨ **Go + Python** æ··åˆæ¶æ„çš„ç‰©ç†è½åœ°æ ‡å‡†ï¼Œé‡‘é¢å­—æ®µç»Ÿä¸€ä½¿ç”¨ `NUMERIC(78, 0)` ä»¥æ”¯æŒ 256 ä½æ•´æ•°ç²¾åº¦ã€‚

### 4.4.1 æ ¸å¿ƒè´¦æˆ·ä¸ä½™é¢è¡¨

```sql
-- è´¦æˆ·è¡¨ï¼šåŒºåˆ†ç­–ç•¥ã€åè®®ä¸æ‰‹ç»­è´¹è´¦æˆ·
CREATE TABLE accounts (
    account_id UUID PRIMARY KEY,
    name VARCHAR(64) NOT NULL,
    account_type VARCHAR(20) NOT NULL, -- 'STRATEGY', 'PROTOCOL', 'GAS'
    address CHAR(42) NOT NULL,
    chain_id INTEGER NOT NULL
);

-- èµ„äº§å¹³è¡¡è¡¨ï¼šåŸºäºæ°´ä½çº¿çš„å®æ—¶ä½™é¢
CREATE TABLE asset_balances (
    account_id UUID REFERENCES accounts(account_id),
    token_address CHAR(42) NOT NULL,
    raw_balance NUMERIC(78, 0) NOT NULL DEFAULT 0, -- 256ä½ Wei ç²¾åº¦
    last_updated_block BIGINT NOT NULL,              -- æ•°æ®æ°´ä½çº¿
    PRIMARY KEY (account_id, token_address)
);

```

### 4.4.2 å¤å¼è®°è´¦å‡­è¯è¡¨

```sql
CREATE TABLE ledger_entries (
    entry_id UUID PRIMARY KEY,
    internal_tx_id UUID NOT NULL,       -- å…³è”æ¨¡å— 3 çš„äº¤æ˜“ä»»åŠ¡
    trace_id UUID NOT NULL,            -- å…¨é“¾è·¯è¿½è¸ª ID
    debit_account_id UUID REFERENCES accounts(account_id),
    credit_account_id UUID REFERENCES accounts(account_id),
    amount NUMERIC(78, 0) NOT NULL,
    entry_type VARCHAR(20) NOT NULL,    -- 'TRADE', 'GAS_FEE', 'REWARD'
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

```

### 4.4.3 å¥–åŠ±ä¸ä¼°å€¼å¿«ç…§

```sql
-- æœªé¢†å–å¥–åŠ±è¡¨
CREATE TABLE unclaimed_rewards (
    strategy_id UUID NOT NULL,
    protocol_id VARCHAR(32) NOT NULL,
    token_address CHAR(42) NOT NULL,
    raw_amount NUMERIC(78, 0) NOT NULL,
    last_sync_block BIGINT NOT NULL,     -- å¥–åŠ±æ•°æ®çš„æ°´ä½çº¿
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (strategy_id, protocol_id, token_address)
);

```

---

### 4.5 æŠ€æœ¯å®ç°ï¼šSync Sentinel æ ¸å¿ƒé€»è¾‘ (Go Implementation)

åœ¨ Go æ‰§è¡Œå±‚ä¸­ï¼Œ`SyncSentinel` ä½œä¸ºä¸€ä¸ªä¸­é—´ä»¶æˆ–æ‹¦æˆªå™¨ï¼Œåœ¨æ¯ä¸€ç¬”äº¤æ˜“æ¨¡æ‹Ÿï¼ˆSimulationï¼‰ä¹‹å‰æ‰§è¡Œç‰©ç†æ‹¦æˆªã€‚

```go
package monitor

import (
	"context"
	"errors"
	"fmt"
)

var ErrStaleData = errors.New("StaleDataError: Data watermark lag exceeds threshold")

type SyncSentinel struct {
	maxLag uint64 // PRD 4.2 å®šä¹‰çš„å ä½å€¼ï¼š2
}

// CheckWatermark æ ¸å¿ƒæ‹¦æˆªé€»è¾‘
func (s *SyncSentinel) CheckWatermark(ctx context.Context, currentBlock uint64, dbSyncBlock uint64) error {
	// 1. ç‰©ç†ç†”æ–­é€»è¾‘ï¼šè®¡ç®—åŒºå—å»¶è¿Ÿ
	lag := currentBlock - dbSyncBlock
	
	if lag > s.maxLag {
		// 2. è§¦å‘ç¡¬ç†”æ–­ï¼ŒæŠ›å‡º StaleDataError
		return fmt.Errorf("%w: current=%d, sync=%d, lag=%d", 
			ErrStaleData, currentBlock, dbSyncBlock, lag)
	}
	
	return nil
}

// æ¨¡æ‹Ÿåœ¨ç­–ç•¥å¼•æ“ä¸­çš„è°ƒç”¨æµç¨‹
func ExecuteStrategy(req TradeRequest) {
    // è·å–å®æ—¶ RPC åŒºå—é«˜åº¦ä¸ DB è®°å½•é«˜åº¦
    rpcBlock := rpc.GetLatestBlock()
    dbBlock := db.GetLastSyncBlock()

    // å¼ºåˆ¶æ ¡éªŒ
    if err := sentinel.CheckWatermark(ctx, rpcBlock, dbBlock); err != nil {
        log.Fatal("Circuit Breaker Triggered", zap.Error(err))
        return // ç‰©ç†æ‹¦æˆªå‘å•æµç¨‹
    }

    // æ ¡éªŒé€šè¿‡åï¼Œè¿›å…¥ G2 ä»¿çœŸæµç¨‹
    simulator.Run(req)
}

```

---

## 4.6 è¯„ä»·æ ‡å‡† (Evaluation Standards)

| ç»´åº¦ | **å¥½æ¶æ„ (Industrial Grade)** | **åæ¶æ„ (Junior Level)** |
| --- | --- | --- |
| **æ•°æ®å®æ—¶æ€§** | æ°´ä½çº¿ç†”æ–­èƒ½åœ¨ 1 ä¸ªåŒºå—æ—¶é—´å†…ç”Ÿæ•ˆã€‚ | ä¾èµ–è¿‡æ—¶æ•°æ®å‘å•ï¼Œå¯¼è‡´æ»‘ç‚¹è¶…é™æˆ–è¢«å¤¹ã€‚ |
| **è´¦å®ç›¸ç¬¦åº¦** | ç»å† 100 ç¬”å¤æ‚æ“ä½œåï¼Œå†…éƒ¨è´¦æœ¬ä¸é“¾ä¸Šä½™é¢è¯¯å·® $\le 1 \text{ wei}$ã€‚ | ä½¿ç”¨æµ®ç‚¹æ•°å¯¼è‡´å¤åˆ©è®¡ç®—åçš„å‡€å€¼äº§ç”Ÿå·¨å¤§åå·®ã€‚ |
| **å¼‚å¸¸æ£€å‡ºç‡** | RPC åœæ­¢æ›´æ–°æ—¶ï¼Œç­–ç•¥å¼•æ“ 100% æ‹¦æˆªè¿‡æ—¶ Payloadã€‚ | æ•°æ®å»¶è¿Ÿæ—¶ç³»ç»Ÿä¾ç„¶å‘å•ï¼Œé€ æˆèµ„äº§å›æ’¤é£é™©ã€‚ |
