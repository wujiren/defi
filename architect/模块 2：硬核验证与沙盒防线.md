# 🏛️ 模块 2：硬核验证与沙盒防线 (Validation & Sandbox)

## 2.1 三源预言机交叉校验 (Triple-Oracle Guard)

为了防止链上闪电贷攻击或单一数据源被操纵，系统在决策执行前必须强制进行三方价格对齐。任何决策执行前，必须对比三个独立源的价格：$P_{Chainlink}$、$P_{Uniswap\_TWAP}$、$P_{DEX\_Slot0}$。

* **熔断条件**：设 $\Delta$ 为偏离阈值（默认 **0.5%**），若满足以下公式则拦截交易：

$$\max(|P_1 - P_2|, |P_2 - P_3|, |P_1 - P_3|) > \Delta$$



### Go 技术实现：交叉校验算法

在 Go 执行层中，预言机卫兵（Oracle Guard）执行以下高精度对比逻辑：

```go
// OracleGuard 核心校验逻辑
func (g *OracleGuard) ValidatePrices(p1, p2, p3 *big.Int) error {
    // 1. 定义允许的偏差阈值 (0.5%)
    // 使用万分位表示：50/10000 = 0.5%
    threshold := big.NewInt(50) 
    base := big.NewInt(10000)

    // 2. 计算两两之间的绝对差值百分比
    diff12 := calcDiff(p1, p2)
    diff23 := calcDiff(p2, p3)
    diff13 := calcDiff(p1, p3)

    // 3. 寻找最大偏差
    maxDiff := max(diff12, max(diff23, diff13))

    // 4. 熔断判断：MaxDiff / Base > Threshold / Base
    if maxDiff.Cmp(threshold) > 0 {
        return fmt.Errorf("PRICE_ORACLE_SKEW: Max deviation %s bps exceeds 50 bps", maxDiff.String())
    }

    return nil
}

// 辅助函数：计算 |P1 - P2| / P1 的万分位表现
func calcDiff(a, b *big.Int) *big.Int {
    diff := new(big.Int).Sub(a, b)
    diff.Abs(diff)
    // 结果 = diff * 10000 / a
    return new(big.Int).Div(new(big.Int).Mul(diff, big.NewInt(10000)), a)
}

```

---

## 2.2 不变性风控断言 (Invariant Checking)

定义物理底线，模拟执行后若破线则直接拦截。例如：“单次执行后 U 本位跌幅不得超 **1%**”。

### Go 技术实现：资产平衡断言

该逻辑在 **模块 1.1** 的 EVM 仿真结束后立即触发，确保仿真结果符合安全宪法。

```go
// InvariantChecker 资产守恒检查
func (c *InvariantChecker) CheckPostSimulation(preState, postState *AccountState) error {
    // 1. 计算 U 本位净值损失
    lossPercent := calculateLoss(preState.TotalValueUSD, postState.TotalValueUSD)

    // 2. 物理底线拦截：不得超过 1%
    if lossPercent > 100 { // 100 bps = 1%
        return fmt.Errorf("INVARIANT_BROKEN: Transaction results in %d bps loss, limit 100 bps", lossPercent)
    }

    // 3. 归一化 Token 数量检查：防止非预期归零
    if postState.TokenBalance.Cmp(big.NewInt(0)) == 0 && preState.TokenBalance.Cmp(big.NewInt(0)) > 0 {
        return fmt.Errorf("INVARIANT_BROKEN: Unexpected token depletion")
    }

    return nil
}

```

---

## 2.3 极端模糊测试 (Fuzzing) & 影子模式 (Shadow Mode)

* **极端模糊测试**：主动注入极端参数（如 Gas 飙升 **1000** 倍），新策略需经过压力测试。
* **影子模式**：新策略在实盘环境下只跑逻辑不发单，仅验证仿真结果与实际水位线的匹配度。

---

## 2.4 模块 2 评价标准 (Evaluation Standards)

| 维度 | **好架构 (Industrial Grade)** | **坏架构 (Junior Level)** |
| --- | --- | --- |
| **预言机容错** | 能识别 Slot0 被攻击导致的价格异常，触发三源熔断。 | 仅依赖单一 DEX 价格，在闪电贷攻击中会产生巨额损失。 |
| **验证精度** | 本地仿真与链上变动误差 $\le 1 \text{ wei}$。 | 模拟认为赚钱，实盘因滑点计算不精导致亏损或 Revert。 |
| **上线严谨性** | 策略必须通过 72 小时影子模式且无一例断言失败。 | 代码编译通过即上线，导致未预见的边界情况损耗本金。 |
| **数据同步** | 强制校验同步块高度，延迟 > 2 区块立即拦截。 | 基于过时价格发单，造成严重的套利损失。 |

