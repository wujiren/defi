# 1.1 三区网络拓扑 (3-Zone Network Topology)

> **文档类型：** 架构文档 · 部署架构篇
> **版本：** v1.0 · 2026-02-26
> **上游依赖：** [README §0.3 端到端请求链路](../Architect_Readme.md#03-端到端请求链路)
> **下游文档：** [1.2 容器资源配额](./1.2_容器资源配额.md) · [1.3 网络安全策略](./1.3_网络安全策略.md)

---

## 1. 设计原则

系统按**安全等级**将所有组件划分为三个物理或逻辑隔离的网络区域（Zone A / Zone B / Zone C）。核心设计哲学是**最小权限原则**：每个 Zone 只能访问完成自身职责所必需的下游组件，任何越级访问在网络层即被物理阻断。

**关键安全保证：**
- Zone A（非信任区）的 AI 策略代码，即使完全被攻陷，也**无法**直接触达 Zone C 的私钥分片
- Zone C 与外部互联网之间**零公网连接**，唯一入口是来自 Zone B 的双向 TLS 专线
- 所有跨 Zone 通信必须携带全链路 Trace ID，无标记请求在网关层拒绝

---

## 2. Zone A — 策略计算区 (Intelligence Zone)

**安全等级：** 非信任区（Untrusted / Low Security）
**物理环境：** 公有云 VPC（阿里云 / AWS），与 Zone B 通过内网专线通信
**Docker 网络名：** `intelligence_net`

### 2.1 职责定位

Zone A 负责所有**逻辑密集型、无签名权限**的计算任务。区内组件只能生成无签名的交易 Payload，通过 gRPC 提交给 Zone B 执行，**禁止持有任何私钥材料或直接访问链上节点**。

### 2.2 部署组件

| 组件名称 | 数量 | 职责 | 对应文档 |
|---|---|---|---|
| **Python-Agent-Pool** | 50+ 容器 | 运行 AI 策略逻辑，通过 gRPC 向 Zone B 提交 TradeRequest | §3.1 |
| **AI-Feedback-Service** | 1 容器 | 接收链上 PnL 结果，生成策略优化 Prompt，驱动 AI 反馈飞轮 | §6.4 |
| **Admin Web Portal** | 1 容器 | 管理员监控资产状态、审批大额交易、触发全局断路器 | §5.1 · §5.3 |
| **Trace ID Logger** | 1 容器 | 聚合全链路结构化日志，对接 ELK / Grafana Loki | §6.1 |

### 2.3 通信限制

```
Zone A 允许的出站连接：
  ✅ → Zone B : gRPC 端口（TradeRequest 提交）
  ✅ → Zone B : Redis Stream 订阅（L3 消息总线，只读）
  ✅ → 外部网络 : HTTPS 443（抓取 Snapshot/Tally 治理提案、AI 语料）

Zone A 禁止的连接：
  ❌ → Zone C : 任何连接（网络层物理阻断）
  ❌ → 链上 RPC 节点 : 直接调用（必须通过 Zone B 代理）
  ❌ → 数据库 PostgreSQL : 直接访问（账本数据只读接口由 Zone B 暴露）
```

---

## 3. Zone B — 模拟验证区 (Sandbox & Validation Zone)

**安全等级：** 高信任区（Trusted / Mid Security）
**物理环境：** 高性能本地服务器 / 专属私有云 VPC
**Docker 网络名：** `sandbox_net`

### 3.1 职责定位

Zone B 是系统的**核心执行层和安检站**，承担所有需要链上状态感知的关键计算：EVM 仿真、FSM 状态管理、Sync Sentinel 水位线拦截、对账核查。只有经过 Zone B 完整验证的交易请求，才能被转发至 Zone C 签名。

### 3.2 部署组件

| 组件名称 | 数量 | 职责 | 对应文档 |
|---|---|---|---|
| **Go-Execution-Engine** | 1 容器（高优先级） | 运行幂等状态机 FSM、EVM 仿真器、Sync Sentinel、双分录对账 | §3.1 · §3.2 · §3.3 |
| **MEV Router** | 1 容器 | 路由决策：Flashbots 私有路由 vs 公共 Mempool | §3.4 |
| **PostgreSQL** | 1 容器 | 持久化 trade_tasks、nonce_locks、ledger_entries 等核心账本 | §3.5 |
| **Redis-Cluster** | 1 容器 | L3 消息总线，高频链上事件分发至 50+ Agent | §2.2 |
| **Anvil-Node** | 1 容器 | 本地主网分叉环境，用于 G4 Fuzzing 和 G2 EVM 精度校验 | §3.2 · §7.2 |
| **Data-Processor** | 1 容器 | L1→L2 数据标准化，注入 Sync Sentinel 水位线，写入 Redis Stream | §2.2 |
| **Archiver** | 1 容器 | 消费 Redis Stream，批量归档为 Parquet 文件至 S3/MinIO | §2.4 |
| **Chain-Adapter** | 1 容器 | 多节点 RPC 管理，冗余订阅链上 newHeads / Logs | §3.1 |

> **Go-Execution-Engine 特别配置：** 启用 Linux core dump，进程崩溃时自动保存内存快照用于故障复盘。容器资源配额设为最高优先级，防止 Python Agent OOM 引发的资源竞争影响 FSM 的 Nonce 锁管理器。

### 3.3 通信限制

```
Zone B 允许的连接：
  ✅ ← Zone A : 接收 gRPC TradeRequest（入站）
  ✅ → Zone C : 转发已验证的签名请求（仅 Hash 摘要，双向 TLS 专线）
  ✅ ↔ 链上 RPC 节点 : 通过专用 RPC 节点访问区块链（出站）
  ✅ → S3 / MinIO : 归档 Parquet 历史数据（出站）
  ✅ → Flashbots Relay : 广播私有 Bundle（出站，HTTPS）

Zone B 禁止的连接：
  ❌ → 公网任意地址 : 除上述白名单外的出站连接
  ❌ ← 公网入站 : 禁止任何公网直接访问 Zone B 服务
```

---

## 4. Zone C — 核心签名区 (Security Vault Zone)

**安全等级：** 极高安全区（Hardened / High Security）
**物理环境：** 独立物理机群（Bare Metal）或硬件安全模块（HSM），**零公网连接**
**Docker 网络名：** `fortress_net`（子网：`10.0.5.0/24`）

### 4.1 职责定位

Zone C 是系统的**最后一道物理防线**，唯一职责是对经过 Zone B 完整验证的交易进行 MPC 分片签名。私钥分片永远不在单个节点上拼合，签名完成后立即销毁中间状态。Zone C 对请求的来源进行严格的双向 TLS 认证，任何未经认证的连接请求在网络层直接丢弃。

### 4.2 部署组件

| 组件名称 | 数量 | 职责 | 对应文档 |
|---|---|---|---|
| **MPC-Signer-Node** | 多节点（分布式） | 执行私钥分片签名，分布式存放密钥材料，绝不拼合完整私钥 | §5.1 |
| **Whitelist-Enforcement-Proxy** | 1 节点 | 签名前强制校验目标合约地址和函数选择器是否在合约白名单内 | §5.1 |
| **Admin-Approval-API** | 1 节点 | 处理大额审批工作流，管理员通过此接口释放挂起的签名请求 | §5.1 |

### 4.3 通信限制

```
Zone C 允许的连接：
  ✅ ← Zone B : 接收签名请求（入站，双向 TLS，仅白名单 IP）
  ✅ → Zone B : 返回签名结果（出站，双向 TLS）

Zone C 禁止的连接（硬编码，不可配置）：
  ❌ ← Zone A : 任何来自策略计算区的连接（网络层丢弃）
  ❌ ↔ 公网 : 零公网连接（进出均阻断）
  ❌ ↔ 链上 RPC : 不直接访问区块链（由 Zone B 代理）
```

---

## 5. 三区通信拓扑全景

```
外部网络                    Zone A                      Zone B                    Zone C
(Public Internet)      (Intelligence Zone)      (Sandbox & Validation)      (Security Vault)
                       [非信任区]                   [高信任区]                  [极高安全区]
      │                      │                          │                          │
      │  治理提案/AI语料       │                          │                          │
      │ ──HTTPS 443──────────>│                          │                          │
      │                      │                          │                          │
      │                      │   TradeRequest (gRPC)    │                          │
      │                      │ ────────────────────────>│                          │
      │                      │                          │  Sync Sentinel 水位线拦截 │
      │                      │                          │  三源预言机校验            │
      │                      │                          │  EVM 仿真 + 不变性断言     │
      │                      │                          │  FSM 状态推进             │
      │                      │                          │                          │
      │                      │                          │  签名请求（明文 Payload） │
      │                      │                          │  双向TLS专线             │
      │                      │                          │ ─────────────────────────>│
      │                      │                          │                          │  白名单校验
      │                      │                          │                          │  大额审批
      │                      │                          │                          │  MPC 分片签名
      │                      │                          │  Signed Payload 返回      │
      │                      │                          │ <─────────────────────────│
      │                      │                          │                          │
      │                      │                          │  MEV Router 广播          │
      │  Flashbots Relay      │                          │ ──HTTPS──────────────────>│(公链)
      │ <─────────────────────│──────────────────────── │                          │
      │                      │                          │                          │
      │                      │  链上事件推送（Redis）     │                          │
      │                      │ <────────────────────────│                          │
      │                      │                          │                          │
```

---

## 6. 极端故障下的系统响应

| 故障场景 | 检测组件 | 自动响应 | 人工介入 |
|---|---|---|---|
| **RPC 节点宕机** | Chain-Adapter 心跳检测 → Sync Sentinel 水位线停滞 | Zone B 停止向 Zone C 转发签名请求；自动切换至备用 RPC 节点 | 主节点长期宕机时，运维手动更新节点配置 |
| **Zone A 策略服务器被攻陷** | Zone B 白名单校验拒绝未知地址；Zone C 物理阻断 | 恶意 Payload 无法通过合约白名单校验；大额转出触发人工审批 | 管理员通过 Admin Web Portal 触发全局断路器 |
| **黑天鹅 / 协议被黑** | 治理风险哨兵告警 | 哨兵标记协议为高风险，触发 FSM 熔断停止发单 | 管理员触发全局断路器，向 Zone C 推送全量授权撤销指令 |
| **Zone B Go 进程崩溃** | 自愈管理器启动扫描（Recovery Manager） | 15 秒内完成状态扫描，按 FSM 状态自愈（重广播 / Gas 加速） | 连续崩溃超过阈值时，运维介入检查 core dump |
| **MPC 节点单点故障** | Zone C 内部健康检查 | 剩余分片节点维持可用性（阈值签名机制） | 运维补充新节点，重新执行密钥分片仪式 |

---

## 7. 设计决策记录 (Design Decision Records)

### DDR-1：为什么 Sync Sentinel 放在 Zone B 而非 Zone A？

**决策：** Sync Sentinel 部署在 Zone B（Go-Execution-Engine 内），不在 Zone A。

**理由：** Zone A 是非信任区，如果将水位线校验逻辑放在 Python Agent 中，攻击者可以通过修改 Agent 代码绕过校验，向 Zone B 提交基于过期数据的 Payload。Sync Sentinel 在 Zone B 执行才构成硬拦截，Zone A 的水位线记录（`last_seen_block`）仅作为辅助参考，不作为安全边界。

### DDR-2：为什么 MEV Router 作为独立容器？

**决策：** MEV Router 从 Go-Execution-Engine 中独立为单独容器。

**理由：** Flashbots 连接需要出站访问公网，而 Go-Execution-Engine 出于安全考量应限制其直接公网访问。独立部署后，仅 MEV Router 容器需要开放出站 HTTPS，Go-Execution-Engine 只与 MEV Router 内网通信，缩小了攻击面。

### DDR-3：为什么 Admin Web Portal 放在 Zone A 而非 Zone C？

**决策：** Admin Web Portal 部署在 Zone A（公有云），而非 Zone C（物理隔离机群）。

**理由：** Admin Web Portal 需要对外提供 HTTPS 访问（管理员浏览器访问），如果部署在 Zone C 则必须开放公网入口，破坏 Zone C 零公网的安全原则。Web Portal 本身不持有任何签名权限，所有审批指令通过 Zone B 的 Admin-Approval-API 中转，Zone C 只接受经过双向 TLS 认证的 Zone B 请求。

---

*上一篇：[README 总览](../Architect_Readme.md) | 下一篇：[1.2 容器资源配额](./1.2_容器资源配额.md)*
