# DeFi 基础设施代码仓库架构与治理规范 (Repository Architecture & Governance)

> **文档类型：** 研发治理规范
> **版本：** v1.0
> **关联依据：** 《DeFi 自动化交易与资管基础设施 PRD》、《1.1 三区网络拓扑》、《开发计划总览 v2.0》

---

## 1. 架构设计理念 (Design Philosophy)

鉴于本系统对**物理级隔离**和**极高资金安全**的顶层设计要求，系统全面弃用单体仓库（Monorepo），采用**“多仓库 (Polyrepo) + 强契约驱动”**的架构模式。

此设计旨在从代码权限的源头切断越权访问的可能：确保处于非信任区（Zone A）的策略代码与执行逻辑彻底隔离，并由极高安全组独占 Zone C 的核心签名代码权限。

---

## 2. 核心仓库矩阵 (Repository Matrix)

系统拆分为以下 5 个平行的核心 Git 仓库，分别对应不同的物理 Zone 和团队权责：

| 仓库名称 | 物理归属 | 维护团队 (Owner) | 核心职责与内容 | 权限与安全等级 |
| --- | --- | --- | --- | --- |
| **`defi-proto`** | 全局 | 架构与 SRE 组 | 系统的“最高宪法”。包含所有 `.proto` 契约及生成的 Go/Python 桩代码。 | **公开只读**。写操作须架构组审批。 |
| **`defi-zone-a-intelligence`** | Zone A | AI 与量化策略组 | 策略基类、AI 决策模型、指标计算库及 Admin Portal。 | **标准研发**。严禁提交任何主网私钥或 Zone C 凭证。 |
| **`defi-zone-b-core`** | Zone B | 区块链底层组、财务组 | Go 执行引擎、FSM、双分录账本、预言机与仿真器。 | **核心限制**。按目录设置 CODEOWNERS (见 §5)。 |
| **`defi-zone-c-fortress`** | Zone C | 极高安全组 | MPC 签名节点、白名单代理与 Kill Switch 授权逻辑。 | **高度机密**。仅安全组及外部审计机构可见，对产研完全隔离。 |
| **`defi-infra`** | 基建 | 架构与 SRE 组 | `docker-compose.yml`、Prometheus/Grafana 监控配置与混沌测试脚本。 | **运维限制**。掌控测试/生产环境网络编排。 |

---

## 3. 标准目录结构树 (Standard Directory Tree)

以下为 5 大仓库的标准代码结构约束，各组在初始化项目时须严格遵守：

```text
📦 组织级工作区 (DeFi-Organization)
 ┣ 📂 defi-proto                    <-- [仓库 1：全局契约] 
 ┃ ┣ 📜 common.proto                # 基础类型 (金额、Context、状态枚举)
 ┃ ┣ 📜 trading.proto               # 交易执行服务 RPC
 ┃ ┣ 📜 data_stream.proto           # 链上事件订阅流
 ┃ ┗ 📂 gen/                        # 自动生成的桩代码 (go/ 与 python/)
 ┃
 ┣ 📂 defi-zone-a-intelligence      <-- [仓库 2：策略计算区] 
 ┃ ┣ 📂 sdk/
 ┃ ┃ ┗ 📜 base_agent.py             # Python Agent 基类 (封装水位线与gRPC)
 ┃ ┣ 📂 strategies/                 # 具体的量化与 AI 交易策略代码
 ┃ ┣ 📂 evaluator/                  # 25项评估指标计算库
 ┃ ┣ 📂 web_portal/                 # Admin Web Portal 前端项目
 ┃ ┗ 📂 tests/fixtures/             # G1静态分析测试用例
 ┃
 ┣ 📂 defi-zone-b-core              <-- [仓库 3：核心执行区] 
 ┃ ┣ 📂 cmd/
 ┃ ┃ ┣ 📂 execution_engine/         # 主程序：Go-Execution-Engine
 ┃ ┃ ┣ 📂 chain_adapter/            # 实时链上事件 WebSocket 摄取
 ┃ ┃ ┣ 📂 data_processor/           # 水位线注入与语义解析
 ┃ ┃ ┗ 📂 mev_router/               # 防夹与路由决策
 ┃ ┣ 📂 pkg/
 ┃ ┃ ┣ 📂 fsm/                      # 幂等状态机 (INIT -> SIGNED)
 ┃ ┃ ┣ 📂 middleware/               # Sync Sentinel 水位线硬拦截
 ┃ ┃ ┣ 📂 oracle/                   # Triple-Oracle Guard 三源预言机
 ┃ ┃ ┣ 📂 ledger/                   # 双分录会计引擎与对账
 ┃ ┃ ┣ 📂 simulator/                # 两档 EVM 仿真器内核
 ┃ ┃ ┗ 📂 recovery/                 # 15秒自愈管理器
 ┃ ┗ 📂 migrations/                 # PostgreSQL 数据库 DDL (trade_tasks等)
 ┃
 ┣ 📂 defi-zone-c-fortress          <-- [仓库 4：极高安全区] 
 ┃ ┣ 📂 cmd/
 ┃ ┃ ┣ 📂 mpc_signer/               # MPC 密钥分片签名节点主程序
 ┃ ┃ ┗ 📂 whitelist_proxy/          # 白名单硬拦截代理
 ┃ ┣ 📂 pkg/validator/              # 明文 Payload 重哈希校验逻辑
 ┃ ┗ 📜 Dockerfile.hsm              # HSM 物理机精简运行环境
 ┃
 ┗ 📂 defi-infra                    <-- [仓库 5：运维与基建区] 
   ┣ 📂 deployments/                # 三区网络 docker-compose
   ┣ 📂 observability/              # Prometheus, Grafana, Loki 配置
   ┗ 📂 scripts/                    # chaos_test.sh, cert_rotate.sh 等运维脚本

```

---

## 4. 依赖集成与高频开发流 (Integration & Workflow)

### 4.1 契约同步：Git Submodule

`defi-zone-a` 与 `defi-zone-b` 均需将 `defi-proto` 作为 **Git Submodule** 引入。

* **工作流**：当 `defi-proto` 发生 PR 合并时，触发 Webhook，自动向 Zone A 和 Zone B 仓库提交更新 Submodule commit 游标的 PR，确保两端消费的契约版本始终一致。

### 4.2 策略并发开发最佳实践：Git Worktree

在 `defi-zone-a-intelligence` 的日常开发中，策略研究员经常需要同时运行和对比多个策略分支的回测表现（G5/G6）。

* **规范建议**：强烈建议 AI 团队使用 `git worktree` 管理并发开发，而非传统的 `git checkout`。
* **优势**：通过 `git worktree add ../strategy-b-test feature/strategy-b`，可以在同一套庞大的本地 Parquet 历史数据集和 Python 虚拟环境旁，挂载出多个独立的工作目录。这使得研究员能同时在终端 A 跑策略一的回测，在终端 B 开发策略二，彻底免去频繁切换分支导致的缓存失效和环境重载烦恼。

---

## 5. 自动化拦截与防扯皮红线 (CI/CD & Security Redlines)

系统将架构规范中的“红线”固化为各仓库的自动化 CI 检查或 Merge 门控：

1. **G1 静态安全阻断 (`defi-zone-a`)**：
策略 PR 提交时，CI 强制执行 `sdk.validate.static_check()`。若在策略代码中扫描到 `direct RPC call` 或使用了 `float` 金额，CI 自动标红并阻断合并。
2. **Schema 冻结与跨组审批 (`defi-zone-b`)**：
Phase 0 结束后数据库 Schema 冻结。任何对 `migrations/` 目录下 SQL 的修改，通过 GitHub CODEOWNERS 机制，强制要求必须同时获得**区块链底层组**与**财务风控组**的 Tech Lead Approve 才能合并。
3. **明文哈希终极校验 (`defi-zone-c`)**：
Zone C 仓库的代码审计中重点检查：绝不能存在直接信任和使用外部传入 Hash 值的逻辑，必须基于原始 Payload 本地重新执行 `Keccak256` 运算。
4. **环境凭证隔离 (`defi-infra` & All)**：
所有仓库强制启用 `.gitignore` 屏蔽 `.env.local`。如果在任何非部署专用分支中检测到疑似主网 RPC 地址或主网私钥，安全扫描即刻阻断并触发告警。