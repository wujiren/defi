# 5.2 治理风险哨兵 (Governance Risk Sentinel)

> **文档类型：** 架构文档 · 安全防御篇
> **版本：** v1.0 · 2026-02-26
> **上游依赖：** [3.2 验证层：EVM 仿真与三源预言机](../03_核心执行引擎/3.2_验证层_EVM仿真与三源预言机.md) · [5.1 MPC 签名与白名单拦截](./5.1_MPC签名与白名单拦截.md)
> **下游文档：** [5.3 全局断路器与时间锁](./5.3_全局断路器与时间锁.md)
>
> **来源文档：** `模块_1_策略大脑与协议适配.md` §1.3（原归属于模块1，本次迁移至安全防御篇）；`模块_9_验证门控_G1-G8.md` G7 治理环境感应部分
>
> **迁移说明：** 治理哨兵原归属于"策略大脑与协议适配"模块，但其职责本质上是**安全防御**（监测协议变更风险、触发熔断）而非策略决策。本次重构将其迁入安全防御篇，并补全了与 G7 门控的联动逻辑。

---

## 1. 职责定位

DeFi 协议的治理过程（Snapshot 投票、Tally 链上提案）可以修改影响策略收益的核心参数：

- **Uniswap 协议费率调整**：直接影响做市策略的手续费收入
- **Aave LTV 参数修改**：影响借贷策略的最大杠杆比例
- **协议紧急升级**：底层合约变更可能导致 Adapter 失效
- **流动性激励调整**：影响收益聚合策略的 APY 预期

治理哨兵的职责是**在这些变更落地之前感知并响应**，而非等到变更生效后被动承受损失。

---

## 2. 监控架构

### 2.1 数据源

| 数据源 | 协议覆盖 | 抓取频率 | 部署位置 |
|---|---|---|---|
| Snapshot.org API | Uniswap、Aave、Curve 等链下治理 | 每 5 分钟 | Zone A（AI-Feedback-Service 容器） |
| Tally.xyz API | Compound、ENS 等链上 Governor 治理 | 每 5 分钟 | Zone A |
| 链上 Governor 合约事件 | Uniswap V3 Factory、Aave Governance 等 | 实时（每区块） | Zone B（Chain-Adapter 容器） |

> **为什么链下治理（Snapshot）也需要监控？** Snapshot 投票虽然链下执行，但对于采用 Snapshot + Timelock 模式的协议（如 Uniswap），投票通过后会触发链上时间锁操作。哨兵需要在时间锁等待期内检测到风险，而不是等到链上执行才响应。

### 2.2 哨兵架构图

```
外部治理平台                  Zone A                        Zone B
────────────────              ─────────────────────         ────────────────────────
Snapshot.org         →→→     治理爬虫（Governance Crawler） 
Tally.xyz            →→→     ↓                             
                             提案分析器（Proposal Analyzer）
                             ↓
链上 Governor 合约   →→→→→→→ 风险评分引擎（Risk Scorer）   →→→  Adapter Registry
                             ↓                                   ↓ 标记高风险协议
                             熔断决策                        →→→  FSM 熔断触发器
                             ↓
                             告警推送（§6.3）
```

---

## 3. 提案风险分类

哨兵对捕获到的治理提案按风险等级分类，触发不同的响应动作：

| 风险等级 | 提案类型示例 | 自动响应 | 人工介入 |
|---|---|---|---|
| **CRITICAL** | 协议紧急暂停 / 底层合约迁移 / 私钥轮换 | 立即标记协议为 SUSPENDED，触发全量撤资流程 | 需管理员确认后方可恢复 |
| **HIGH** | LTV 参数下调 > 20% / 手续费率上调 > 50% / 新资产白名单添加 | 标记协议为 HIGH_RISK，暂停该协议新建仓位，不影响已有仓位 | 运营审查后决定是否撤资 |
| **MEDIUM** | LTV 微调 < 20% / 手续费率小幅调整 / 奖励参数变更 | 写入风险日志，通知相关策略开发者 | 策略开发者自行评估影响 |
| **LOW** | 非核心参数调整 / 治理框架完善 | 仅记录日志 | 无需介入 |

### 3.1 Go 风险评分实现

```go
// GovernanceProposal 捕获到的治理提案
type GovernanceProposal struct {
    ProtocolID  string
    Title       string
    Description string
    State       string    // "active", "succeeded", "queued", "executed"
    EndTime     time.Time
}

// RiskScorer 提案风险评分引擎
type RiskScorer struct {
    patterns []RiskPattern  // 风险关键词和规则
}

// Score 对提案进行风险评分
func (r *RiskScorer) Score(proposal *GovernanceProposal) RiskLevel {
    // 规则 1：关键字匹配（紧急/暂停/迁移）
    for _, criticalKeyword := range []string{"emergency", "pause", "migrate", "upgrade"} {
        if strings.Contains(strings.ToLower(proposal.Description), criticalKeyword) {
            return RISK_CRITICAL
        }
    }

    // 规则 2：LTV 参数变化幅度（从提案描述中解析）
    if ltvChange := parseLTVChange(proposal.Description); ltvChange != nil {
        if abs(*ltvChange) > 20 { // 超过 20% 变化
            return RISK_HIGH
        }
        return RISK_MEDIUM
    }

    // 规则 3：手续费率变更
    if feeChange := parseFeeChange(proposal.Description); feeChange != nil {
        if abs(*feeChange) > 50 { // 超过 50% 变化
            return RISK_HIGH
        }
        return RISK_MEDIUM
    }

    return RISK_LOW
}

// HandleRisk 根据风险等级触发相应响应
func (s *GovernanceSentinel) HandleRisk(
    protocol string,
    risk RiskLevel,
    proposal *GovernanceProposal,
) {
    switch risk {
    case RISK_CRITICAL:
        // 1. 在 Adapter Registry 标记协议为 SUSPENDED
        s.adapterRegistry.SetStatus(protocol, STATUS_SUSPENDED)
        // 2. 触发 FSM 熔断，停止该协议的所有新发单
        s.fsmCircuitBreaker.TripProtocol(protocol, "GOVERNANCE_CRITICAL")
        // 3. 通知管理员执行紧急撤资
        s.alertManager.FireCritical("GovernanceCritical", proposal)

    case RISK_HIGH:
        // 仅暂停新建仓位，不影响已有仓位
        s.adapterRegistry.SetStatus(protocol, STATUS_HIGH_RISK)
        s.alertManager.FireWarning("GovernanceHighRisk", proposal)

    case RISK_MEDIUM:
        s.alertManager.FireInfo("GovernanceMediumRisk", proposal)
    }
}
```

---

## 4. 与 G7 门控的联动

G7 是策略从 `SHADOWED` 推进至 `STAGED` 前的最后一道确认关卡（详见 §7.2）。治理哨兵为 G7 提供环境准入判断：

```
G7 门控检查序列（策略申请进入 STAGED 前）：

1. 查询 Adapter Registry：策略依赖的所有协议状态是否为 ACTIVE？
   ├── 任一协议为 HIGH_RISK / SUSPENDED → G7 强制阻断，策略不得推进至 STAGED
   └── 全部为 ACTIVE → 继续

2. 查询治理哨兵：过去 24 小时内，相关协议是否有进入时间锁等待期的重大提案？
   ├── 有 → G7 强制阻断，等待提案执行或到期
   └── 无 → G7 通过，允许推进至 STAGED
```

```go
// G7GovernanceCheck G7 门控中的治理状态检查
func (g *G7Gate) GovernanceCheck(strategy *Strategy) error {
    for _, protocolID := range strategy.DependentProtocols() {
        // 1. 协议状态检查
        status := g.adapterRegistry.GetStatus(protocolID)
        if status != STATUS_ACTIVE {
            return fmt.Errorf("G7_BLOCKED: protocol %s is in status %s",
                protocolID, status)
        }

        // 2. 近期重大提案检查（24 小时内）
        recentProposals := g.sentinel.GetRecentHighRiskProposals(
            protocolID,
            time.Now().Add(-24*time.Hour),
        )
        if len(recentProposals) > 0 {
            return fmt.Errorf("G7_BLOCKED: protocol %s has %d high-risk proposal(s) in queue",
                protocolID, len(recentProposals))
        }
    }
    return nil
}
```

---

## 5. 自动恢复机制

协议从高风险状态恢复至正常状态后，哨兵自动触发恢复流程：

| 场景 | 触发条件 | 恢复动作 |
|---|---|---|
| 提案被否决 | 投票结果为 DEFEATED | 协议状态恢复 ACTIVE，通知策略可恢复操作 |
| 时间锁到期但未执行 | 提案超过执行期限 | 协议状态恢复 ACTIVE |
| 紧急升级执行完成 | 链上合约迁移 CONFIRMED | 触发 Adapter Registry 重新校验，人工确认后恢复 |
| CRITICAL 提案被 Guardian 否决 | §5.3 Guardian 行使否决权 | 协议状态立即恢复 ACTIVE |

---

## 6. 评价标准

| 维度 | 好架构 | 坏架构 |
|---|---|---|
| **感知时效** | 提案发布后 5 分钟内捕获，时间锁等待期内完成应对 | 提案执行落地才发现，已无撤资窗口 |
| **风险分级** | CRITICAL/HIGH/MEDIUM/LOW 四级分类，响应动作差异化 | 所有治理事件触发相同级别的人工审查，运营疲劳 |
| **G7 集成** | 哨兵状态直接作为 G7 门控的准入条件，无缝联动 | 治理风险和策略上线流程完全脱节 |
| **自动恢复** | 提案否决后自动恢复协议状态，无需人工干预 | 人工标记风险后，恢复也需人工，易遗漏 |

---

*上一篇：[5.1 MPC 签名与白名单拦截](./5.1_MPC签名与白名单拦截.md) | 下一篇：[5.3 全局断路器与时间锁](./5.3_全局断路器与时间锁.md)*
