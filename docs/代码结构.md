这是一份基于你的初版设计，并融合了**《DeFi 自动化交易与资管基础设施 PRD》**及架构文档体系（特别是数据归档、三区网络拓扑、AI 反馈飞轮等遗漏模块）的**完整改进版**代码仓库架构与治理规范。

我已经将版本号升级为 v2.0，并补充了所有关键组件。

---

# DeFi 基础设施代码仓库架构与治理规范 (Repository Architecture & Governance)

> **文档类型：** 研发治理规范
> **版本：** v2.0 (架构重构版)
> **关联依据：** 《DeFi 自动化交易与资管基础设施 PRD》、《1.1 三区网络拓扑》、《2.4 历史数据归档》、《开发计划总览》

---

## 1. 架构设计理念 (Design Philosophy)

鉴于本系统对**物理级隔离**和**极高资金安全**的顶层设计要求，系统全面弃用单体仓库（Monorepo），采用**“多仓库 (Polyrepo) + 强契约驱动”**的架构模式。

此设计旨在从代码权限的源头切断越权访问的可能：确保处于非信任区（Zone A）的策略代码与执行逻辑彻底隔离，并由极高安全组独占 Zone C 的核心签名代码权限，同时将链上智能合约独立进行高安全等级审计。

---

## 2. 核心仓库矩阵 (Repository Matrix)

系统拆分为以下 **6 个平行的核心 Git 仓库**，分别对应不同的物理 Zone 和团队权责：

| 仓库名称 | 物理/逻辑归属 | 维护团队 (Owner) | 核心职责与内容 | 权限与安全等级 |
| --- | --- | --- | --- | --- |
| **`defi-proto`** | 全局契约 | 架构与 SRE 组 | 系统的“最高宪法”。包含所有 `.proto` 契约及生成的 Go/Python 桩代码。 | **公开只读**。写操作须架构组审批。 |
| **`defi-zone-a-intelligence`** | Zone A | AI 与量化策略组 | 策略基类、AI 决策模型、评估指标库、Admin Portal 及 **AI 反馈飞轮**。 | **标准研发**。严禁提交主网私钥或 Zone C 凭证。 |
| **`defi-zone-b-core`** | Zone B | 区块链底层组、财务组 | Go 执行引擎、FSM、双分录账本、预言机、仿真器及 **数据归档服务**。 | **核心限制**。按目录设置 CODEOWNERS。 |
| **`defi-zone-c-fortress`** | Zone C | 极高安全组 | MPC 签名节点、白名单代理与 Kill Switch 授权逻辑。 | **高度机密**。仅安全组及外部审计机构可见，对产研完全隔离。 |
| **`defi-contracts`** | 链上 (On-chain) | 区块链底层组 | 核心智能合约：24h 管理员时间锁 (Timelock)、配套代理合约等。 | **极高安全**。变更需通过链上多签及审计。 |
| **`defi-infra`** | 基建 | 架构与 SRE 组 | `docker-compose.yml`、Prometheus/Grafana 监控配置与混沌测试脚本。 | **运维限制**。掌控测试/生产环境网络编排。 |

---

## 3. 标准目录结构树 (Standard Directory Tree)

以下为 6 大仓库的标准代码结构约束，各组在初始化项目时须严格遵守：

```text
📦 组织级工作区 (DeFi-Organization)
 ┣ 📂 defi-proto                    <-- [仓库 1：全局契约] 
 ┃ ┣ 📜 common.proto                # 基础类型 (金额、Context、状态枚举)
 ┃ ┣ 📜 trading.proto               # 交易执行服务 RPC
 ┃ ┣ 📜 data_stream.proto           # 链上事件订阅流
 ┃ ┗ 📂 gen/                        # 自动生成的桩代码 (go/ 与 python/)
 ┃
 ┣ 📂 defi-zone-a-intelligence      <-- [仓库 2：策略计算区] (Python)
 ┃ ┣ 📂 sdk/
 ┃ ┃ ┗ 📜 base_agent.py             # Python Agent 基类 (封装水位线与gRPC)
 ┃ ┣ 📂 strategies/                 # 具体的量化与 AI 交易策略代码
 ┃ ┣ 📂 evaluator/                  # 25项评估指标计算库 (G5/G6 门控使用)
 ┃ ┣ 📂 ai_feedback/                # 【新增】AI 反馈飞轮服务 (处理 PnL 生成 Prompt)
 ┃ ┣ 📂 web_portal/                 # Admin Web Portal 前端项目 (大额审批/断路器入口)
 ┃ ┗ 📂 tests/fixtures/             # G1静态分析测试用例
 ┃
 ┣ 📂 defi-zone-b-core              <-- [仓库 3：核心执行区] (Go)
 ┃ ┣ 📂 cmd/
 ┃ ┃ ┣ 📂 execution_engine/         # 主程序：Go-Execution-Engine
 ┃ ┃ ┣ 📂 chain_adapter/            # 实时链上事件 WebSocket 摄取
 ┃ ┃ ┣ 📂 data_processor/           # 水位线注入与语义解析
 ┃ ┃ ┣ 📂 mev_router/               # 防夹与路由决策
 ┃ ┃ ┗ 📂 archiver/                 # 【新增】Redis 热数据转 Parquet 归档服务
 ┃ ┣ 📂 pkg/
 ┃ ┃ ┣ 📂 fsm/                      # 幂等状态机 (INIT -> SIGNED)
 ┃ ┃ ┣ 📂 middleware/               # Sync Sentinel 水位线硬拦截
 ┃ ┃ ┣ 📂 oracle/                   # Triple-Oracle Guard 三源预言机
 ┃ ┃ ┣ 📂 ledger/                   # 双分录会计引擎与对账
 ┃ ┃ ┣ 📂 simulator/                # 两档 EVM 仿真器内核
 ┃ ┃ ┗ 📂 recovery/                 # 15秒自愈管理器
 ┃ ┗ 📂 migrations/                 # PostgreSQL 数据库 DDL (trade_tasks等)
 ┃
 ┣ 📂 defi-zone-c-fortress          <-- [仓库 4：极高安全区] (Go/Rust)
 ┃ ┣ 📂 cmd/
 ┃ ┃ ┣ 📂 mpc_signer/               # MPC 密钥分片签名节点主程序
 ┃ ┃ ┗ 📂 whitelist_proxy/          # 白名单及函数选择器硬拦截代理
 ┃ ┣ 📂 pkg/validator/              # 明文 Payload 本地重哈希 (Keccak256) 校验逻辑
 ┃ ┗ 📜 Dockerfile.hsm              # HSM 物理机精简运行环境
 ┃
 ┣ 📂 defi-contracts                <-- [仓库 5：链上智能合约] (Solidity/Foundry)
 ┃ ┣ 📂 src/                        # 智能合约源码 (Admin Timelock, 协议适配器层)
 ┃ ┣ 📂 test/                       # Foundry 单元测试与模糊测试 (Fuzzing)
 ┃ ┗ 📂 script/                     # 部署与升级脚本
 ┃
 ┗ 📂 defi-infra                    <-- [仓库 6：运维与基建区] (YAML/Shell)
   ┣ 📂 deployments/                # 三区网络隔离的 docker-compose 及 K8s manifests
   ┣ 📂 observability/              # Prometheus, Grafana, Loki 监控与告警规则
   ┗ 📂 scripts/                    # chaos_test.sh (混沌测试), cert_rotate.sh (mTLS轮换) 等


```

---

## 4. 依赖集成与高频开发流 (Integration & Workflow)

### 4.1 契约同步：从 Git Submodule 到 私有包注册中心

Zone A 与 Zone B 的通信严格依赖 `defi-proto` 仓库中的定义。

* **Phase 1 (起步期)**：使用 **Git Submodule** 引入。当 `defi-proto` 合并 PR 时，通过 GitHub Actions Webhook 自动向业务仓库提交更新 Submodule 游标的 PR。
* **Phase 2 (成熟期)**：通过 CI/CD 将桩代码构建为私有包。当 `defi-proto` 发布新 Tag 时，CI 自动将 Go 代码发布至私有 **Go Proxy / Github Packages**，将 Python 代码发布至私有 **PyPI**。业务研发只需执行 `pip install defi-proto` 或 `go get` 即可，实现极致解耦。

### 4.2 策略并发开发最佳实践：Git Worktree

在 `defi-zone-a-intelligence` 的日常开发中，策略研究员经常需要同时运行和对比多个策略分支的回测表现（G5/G6 门控）。

* **规范建议**：强烈建议 AI 团队使用 `git worktree` 管理并发开发，而非传统的 `git checkout`。
* **优势**：通过 `git worktree add ../strategy-b-test feature/strategy-b`，可以在同一套庞大的本地 Parquet 历史数据集和 Python 虚拟环境旁，挂载出多个独立的工作目录。这使得研究员能同时在终端 A 跑策略一的回测，在终端 B 开发策略二，彻底免去频繁切换分支导致的缓存失效和环境重载烦恼。

---

## 5. 自动化拦截与防扯皮红线 (CI/CD & Security Redlines)

系统将架构规范中的“红线”固化为各仓库的自动化 CI 检查或 Merge 门控：

1. **G1 静态安全阻断 (`defi-zone-a`)**：
策略 PR 提交时，CI 强制执行 `sdk.validate.static_check()`。若在策略代码中扫描到 `direct RPC call` (越过 DataAPI) 或使用了 `float` 金融计算（未按契约使用 `string`），CI 自动标红并阻断合并。
2. **Schema 冻结与跨组审批 (`defi-zone-b`)**：
任何对 `migrations/` 目录下 PostgreSQL DDL 的修改，通过 GitHub `CODEOWNERS` 机制，强制要求必须同时获得 **区块链底层组** 与 **财务风控组** 的 Tech Lead Approve 才能合并。
3. **明文哈希终极校验 (`defi-zone-c`)**：
Zone C 仓库的代码审计重点红线：**绝不允许**存在直接信任和签名外部传入 Hash 值的逻辑。Zone C 接收明文 Payload 后，必须在本地重新执行 `Keccak256` 运算，比对无误后再行 MPC 签名。
4. **智能合约覆盖率门槛 (`defi-contracts`)**：
提交的 PR 必须通过 Foundry 运行的单元测试，且核心逻辑（特别是时间锁及权限分配逻辑）的测试覆盖率必须达到 100%。必须通过 Slither 的静态漏洞扫描，且禁止包含 `High/Critical` 级别警告。
5. **环境凭证物理隔离 (`defi-infra` & All)**：
所有仓库强制启用 `.gitignore` 屏蔽 `.env.local`。若在任何非部署专用分支中检测到疑似主网 RPC API Key、私钥或 Zone C 凭证，安全扫描工具 (如 TruffleHog) 将即刻阻断提交流程并触发 P0 级告警。