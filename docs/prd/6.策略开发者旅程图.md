# DeFi 自动化交易基础设施

> **策略开发者旅程图**
> *Strategy Developer Journey Map*
> PRD 附属文档 · 版本 1.0 · 2026

---

## 一、文档目的

本文档以开发者视角描述策略从零到生产上线的完整旅程，对应 SDK 在每个阶段需要提供的核心能力。旅程共分为五个阶段，与《策略生命周期定义说明文档》中的状态机一一对应。

---

## 二、旅程全景图

```
[环境准备] ──→ [策略建模] ──→ [本地验证] ──→ [多情景评估] ──→ [影子模式] ──→ [Live]
    │               │               │                │               │
  env.check()   BaseStrategy    validate()        evaluate()     deploy(shadow)
  本地分叉初始化  Adapter 调用    Fuzzing / 回测   蒙卡 / 压力测试  FSM 真实运行
                 invariants 声明  验证报告          评估报告         不发单
                                     │
                             未通过 → 返回阶段一
```

---

## 三、各阶段详细说明

### 3.1 阶段零：环境准备（Onboarding）

开发者拿到 SDK 后的第一件事，是把本地环境和链上环境连通。这一阶段的体验决定了开发者的第一印象。

**流程：**

```
安装 SDK → 配置密钥/RPC → 初始化本地 Anvil 分叉环境 → 连通 MPC 签名机（测试模式）→ 环境自检通过
```

**SDK 需要提供的能力：**
- `sdk.env.check()`：一键检测所有依赖是否就绪（RPC 延迟、预言机连通性、签名机状态）
- 本地分叉环境的快速启动封装（不需要开发者手动配置 Anvil 参数）

**核心痛点：** 开发者最怕的是"不知道哪里配错了"，环境自检的报错信息必须精确到具体原因。

---

### 3.2 阶段一：策略建模（Strategy Authoring）

开发者用第三方工具（Cursor、Jupyter、自己的框架等）编写策略逻辑，SDK 在这里扮演的角色是**提供标准接口契约**，让策略代码不需要关心底层细节。

**流程：**

```
引入 SDK 类型定义 → 实现标准策略接口 → 调用协议适配器（Adapter Registry）→ 定义风控参数 → 策略代码完成
```

**SDK 需要提供的能力：**

策略接口的核心契约：

```python
class Strategy(SDK.BaseStrategy):
    def on_tick(self, market: MarketContext) -> Action | None:
        # market 已经封装了三源价格、水位线校验、账面余额
        # 开发者只需要写"我要做什么"，不需要关心"数据从哪来"
        pass

    def invariants(self) -> list[Invariant]:
        # 声明这个策略的物理底线
        return [MaxDrawdown(pct=0.01), MaxSlippage(pct=0.005)]
```

**关键设计原则：** 开发者写的策略代码，不应该出现任何 RPC 调用、签名逻辑、Gas 估算。这些全部由 SDK 在运行时注入。

---

### 3.3 阶段二：本地验证（Local Validation）

策略写完后，进入验证流水线。对应《验证门控标准说明文档》中的 G1–G4 关卡。

**流程：**

```
静态分析（类型 / 风控参数完整性检查）
    ↓
单元仿真（EVM 数学库精度验证，确保链下计算与链上对齐）
    ↓
场景回测（指定历史区块范围，重放真实链上数据）
    ↓
不变性断言（自动注入策略声明的 invariants，验证是否破线）
    ↓
Fuzzing（极端参数注入：Gas 飙升、流动性枯竭、预言机偏差）
    ↓
本地验证报告生成（结构化 JSON + 可读摘要）
```

**SDK 需要提供的能力：**
- `sdk.validate(strategy)`：作为统一入口，内部按顺序执行上述流水线
- 每个环节独立可跳过（开发中可以只跑回测，跳过 Fuzzing）
- 验证报告必须包含：通过/失败的明确结论、失败原因的具体上下文（哪个区块、哪个参数触发）

---

### 3.4 阶段三：多情景评估（Evaluation）

本地验证关注的是"策略会不会出错"，评估关注的是"策略赚不赚钱、稳不稳定"。对应《验证门控标准说明文档》中的 G5–G6 关卡，评分口径以《评估指标体系说明文档》为准。

**流程：**

```
回测绩效分析（Sharpe、最大回撤、Gas 成本、资金利用率）
    ↓
蒙特卡洛模拟（随机化市场参数，生成收益分布置信区间）
    ↓
链上压力测试（在 Anvil 分叉上模拟 MEV 夹击、极端波动）
    ↓
与基准策略对比（可选，对比被动持仓或其他已上线策略）
    ↓
评估报告生成
```

**开发者在这个阶段需要做的决策：** 根据评估报告，判断策略是否达到自己的上线标准。SDK 提供数据，不替开发者做决策。

---

### 3.5 阶段四：影子模式上线（Shadow → Live）

通过评估后，策略进入影子模式，在真实市场环境中运行逻辑，但不实际发单。对应《验证门控标准说明文档》中的 G7–G8 关卡。

**流程：**

```
部署到影子模式（真实数据驱动，FSM 完整运行，只是最后一步不广播）
    ↓
实盘数据对比（影子模式下的"假设收益" vs 实际市场变化）
    ↓
水位线 / 预言机 / 治理哨兵的真实触发记录收集
    ↓
开发者人工确认 → 触发上线审批（超 $10,000 单笔走多签队列）
    ↓
策略状态变更为 Live，MPC 签名机开始真实执行
```

---

## 四、文档版本记录

| **版本** | **日期** | **变更内容** | **作者** |
|----------|----------|--------------|----------|
| v1.0 | 2026-02-25 | 初始版本，定义五阶段开发者旅程 | DeFi 策略团队 |
