# DeFi 基础设施极致并行开发计划（修订版 v2.0）

这是一个**"接口先行，契约驱动"**的敏捷开发思路。为了应对极高并发和黑暗森林中的外部风险，v2.0 强化了各组的"防爆与降级"责任矩阵，确保在外部 API 宕机、节点静默或证书过期时，系统能够安全降级而非崩溃。

---

## 第一部分：团队建制与模块责任矩阵

系统研发由 **6 个跨职能小队（Squads）** 和 **1 个外部协作方**组成。

### 1. 系统架构与 SRE 组 (Architecture, SRE & Chaos)
* **核心职责**：
  - 统筹全局 Protobuf 契约、数据库 Schema 与可观测性基建（Prometheus 全栈）。
  - **证书与灾备管理（v2.0）**：负责内部 CA 与 mTLS 证书生命周期管理（Phase 2 交付自动轮换脚本，防止系统静默瘫痪）；制定 RTO/RPO 灾难恢复预案。
  - **自愈验证与 NFR 验收**：执行常态化混沌工程，验证 FSM 的 15 秒自愈接管能力；主导端到端两档延迟与可用性 SLA 压测。

### 2. AI 与量化策略组 (Zone A: Intelligence Squad)
* **核心职责**：
  - 研发并维护高频策略与 25 项评估指标计算库；跑通 G5/G6 评估。
  - **Admin Web Portal 开发**：负责交付 Zone A 审批队列管理前端与策略总览面板。
  - **AI 飞轮与 60s SLA 消费**：打通 Vector DB，消费财务组在 60 秒内投递的滑点/毒性流特征，生成大模型优化 Prompt。

### 3. 区块链底层与执行组 (Zone B: Execution Squad)
* **核心职责**：
  - 开发 Go EVM 仿真器（轻量/完整双档），实现位级精度对齐；维护幂等状态机（FSM）与 Nonce 悲观锁。
  - **异常路径与自愈（v2.0）**：实现 PAUSED/DEPRECATED 状态机及退役清算流程；开发 `Recovery Manager`（扫尾孤儿任务的自愈引擎）。
  - **防夹与外部降级兜底（v2.0）**：开发 MEV Router 与治理哨兵；**负责执行降级预案 C（Flashbots 宕机）与降级预案 B/D（治理 API 异常）的兜底处理**。

### 4. 数据工程组 (Data Pipeline Squad)
* **核心职责**：
  - 开发 `Chain-Adapter` 与 `Data-Processor`，为所有事件打上 `last_sync_block` 水位线。
  - **防作弊回测与可复现性**：开发 `Archiver` 归档服务；保障 NFR 要求下的"历史数据可复现性"（数据集哈希机制）。
  - **链重组应对**：确保 WebSocket 不漏推，处理深度 ≤ 3 的链重组（Reorg）事件推送。

### 5. 财务风控与治理组 (Finance & Risk Squad)
* **核心职责**：
  - 维护双分录会计引擎，实现原子记账、账实核查（Reconciler）与 MtM 实时 NAV 估值。
  - **硬熔断与降级预案 A（v2.0）**：执行 `Sync Sentinel` 水位线硬拦截；维护三源预言机，**主导 Chainlink 长时间不更新时的降级预案 A**。
  - **对账第一责任人**：处理所有 `diff != 0` 告警，举证账本无误后才可转交数据组。

### 6. 极高安全组 (Zone C: Security Squad) & 外部审计
* **核心职责**：
  - 维护 Zone C mTLS 白名单代理（拒绝 Hash，强制计算明文 Payload）、24 小时时间锁与全局 Kill Switch。
  - **MPC 密钥分片仪式（v2.0）**：主导 Phase 4 的 HSM 物理机部署与 M-of-N 密钥生成仪式（Key Ceremony），并全程录像存证。
  - **差异化拦截与防伪造（v2.0）**：协同配置 STAGED（绝对额）与 LIVE（相对比）差异化审批引擎；保障 Kill Switch 绿色通道的特权签名防伪造。
  - **引入第三方审计**：在实盘资金注入前对 Zone C 核心代码签核。

---

## 第二部分："策略先行"五阶段开发计划（简述）

* **Phase 0**：分发 Proto 契约，部署数据库与可观测栈，搭建三区网络与 mTLS 证书，交付 Mock 假通道解除并行阻塞。
* **Phase 1**：搭建历史归档与防作弊 `IDataProvider`，交付 25 项指标库、G1 静态分析与 Adapter Registry，跑通预评估。
* **Phase 2**：开发两档 EVM 仿真器与双分录记账引擎，通过 G2-G4，产出 G5/G6 官方报告。交付 Admin Portal 与证书轮换脚本。
* **Phase 3**：接入真实 RPC，激活水位线与预言机双熔断（测试降级预案 A/B）。上线影子对账、PAUSED 异常状态机、Recovery Manager，通过混沌测试与 NFR 专项验收。
* **Phase 4**：执行 MPC 密钥仪式，上线 Zone C 真实签名与差异化大额审批。部署时间锁与防夹路由（测试降级预案 C/D），闭合 AI 飞轮，外部审计通过后进入 LIVE 阶段。

---

## 第三部分：跨团队协作的 8 条"防扯皮"契约红线

在执行上述计划时，管理层必须严格捍卫以下规则：

1. **门控顺序不可颠倒**：G5/G6 的"预评估"结果不得用于上线申请。只有 G1-G4 全部通过后的正式评估报告，才是策略进入 VALIDATED 状态的凭据。
2. **对账事故的工单流转**：任何对账告警（`diff != 0`），工单第一处理人绝对是**财务风控组**。财务组必须先提供证据证明"双分录借贷逻辑"无误，才能将工单转给数据组排查。
3. **API 修改的"一票否决"**：`trading.proto` 是跨栈协作根本。私自新增字段或将 Wei 金额改为 `float` 传输的尝试，架构组拥有一票否决权。
4. **Zone C 的"不信任"原则**：Zone C 必须假设 Zone B 可能被攻陷，强制接收明文 Payload 并在独立内网重新计算 Hash，绝不接受直接传来的 Hash 值。
5. **Adapter Registry 是唯一合法数据源**：Zone C Proxy 白名单必须从 Registry 动态读取，内部硬编码合约地址视为严重安全违规。生产环境的 Registry 修改须走 24h 时间锁。
6. **Admin Web Portal 不持有签名权限**：Zone A 的 Portal 所有操作均须通过 Zone B API 中转。任何试图在前端直接发起链上签名的设计，安全组拥有一票否决权。
7. **外部依赖静默熔断零容忍（新增）**：任何外部 API（Chainlink、Flashbots、Snapshot/Tally）不可用时，禁止系统静默挂起或简单报错。必须精确触发对应的 Level 1/2 降级预案（预案 A-D）并告警。
8. **安全机制不可绕过（新增）**：禁止以"测试方便"为由在生产环境跳过 MPC Key Ceremony（必须录像存证）；所有跨 Zone mTLS 证书必须在到期前 30 天由脚本自动轮换，禁止手动换证引发瘫痪。